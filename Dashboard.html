<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | Voltmailer</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <!-- <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}"> -->
    <link rel='stylesheet' href='https://cdn-uicons.flaticon.com/2.3.0/uicons-bold-straight/css/uicons-bold-straight.css'>
    <link rel='stylesheet' href='https://cdn-uicons.flaticon.com/2.3.0/uicons-solid-straight/css/uicons-solid-straight.css'>
    <link rel='stylesheet' href='https://cdn-uicons.flaticon.com/2.3.0/uicons-bold-straight/css/uicons-bold-straight.css'>
    <link rel='stylesheet' href='https://cdn-uicons.flaticon.com/2.3.0/uicons-regular-rounded/css/uicons-regular-rounded.css'>
    <link rel='stylesheet' href='https://cdn-uicons.flaticon.com/2.3.0/uicons-bold-rounded/css/uicons-bold-rounded.css'>
    <link rel='stylesheet' href='https://cdn-uicons.flaticon.com/2.3.0/uicons-regular-rounded/css/uicons-regular-rounded.css'>
    <link rel='stylesheet' href='https://cdn-uicons.flaticon.com/2.4.0/uicons-regular-straight/css/uicons-regular-straight.css'>
    <link rel='stylesheet' href='https://cdn-uicons.flaticon.com/2.3.0/uicons-regular-rounded/css/uicons-regular-rounded.css'>
    <link rel='stylesheet' href='https://cdn-uicons.flaticon.com/2.4.2/uicons-regular-straight/css/uicons-regular-straight.css'>
    <link rel='stylesheet' href='https://cdn-uicons.flaticon.com/2.4.2/uicons-regular-straight/css/uicons-regular-straight.css'>
    <link rel='stylesheet' href='https://cdn-uicons.flaticon.com/2.4.2/uicons-bold-rounded/css/uicons-bold-rounded.css'>
    <link rel='stylesheet' href='https://cdn-uicons.flaticon.com/2.5.1/uicons-thin-straight/css/uicons-thin-straight.css'>
    <link rel='stylesheet' href='https://cdn-uicons.flaticon.com/2.5.1/uicons-thin-straight/css/uicons-thin-straight.css'>
    <link rel='stylesheet' href='https://cdn-uicons.flaticon.com/2.5.1/uicons-thin-rounded/css/uicons-thin-rounded.css'>
    <link rel='stylesheet' href='https://cdn-uicons.flaticon.com/2.5.1/uicons-thin-rounded/css/uicons-thin-rounded.css'>
    <link rel='stylesheet' href='https://cdn-uicons.flaticon.com/2.5.1/uicons-thin-rounded/css/uicons-thin-rounded.css'>
    <link rel='stylesheet' href='https://cdn-uicons.flaticon.com/2.5.1/uicons-regular-rounded/css/uicons-regular-rounded.css'>
    <link rel='stylesheet' href='https://cdn-uicons.flaticon.com/2.6.0/uicons-thin-rounded/css/uicons-thin-rounded.css'>
    <link rel='stylesheet' href='https://cdn-uicons.flaticon.com/2.6.0/uicons-thin-rounded/css/uicons-thin-rounded.css'>
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script> 
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">  
    <script src="https://cdn.jsdelivr.net/npm/progressbar.js"></script>
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"> 
<style>
        /* color: #8320aa;
        color: #880088; */
    .tab-content {
        display: none;
    }
    .tab-content.active {
        display: block;
    }
    .tab.active {
        background-color: #8320aa;
        color: white;
    }
    .notification {
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 1rem;
        background-color: #880088;
        color: white;
        border-radius: 0.5rem;
        display: none;
        animation: fadeInOut 3s ease-in-out;
        z-index: 1000;
    }
    @keyframes fadeInOut {
        0% { opacity: 0; }
        10% { opacity: 1; }
        90% { opacity: 1; }
        100% { opacity: 0; }
    }
    .switch {
        position: relative;
        display: inline-block;
        width: 60px;
        height: 34px;
    }
    .switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }
    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: .4s;
        border-radius: 34px;
    }
    .slider:before {
        position: absolute;
        content: "";
        height: 26px;
        width: 26px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
    }
    input:checked + .slider {
        background-color: #880088;
    }
    input:checked + .slider:before {
        transform: translateX(26px);
    }
    .notification {
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 1rem;
        border-radius: 0.5rem;
        display: none;
        animation: fadeInOut 3s ease-in-out;
    }
    @keyframes fadeInOut {
        0% { opacity: 0; }
        10% { opacity: 1; }
        90% { opacity: 1; }
        100% { opacity: 0; }
    }
    /* .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
    }
    .modal.active {
        display: flex;
        align-items: center;
        justify-content: center;
    } */

    .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 0.5rem;
            padding: 1.5rem;
            width: 100%;
            max-width: 500px;
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .close-button {
            background: none;
            border: none;
            color: var(--gray-600);
            cursor: pointer;
            padding: 0.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--gray-700);
        }

        .form-input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--gray-300);
            border-radius: 0.375rem;
            transition: all 0.2s;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
            background-color: white;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.3);
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            margin-top: 1.5rem;
        }

        .button-secondary {
            background-color: var(--gray-100);
            color: var(--gray-700);
        }

        .button-secondary:hover {
            background-color: var(--gray-200);
        }
    .mailbox-card {
        transition: all 0.3s ease;
    }
    .mailbox-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .badge {
        display: inline-flex;
        align-items: center;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.875rem;
        font-weight: 500;
    }
    .badge-pending {
        background-color: #FEF3C7;
        color: #92400E;
    }
    .badge-verified {
        background-color: #D1FAE5;
        color: #065F46;
    }
    .badge-active {
        background-color: #EEF2FF;
        color: #880088;
    }

/* Dropdown Container */
.dropdown {
    position: relative;
    display: inline-block;
    font-family: 'Arial', sans-serif;
}

/* Dropdown Button */
.dropbtn {
    background-color: #8320aa; /* Green to match your button */
    color: white;
    padding: 10px 15px;
    font-size: 14px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 5px; /* Space between text and arrow */
}

/* Caret Icon Styling */
.dropbtn i {
    font-size: 12px;
    margin-left: 5px;
}

/* Hover Effect */
.dropbtn:hover {
    background-color: #880088;
}

/* Dropdown Content Styling */
.dropdown-content {
    display: none;
    position: absolute;
    background-color: white;
    min-width: 200px;
    box-shadow: 0px 8px 16px rgba(0, 0, 0, 0.2);
    z-index: 1;
    border-radius: 5px;
    overflow: hidden;
    margin-top: 5px; /* Space between button and menu */
}

/* Links within Dropdown */
.dropdown-content a {
    color: #333;
    padding: 10px 15px;
    text-decoration: none;
    display: block;
    font-size: 14px;
    transition: background-color 0.3s, color 0.3s;
}

/* Hover on Links */
.dropdown-content a:hover {
    background-color: #f1f1f1;
    color: #000;
}

/* Show Dropdown Content on Hover */
.dropdown:hover .dropdown-content {
    display: block;
}

/* Align with Surrounding UI */
.topbar {
    display: flex;
    justify-content: flex-start; /* Align with other elements */
    gap: 10px;
    padding: 10px;
    background-color: #f4f4f400; /* Match the top bar's background */
}

/* MODAL SINGLE */

.modal-overlay-s {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-s {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 500px;
            padding: 30px;
            animation: slide-up 0.3s ease-out;
        }

        @keyframes slide-up {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header-s {
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
        }

        .modal-header-s h2 {
            color: #333;
            font-size: 1.5rem;
        }

        .modal-body-s {
            margin-bottom: 20px;
        }

        .form-group-s {
            margin-bottom: 15px;
        }

        .form-group-s label {
            display: block;
            margin-bottom: 8px;
            color: #333;
        }

        .form-control-s {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
        }

        .btn-s {
            display: inline-block;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .btn-primary-s {
            background-color: #6A5ACD;
            color: white;
        }

        .btn-primary-s:hover {
            background-color: #9370DB;
        }

        .btn-secondary-s {
            background-color: #f1f1f1;
            color: #333;
            margin-right: 10px;
        }

        .btn-secondary-s:hover {
            background-color: #e1e1e1;
        }

        .modal-footer-s {
            display: flex;
            justify-content: flex-end;
        }

        .btn-s:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

/* MULTIPLE MODAL STYLES */

.modal-overlay-m {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal-overlay-m.show {
            display: flex;
            opacity: 1;
        }

        .modal-m {
            background: white;
            border-radius: 16px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 800px;
            padding: 30px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }

        .modal-header-m {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #E0E0E0;
            padding-bottom: 15px;
        }

        .modal-header-m h2 {
            color: #333;
            font-size: 1.8rem;
            font-weight: 600;
        }

        .total-emails-indicator-m {
            background-color: #5B34A5;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
        }

        .email-distribution-container-m {
            max-height: 500px;
            overflow-y: auto;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
            padding-right: 10px;
        }

        .mailbox-distribution-m {
            display: flex;
            flex-direction: column;
            background-color: #F9F9FC;
            border: 1px solid #E0E0E0;
            border-radius: 10px;
            padding: 15px;
            transition: all 0.3s ease;
            position: relative;
        }

        .mailbox-distribution-m:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            border-color: #5B34A5;
        }

        .mailbox-header-m {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .mailbox-remove-m {
            color: red;
            cursor: pointer;
            font-weight: bold;
            opacity: 0.6;
            transition: opacity 0.3s ease;
        }

        .mailbox-remove-m:hover {
            opacity: 1;
        }

        .mailbox-info-m .name-m {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .mailbox-info-m .email-m {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 10px;
            word-break: break-all;
        }

        .email-input-m {
            width: 100%;
            padding: 8px;
            border: 1px solid #E0E0E0;
            border-radius: 6px;
            text-align: center;
            margin-top: 10px;
        }

        .btn-m {
            display: inline-block;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary-m {
            background-color: #5B34A5;
            color: white;
        }

        .btn-primary-m:hover {
            background-color: #9370DB;
        }

        .btn-secondary-m {
            background-color: #F1F1F1;
            color: #333;
            margin-right: 10px;
        }

        .btn-add-mailbox-m {
            background-color: #E0E0E0;
            color: #333;
            margin-top: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-m:disabled {
            background-color: #CCC;
            cursor: not-allowed;
        }

        .modal-footer-m {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 2px solid #E0E0E0;
            padding-top: 20px;
        }

        .mailbox-limit-input-m {
            width: 100%;
            padding: 8px;
            border: 1px solid #E0E0E0;
            border-radius: 6px;
            margin-top: 10px;
        }

        @media (max-width: 600px) {
            .email-distribution-container-m {
                grid-template-columns: 1fr;
            }
        }

</style>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
  // Configuration for OAuth
  let sampleEmails = []
  const GOOGLE_OAUTH_CONFIG = {
    clientId: '691667454079-6joalt2dv172u8f4o0qecb6b6acbmls5.apps.googleusercontent.com',
    clientSecret: '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', // Add your client secret here
    redirectUri: 'https://www.voltmailer.com/Dashboard.html',
    scopes: ['https://www.googleapis.com/auth/userinfo.email', 'https://www.googleapis.com/auth/gmail.send']
  };
    // Sample data - replace with your actual data
    let mailboxes = [
        // { id: 1, email: 'work@example.com', status: 'verified', isActive: true },
        // { id: 2, email: 'personal@example.com', status: 'verified', isActive: false },
        // { id: 3, email: 'new@example.com', status: 'pending', isActive: false }
    ];
    let submittedData = [];
let generatedData = [];
let MAILBOXES = [];
let U_Username;
let U_MyEmail;
let allemailsmade = false;




window.onload = function() {
            if (window.innerWidth <= 768) {
                window.location.href = "https://voltmailer.com/mobile.html";
            }

            
        };

    const fetchMailboxes = async () => {
    try {
        console.log("fetching meailboxes")
        const response = await fetch(`https://server.voltmailer.com/api/mailboxes?email=${U_MyEmail}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            }
        });

        const mailboxesFromBackend = await response.json();
        if (response.ok) {
            console.log("found them", mailboxesFromBackend)
            mailboxes = mailboxesFromBackend.map(mailbox => ({
                id: mailbox._id,           // Use MongoDB's unique ID
                email: mailbox.smtp.user, // Extract email from SMTP details
                status: 'verified',       // Set status; backend doesn't verify in current implementation
                isActive: mailbox.isActive          // Update with the backend's active state if implemented
            }));
            updateUI();
        } else {
            throw new Error(mailboxesFromBackend.message || 'Failed to fetch mailboxes');
        }
    } catch (error) {
        console.error('Error fetching mailboxes:', error);
        sNotification('Error fetching mailboxes: ' + error.message, 'error');
    }
};



    // UI State Management
    async function updateUI(){
        const emptyState = document.getElementById('emptyState');
        const mailboxList = document.getElementById('mailboxList');
        const mailboxCards = document.getElementById('mailboxCards');
        let button = document.getElementById('submit')
        HasActive = await fetchActiveMailbox(U_MyEmail)
        if (mailboxes.length === 0) {
            emptyState.classList.remove('hidden');
            mailboxList.classList.add('hidden');

            console.warn('No active mailboxes available for this user.');
        document.getElementById('maintop').innerHTML=`
                    <div class="plan">${CapsPlan} plan Subscriber</div>
            <div class="google" id="googleauthid">
<div onclick="OpenMailboxes()" style="cursor: pointer; text-decoration: underline;"> Please Add A MailBox</div> 
            </div>
        `;
        button.innerHTML=`
                    
                    <button class="button" onclick="OpenMailboxes()">
                        <img  src='google.png' alt="google" style="height= 30px; width: 30px;">
                        Add a Mailbox
                      </button>



                      
                      `

        } else {
            emptyState.classList.add('hidden');
            mailboxList.classList.remove('hidden');
            
            // Clear and rebuild mailbox cards
            mailboxCards.innerHTML = '';
            mailboxes.forEach(mailbox => {
                const card = createMailboxCard(mailbox);
                mailboxCards.appendChild(card);
            });

            console.log('Initialized MAILBOXES:', HasActive);
        // Use MAILBOXES for your dropdown or UI logic
        
        document.getElementById('googleauthid').innerHTML=`
            <div class="topbar">
                <div class="dropdown">
                    <button class="dropbtn">
                        Your Active Mailboxes 
                        <i class="fa fa-caret-down"></i>
                    </button>
                    <div class="dropdown-content">
                        <!-- Dynamic mailbox list -->
                        ${HasActive.map(mailbox => `<a href="#">${mailbox}</a>`).join('')}
                    </div>
                </div>
            </div>
        

`;
            button.innerHTML=`
                    
                    <button class="button" onclick="Submitandcheckautosend()">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 36 24">
                          <path d="m18 0 8 12 10-8-4 20H4L0 4l10 8 8-12z"></path>
                        </svg>
                        Generate
                      </button>

                      `

    
    
        }


    };

    // Create Mailbox Card
    const createMailboxCard = (mailbox) => {
        const div = document.createElement('div');
        div.className = 'mailbox-card bg-white rounded-lg shadow-sm p-6 relative';
        
        const statusClass = mailbox.status === 'pending' ? 'badge-pending' : 'badge-verified';
        const statusText = mailbox.status === 'pending' ? 'Pending Verification' : 'Verified';
        
        div.innerHTML = `
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h4 class="font-medium text-gray-900">${mailbox.email}</h4>
                    <div class="flex gap-2 mt-2">
                        <span class="badge ${statusClass}">${statusText}</span>
                        ${mailbox.isActive ? '<span class="badge badge-active">Active</span>' : ''}
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    ${mailbox.status === 'verified' && !mailbox.isActive ? `
                        <button onclick="setActiveMailbox('${mailbox.email}')" 
                            class="text-indigo-600 hover:text-indigo-700 font-medium text-sm">
                            Set as Active
                        </button>
                    ` : ''}
                    ${mailbox.status === 'verified' && mailbox.isActive ? `
                        <button onclick="setinActiveMailbox('${mailbox.email}')" 
                            class="text-red-600 hover:text-indigo-700 font-medium text-sm">
                            Set as inactive
                        </button>
                    ` : ''}
                    <button onclick="removeMailbox('${mailbox.id}','${mailbox.email} ')" 
                        class="text-gray-400 hover:text-gray-600">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                        </svg>
                    </button>
                </div>
            </div>
        `;
        
        return div;
    };

    // Modal Management
    const showAddMailboxModal = () => {
        document.getElementById('addMailboxModal').classList.add('active');
    };

    const hideAddMailboxModal = () => {
        document.getElementById('addMailboxModal').classList.remove('active');
        document.getElementById('addMailboxForm').reset();
    };

    // Notification Management
    const sNotification = (message, type = 'success') => {
        const notification = document.getElementById('notification');
        notification.textContent = message;
        notification.style.display = 'block';
        notification.className = 'notification ' + 
            (type === 'success' ? 'bg-green-500' : 'bg-yellow-500') + 
            ' text-white';
        
        setTimeout(() => {
            notification.style.display = 'none';
        }, 3000);
    };

    // Mailbox Actions
    // const addMailbox = (email) => {
    //     const newMailbox = {
    //         id: Date.now(),
    //         email,
    //         status: 'pending',
    //         isActive: false
    //     };
    //     mailboxes.push(newMailbox);
    //     updateUI();
    //     sNotification('Verification email sent to ' + email);
    // };

    async function sendEmailGMAIL(to, subject, body, email) {
        try {
          // Refresh token if expired
          await refreshTokenIfNeeded(selectedAccount);

          // Construct raw email message
          const rawMessage = btoa(
            `To: ${to}\r\n` +
            `Subject: ${subject}\r\n` +
            `Content-Type: text/plain; charset="UTF-8"\r\n\r\n` +
            body
          ).replace(/\+/g, '-').replace(/\//g, '_');

          // Send email via Gmail API
          const response = await axios.post(
            `https://gmail.googleapis.com/gmail/v1/users/me/messages/send`,
            { raw: rawMessage },
            {
              headers: {
                'Authorization': `Bearer ${this.selectedAccount.accessToken}`,
                'Content-Type': 'application/json'
              }
            }
          );

          return response.data;
        } catch (error) {
          console.error('Failed to send email:', error);
          throw error;
        }
      }

      // Refresh access token if needed
      async function refreshTokenIfNeeded(account) {
        // Check if token is expired or about to expire
        if (account.expiresAt && Date.now() >= account.expiresAt - 300000) { // 5 minutes buffer
          try {
            const refreshResponse = await axios.post('https://oauth2.googleapis.com/token', {
              client_id: GOOGLE_OAUTH_CONFIG.clientId,
              client_secret: GOOGLE_OAUTH_CONFIG.clientSecret,
              refresh_token: account.refreshToken,
              grant_type: 'refresh_token'
            });

            // Update tokens
            account.accessToken = refreshResponse.data.access_token;
            account.expiresAt = Date.now() + (refreshResponse.data.expires_in * 1000);

            // Update in stored accounts
            const index = this.accounts.findIndex(a => a.id === account.id);
            if (index !== -1) {
              this.accounts[index] = account;
              this.saveAccounts();
            }


          } catch (error) {
            console.error('Token refresh failed:', error);
            throw error;
          }
        }
      }
    
    const addMailbox = async (formData) => {
    try {
        const { email, smtpHost, smtpPort, username, password, gmail } = formData;
        emails = await fetchActiveMailbox(U_MyEmail)
                console.log(emails)
                let unique = true
                emails.forEach(email => {
                    if (email === username){
                        sNotification('Failed to add mailbox : Account already exists');
                        unique = false
                        return;
                    }

                })

                if (unique) {
        // Constructing the SMTP details object from the form values
        const smtpDetails = {
            host: smtpHost,          // From the form input
            port: parseInt(smtpPort), // Convert port to number
            secure: smtpPort === "465", // If port is 465, set secure to true (adjust this based on your actual logic)
            user: username,         // From the form input
            pass: password,
            gmail: gmail         // From the form input
        };
        console.log(U_MyEmail)
        const response = await fetch('https://server.voltmailer.com/api/mailboxes/create', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ email: U_MyEmail, smtp: smtpDetails })
        });

        const result = await response.json();
        if (response.ok) {
            mailboxes.push({
                id: result.mailbox.id,          // Use ID returned from the backend
                email: result.mailbox.smtp.user, // Email is extracted from the SMTP user
                status: 'verified',            // Assume verified; adjust based on backend implementation
                isActive: result.mailbox.isActive // Use the active state from the backend
            });
            updateUI();
            sNotification('Mailbox added successfully!');
        } else {
            
            throw new Error(result.message || 'Failed to add mailbox');
        }
    }else {
            
            throw new Error('Failed to add mailbox : Email already in use');
        }
    } catch (error) {
        console.error('Error adding mailbox:', error);
        sNotification('Error adding mailbox: ' + error.message, 'error');
    }
};


    // const setActiveMailbox = (id) => {
    //     mailboxes = mailboxes.map(mailbox => ({
    //         ...mailbox,
    //         isActive: mailbox.id === id
    //     }));
    //     updateUI();
    //     sNotification('Active mailbox updated');
    // };

    const setActiveMailbox = async (email) => {
    try {
        const response = await fetch('https://server.voltmailer.com/api/mailboxes/switch', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ email: U_MyEmail, mailboxUser: email })
        });

        const result = await response.json();
        if (response.ok) {
            // mailboxes = mailboxes.map(mailbox => ({
            //     ...mailbox,
            //     isActive: mailbox.isActive 
            // }));
            mailboxes = mailboxes.map(mailbox => 
        mailbox.email === email
            ? { ...mailbox, isActive: true }
            : mailbox
    );
            updateUI();
            sNotification('Active mailbox updated successfully!');
        } else {
            throw new Error(result.message || 'Failed to set active mailbox');
        }
    } catch (error) {
        console.error('Error setting active mailbox:', error);
        sNotification('Error setting active mailbox: ' + error.message, 'error');
    }
};

const setinActiveMailbox = async (email) => {
    try {
        const response = await fetch('https://server.voltmailer.com/api/mailboxes/inactive', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ email: U_MyEmail, mailboxUser: email })
        });

        const result = await response.json();
        if (response.ok) {
            // mailboxes = mailboxes.map(mailbox => ({
            //     ...mailbox,
            //     isActive: mailbox.isActive 
            // }));
            mailboxes = mailboxes.map(mailbox => 
        mailbox.email === email
            ? { ...mailbox, isActive: false }
            : mailbox
    );
            updateUI();
            sNotification('Active mailbox updated successfully!');
        } else {
            throw new Error(result.message || 'Failed to set active mailbox');
        }
    } catch (error) {
        console.error('Error setting active mailbox:', error);
        sNotification('Error setting active mailbox: ' + error.message, 'error');
    }
};

    // const removeMailbox = (id) => {
    //     if (confirm('Are you sure you want to remove this mailbox?')) {
    //         mailboxes = mailboxes.filter(mailbox => mailbox.id !== id);
    //         updateUI();
    //         sNotification('Mailbox removed');
    //     }
    // };

   async function removeMailbox(id, email) {
    try {
        if (!confirm('Are you sure you want to remove this mailbox?')) return;

        const mailbox = mailboxes.find(mailbox => mailbox.id === id);
        if (!mailbox) throw new Error('Mailbox not found');


        console.log("email : ", email, "u_UEMAIL : ", U_MyEmail)
        // Backend deletion not implemented in your example, assume a DELETE endpoint exists
        const response = await fetch('https://server.voltmailer.com/api/mailboxes/delete', {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ email: U_MyEmail, mailboxUser: email })
        });

        // const response = await response.json();
        const result = await response.json();

        if (response.ok) {
            mailboxes = mailboxes.filter(mailbox => mailbox.id !== id);
            updateUI();
            sNotification('Mailbox removed successfully!');
        } else {
            throw new Error('Failed to remove mailbox');
        }
    } catch (error) {
        console.error('Error removing mailbox:', error);
        sNotification('Error removing mailbox: ' + error.message, 'error');
    }
};


    // Form Handling


    // Initialize UI
    

    



async function init() {
    console.log("running")
    const urlParams = new URLSearchParams(window.location.search);
    var token  = urlParams.get('token');        
    var affiliate = urlParams.get('affiliate');  
    var connectedGoogle = urlParams.get('connectedgoogletoken');
    
    if (affiliate){
        localStorage.setItem('affiliate', affiliate);
    }

    if(connectedGoogle) {
        connectedgoogleAuth();
    }else {
            if (token) {
                console.log("noraml running")
                fetchUserData(token);
            } else {
                console.log("google running")
                googleAuth();
            }

        }
}
// Call fetchUserData on page load
document.addEventListener("DOMContentLoaded", function() {
    init()
    
    if (localStorage.getItem('connectedGoogle') ==='Rally') {
        const urlParams = new URLSearchParams(window.location.search);
        var googele  = urlParams.get('googletoken');
        window.location.href = `https://voltmailer.com/Rally-Beacon-Dashboard.html?googletoken=${googele}`
    }


    // window.tasks = [
    //     { id: 1, completed: false },
    //     { id: 2, completed: false },
    //     { id: 3, completed: false },
    // ];
    // const totalTasks = tasks.length;
    // initializeProgressBar();
    // updateProgress(tasks, totalTasks);

    // tasks.forEach(task => {
    //     const taskElement = document.querySelector(`.task[data-task-id="${task.id}"] i`);
    //     if (taskElement) {
    //         taskElement.addEventListener('click', () => toggleDetails(taskElement));
    //     }
    // });

});

// let progressBar;

// function initializeProgressBar() {
//     progressBar = new ProgressBar.Circle('#progress-circle', {
//         color: '#aaa',
//         strokeWidth: 8,
//         trailWidth: 8,
//         trailColor: '#eee',
//         easing: 'easeInOut',
//         duration: 1400,
//         text: {
//             autoStyleContainer: false
//         },
//         from: { color: '#ff0000', width: 8 },
//         to: { color: '#00ff00', width: 8 },
//         step: function(state, circle) {
//             circle.path.setAttribute('stroke', state.color);
//             circle.path.setAttribute('stroke-width', state.width);

//             const value = Math.round(circle.value() * 100);
//             if (value === 0) {
//                 circle.setText('');
//             } else {
//                 circle.setText(`${value}%`);
//             }
//         }
//     });

//     progressBar.text.style.fontFamily = '"Raleway", Helvetica, sans-serif';
//     progressBar.text.style.fontSize = '2rem';
// }

// function updateProgress(tasks, totalTasks) {
//     console.log(totalTasks)
//     const completedTasks = tasks.filter(task => task.completed).length;
//     const percentage = (completedTasks / totalTasks) * 100;
// if (percentage != 0) {
//     document.getElementById('progress-percentage').innerHTML = ``;
// }

//     progressBar.animate(percentage / 100); // Number from 0.0 to 1.0

//     tasks.forEach(task => {
//         const icon = document.getElementById(`task-icon-${task.id}`);
//         if (icon) {
//             if (task.completed) {
//                 icon.className = 'fi fi-br-check'; // Update the icon class for completed task
//             } else {
//                 icon.className = 'fi fi-rr-angle-small-down'; // Update the icon class for incomplete task
//             }
//         }
//     });
// }

function toggleDetailsx(icon) {
    const taskElement = icon.parentElement;
    const taskId = taskElement.getAttribute('data-task-id');
    const detailsElement = document.querySelector(`.task-details[data-task-id="${taskId}"]`);
    
    if (detailsElement) {
        if (detailsElement.style.display === 'none' || detailsElement.style.display === '') {
            detailsElement.style.display = 'block';
            // icon.className = 'fi fi-ss-hexagon'; // Update the icon class for details open
        } else {
            detailsElement.style.display = 'none';
            // icon.className = 'fi fi-ss-hexagon'; // Update the icon class for details closed
        }
    }
}

function completeTask(taskId) {
    const task = tasks.find(t => t.id == taskId);
    task.completed = !task.completed;
    const totalTasks = tasks.length;
    updateProgress(tasks, totalTasks);
}

function sendFirstEmail() {
    // Logic to send the first email
    completeTask(1);
}

function createFirstCampaign() {
    // Logic to create the first campaign
    createCampaign()
    completeTask(2);
}

function editUsername() {
    // Logic to edit the username
    completeTask(3);
}





function getEmailTokenFromUrl() {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get('token');
}

function decodeEmailJWT(token) {
    const base64Url = token.split('.')[1];
    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
    return JSON.parse(atob(base64));
}

// function fetchUserData() {
//     const token = getEmailTokenFromUrl();
//     if (token) {
//         const decoded = decodeEmailJWT(token);
//         const email = decoded.email;
//         U_MyEmail = decoded.email;

//         fetch('https://server.voltmailer.com/user-data', {
//             method: 'GET',
//             headers: {
//                 'Authorization': `Bearer ${token}`,
//                 'Content-Type': 'application/json'
//             }
//         })
//         .then(response => response.json())
//         .then(data => {
//             if (data.error) {
//                 console.error('Error fetching user data:', data.error);
//                 window.location.href='https://voltmailer.com/ExpiredSession.html'
//             } else {
//                 // Customize the page using user data
//                 // document.getElementById('userEmail').textContent = data.email;
//                 console.log(data)

//                 const UserEmail = data.email
//                 U_MyEmail = data.email
//                 const UserStripeID = data.email
//                 RenderHtml(data);
//                 // Add more customization based on user data
//             }
//         })
//         .catch(error => {
//             console.error('An error occurred:', error);
//         });
//     } else {
//         console.error('Token not found in URL');
//     }
// }

function fetchUserData(token) {
    console.log("fetching data")
    // const token = getEmailTokenFromUrl();
    if (token) {
        const decoded = decodeEmailJWT(token);
        const email = decoded.email;
        U_MyEmail = decoded.email;

        fetch('https://server.voltmailer.com/user-data', {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            console.log("response : ", response)
            if (response.status === 401) {
                // Unauthorized error, redirect to expired session page
                window.location.href = 'https://voltmailer.com/ExpiredSession.html';
                return null; // Stop further processing
            }
            return response.json();
        })
        .then(data => {
            if (data && data.error) {
                console.error('Error fetching user data:', data.error);
                window.location.href = 'https://voltmailer.com/ExpiredSession.html';
            } else if (data) {
                // Customize the page using user data
                console.log(data);
                const UserEmail = data.email;
                U_MyEmail = data.email;
                const UserStripeID = data.email;
                RenderHtml(data);
                // Add more customization based on user data
            }
        })
        .catch(error => {
            console.error('An error occurred:', error);
        });
    } else {
        console.error('Token not found in URL');
    }
}


function logout(){
    localStorage.clear();
    window.location.href='https://voltmailer.com/'
}
function ConnectGoogle() {
    localStorage.setItem('connectedGoogle', 'False');
    window.location.href = 'https://server.voltmailer.com/auth/google';
}


function parseJWT(token) {
    const base64Url = token.split('.')[1];
    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
    const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
    }).join(''));
    
    return JSON.parse(jsonPayload);
}

// async function GetMetrics(email) {
//     try{
//         const response = await fetch('https://server.voltmailer.com/api/metrics/${email}');
//         const data = await response.json();
//         console.log("recieved data : ", data.bounceRate, " and ", data.replyRate)

//         if (response.ok){
//             document.getElementById('cs').innerHTML = `${data.numberOfCampaigns}`;
//             // document.getElementById('metric-label-br').innerHTML = `${data.bounceRate}`;
//             // document.getElementById('metric-label-rr').innerHTML = `${data.replyRate}`;
//         } else {
//             console.error('ERROR', data.message)
//         }
//     } catch (error) {
//         console.error('Error Fetching Metrics', error)
//     }
// }


async function updateNameForm(name){

console.log("name", U_MyEmail)

// const email = prompt('Please enter your email to update your name:');
const errorMessages = document.getElementById('errorMessagename');

errorMessages.innerHTML = '';

try {
const response = await fetch('https://server.voltmailer.com/update-customer-by-email', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json',
    },
    body: JSON.stringify({
        email: U_MyEmail,
        updateField: 'name',
        newData: name
    }),
});

const data = await response.json();

if (response.ok) {
    errorMessages.innerHTML = `<p>${data.message}</p>`;
    init()
} else {
    errorMessages.innerHTML = `<p>Error: ${data.message}</p>`;
}
} catch (error) {
console.error('Error:', error);
errorMessages.innerHTML = '<p>An error occurred while updating the name.</p>';
}
};

const fetchActiveMailbox = async (email) => {
    try {
        // Make a GET request to the backend API to fetch the active mailbox for the provided email
        const response = await fetch(`https://server.voltmailer.com/api/mailboxes/active?email=${email}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            }
        });

        const result = await response.json(); // Parse the JSON response

        if (response.ok) {

            if (result.length === 0) {
                console.log('No active mailboxes found');
                return []; // Return an empty array if no active mailboxes are found
            }

            console.log('Active mailboxes:', result);
            // Return the array of SMTP user email addresses
            return result;


            // console.log('Active mailboxes fetched:', result);

            // Transform the result into the desired MAILBOXES format
            // const MAILBOXES = result.map((mailbox, index) => ({
            //     id: `mailbox-${index + 1}`, // Generate a unique ID
            //     name: mailbox.name || `Mailbox ${index + 1}`, // Use name or default
            //     email: mailbox.smtp.user, // Use the mailbox email
            // }));

            // return result.map((mailbox, index) => ({
            //     id: `mailbox-${index + 1}`, // Generate a unique ID
            //     name: mailbox.name || `Mailbox ${index + 1}`, // Use name or default
            //     email: mailbox.smtp.user, // Use the mailbox email
            // }));

            // console.log('Formatted MAILBOXES:', MAILBOXES);
            // return MAILBOXES; // Return the formatted MAILBOXES array
        } else {
            console.warn('No active mailboxes found or response format invalid.');
            return []; // Return an empty array if no active mailboxes
        }
    } catch (error) {
        console.error('Error fetching active mailboxes:', error);
        return []; // Return an empty array on error
    }
}

async function initializeMailboxes(email) {
    const MAILBOXES = await fetchActiveMailboxes(email); // Populate MAILBOXES dynamically
    console.log('Initialized MAILBOXES:', MAILBOXES);

    
}

async function RenderHtml(data){
    
    document.getElementById('sending').style.display = 'none';
    const planEmails = data.plan_emails
    
    
    const name = data.name
    U_Username = name
    const email = U_MyEmail
    // GetMetrics(email)
    const UserEmail = data.email
    fetchMailboxes();
    fetchuserEmails();
    HasActive = await fetchActiveMailbox(email)
    // initializeMailboxes(email)

    const plan = data.plan
    const CapsPlan = plan.charAt(0).toUpperCase() + plan.slice(1);
    const UsedEmails = data.total_emails
    const stripeID = data.stripeID
    const token = localStorage.getItem('authToken');
    // const userData = parseJWT(token);
    //     console.log('User Data:', userData);
    //     document.getElementById('maintop').innerHTML=`
    //                 <div class="plan">${CapsPlan} plan Subscriber</div>
    //         <div class="google" id="googleauthid">
    //                 Emails Sent From : ${userData.email}
    //         </div>
    //     `;

    let button = document.getElementById('submit')
    let percentageUsed = (UsedEmails / planEmails) * 100;

    percentageUsed = Math.min(100, percentageUsed); // Ensure it doesn't go over 100%


    // const titleDisplay = document.getElementById("titleDisplay");
    // const titleInput = document.getElementById("titleInput");
    // const editIcon = document.getElementById("TeditIcon");
    // const saveIcon = document.getElementById("TsaveIcon");

    // Initial title (default to "Home" if not set)
    // let pageTitle = name;

    // if (pageTitle != "null"){
    //     titleDisplay.textContent = pageTitle;
    // }
    // else {
    //     titleDisplay.textContent = "Please Enter Your Name";
    // }

    // // Function to update the display
    // function updateDisplay() {
    //     titleDisplay.textContent = pageTitle;
    //     titleDisplay.style.display = "inline";
    //     titleInput.style.display = "none";
    // }

    // // Edit title
    // editIcon.addEventListener("click", () => {
    //     titleInput.value = pageTitle; // Set input to current title
    //     titleDisplay.style.display = "none";
    //     titleInput.style.display = "inline";
    //     titleInput.focus();
        
    //     editIcon.style.display = "none";
    //     saveIcon.style.display = "inline";
    // });

    // // Save title
    // saveIcon.addEventListener("click", () => {
    //     pageTitle = titleInput.value.trim() || "Please Enter Your Name"; // Default to "Home" if empty
    //     updateDisplay();
    //     updateNameForm(titleDisplay.textContent)

    //     saveIcon.style.display = "none";
    //     editIcon.style.display = "inline";
    // });

    // // Handle Enter key to save the title
    // titleInput.addEventListener("keyup", (event) => {
    //     if (event.key === "Enter") {
    //         saveIcon.click();
    //     }
    // });


    
    document.getElementById('h2name').innerHTML=`${name}`;
    // document.getElementById('metric-label-plan').innerHTML = `${plan}`;
    // document.getElementById('metric-label-total').innerHTML = `${UsedEmails}`;
    document.getElementById('plan-usage-detail').innerHTML = `${UsedEmails} of ${planEmails} emails used this month`;
    // document.getElementById('metric-label-br').innerHTML = `${data.bounceRate}`;
    // document.getElementById('metric-label-rr').innerHTML = `${data.totalReplies}`;
    document.getElementById('cs').innerHTML = `${data.campaigns.length}`;
    // document.getElementById('rr').innerHTML = `${data.totalReplies}`;
    // document.getElementById('br').innerHTML = `${data.bounceRate}%`;
    document.getElementById('ed').innerHTML = `${UsedEmails}`;


    // document.getElementById('plan-usage-detail').innerHTML=`You have used : ${UsedEmails} Emails of :  ${planEmails} Emails / mo`;
    document.getElementById('progress-text').innerHTML=`<p>Current: ${UsedEmails}</p><p>Total: ${planEmails}</p>`;
    document.getElementById('subscription').onclick = function() { billing(data.stripeID, data.email) };
    // document.getElementById('3').onclick = function() { billing(data.stripeID, data.email) };
    document.getElementById('billing-man').onclick = function() { billing(data.stripeID, data.email) };
    document.getElementById('progressx').style.width = percentageUsed + '%'; 

    if (plan === "free" || plan === "pro"){
        document.getElementById('DOMAIN').style.display = "none"
    }
    document.getElementById('myAccount-content').innerHTML = `
    
    <div class="dashboard-usage">
            <h1>Your Account</h1>
            <h4>A detailed overview of your metrics, usage, plan and more</h4>
            <h2>Name</h2>
            <h4>This is the name your emails are sent from.</h4>
            <div class="coolinput">
                <!-- <label for="input" class="text">Name:</label> -->
                <input type="text" placeholder="${name}" name="input" class="input" id="name" value="${name}">
            </div>
            <h5 id="errorMessagename"></h5>
            <button class="button-man" onclick="updateNameForm()">Save</button>

            <h2>Email</h2>
            <h4>The Email associated with your account, not necessarily the email used to send your emails.</h4>
            <div class="coolinput">
                <!-- <label for="input" class="text">Email:</label> -->
                <input type="text" placeholder="${UserEmail}" name="input" class="input" id="emailinput" value="${UserEmail}">
                <!-- <input placeholder="Email address" class="input" name="text" type="email" placeholder="CoolGuy1@email.com"/> -->
            </div>     
            <h5 id="errorMessageemail"></h5>         
            <button class="button-man"  onclick="updateEmailForm())" >Save</button>


            <h2 class="password-reset">Reset Password</h2>

            <div class="coolinput">
                <input type="text" placeholder="New Password" name="input" class="input" id="newPassword" >
            </div>

            <div class="coolinput">
                <!-- <label for="input" class="text">Website:</label> -->
                <input type="text" placeholder="Confirm Password" name="input" class="input" id="confirmPassword" >
            </div>
            <h5 id="errorMessage"></h5>
            <button class="button-man" onclick="updatePasswordForm()">Save</button>
          </div>
    ` 
    // document.getElementById('sidemenu').innerHTML=`
    //         <div class="menu-item active" id="1"><i class="fi fi-br-house-blank"></i>Home</div>
    //         <div class="menu-item" id="2"> <i class="fi fi-bs-pulse"></i>Usage</div>
    //         <div class="menu-item" id="3" onclick="billing(data.stripeID)" > <i class="fi fi-rr-credit-card"></i> Billing</div>
    //         <div class="menu-item tools">Tools</div>
    //         <div class="menu-item" id="openPopup"><i class="fi fi-rr-user-pen"></i>Account</div>
    //         <div class="menu-item end" id="5"><i class="fi fi-rr-customer-service"></i>Help</div>
    // `;


        if (UsedEmails >= planEmails) {
                button.innerHTML=`                    
                <button class="button" onClick="billing(${stripeID}, ${email})" >
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 36 24">
                          <path d="m18 0 8 12 10-8-4 20H4L0 4l10 8 8-12z"></path>
                        </svg>
                        Unlock Pro
                </button>`
            }
        else {
            if (HasActive.length === 0) {
        console.warn('No active mailboxes available for this user.');
        document.getElementById('maintop').innerHTML=`
                    <div class="plan">${CapsPlan} plan Subscriber</div>
            <div class="google" id="googleauthid">
<div onclick="OpenMailboxes()" style="cursor: pointer; text-decoration: underline;"> Please Add A MailBox</div> 
            </div>
        `;
        button.innerHTML=`
                    
                    <button class="button" onclick="OpenMailboxes()">
                        <img  src='google.png' alt="google" style="height= 30px; width: 30px;">
                        Add a Mailbox
                      </button>



                      
                      `

    } else {
        // MAILBOXES = HasActive;
        console.log('Initialized MAILBOXES:', HasActive);
        // Use MAILBOXES for your dropdown or UI logic
        document.getElementById('googleauthid').innerHTML=`
            <div class="topbar">
                <div class="dropdown">
                    <button class="dropbtn">
                        Your Active Mailboxes 
                        <i class="fa fa-caret-down"></i>
                    </button>
                    <div class="dropdown-content">
                        <!-- Dynamic mailbox list -->
                        ${HasActive.map(mailbox => `<a href="#">${mailbox}</a>`).join('')}
                    </div>
                </div>
            </div>
        

`;
            button.innerHTML=`
                    
                    <button class="button" onclick="Submitandcheckautosend()">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 36 24">
                          <path d="m18 0 8 12 10-8-4 20H4L0 4l10 8 8-12z"></path>
                        </svg>
                        Generate
                      </button>

                      `

    }

    //         if (MAILBOXES.length === 0){

    //         } else {
 
    //     }
    }




    // showNotification(`Welcome, ${name}`)
}

async function googleAuth() {
    const urlParams = new URLSearchParams(window.location.search);
    const googleToken = urlParams.get('googletoken');
    if (googleToken) {
        const userData = parseJWT(googleToken);
        console.log('User Data:', userData);
        U_MyEmail = userData.email;
        // document.getElementById('user-email').textContent = `GOOGLE ACCOUNT SIGNED IN: ${userData.email}`;
        
        // Store the token in localStorage or use it directly for sending emails
        localStorage.setItem('authToken', googleToken);


        
        fetch('https://server.voltmailer.com/google-user-data', {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${googleToken}`,
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                window.location.replace("https://voltmailer.com");
                console.error('Error fetching user data:', data.error);
                
            } else {
                // Customize the page using user data
                // document.getElementById('userEmail').textContent = data.email;
                console.log(data)

                const UserEmail = data.email
                const UserStripeID = data.email
        //                 document.getElementById('googleauthid').innerHTML=`

        //             Emails Sent From : ${UserEmail}

        // `;
                RenderHtml(data);

                // Add more customization based on user data
            }
        })
        .catch(error => {
            console.error('An error occurred:', error);
        });


        
    }
}


async function connectedgoogleAuth() {
    let button = document.getElementById('submit')
    const urlParams = new URLSearchParams(window.location.search);
    const connectedGoogletoken = urlParams.get('connectedgoogletoken');
    if (connectedGoogletoken) {
        const userData = parseJWT(connectedGoogletoken);
        console.log('User Data:', userData);
        U_MyEmail = userData.email;
        localStorage.setItem('authToken', connectedGoogletoken);
        // document.getElementById('googleauthid').innerHTML=`
        //             Emails Sent From : ${userData.email}
        // `;

        button.innerHTML=`
                    
                    <button class="button" onclick="Submitandcheckautosend()">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 36 24">
                          <path d="m18 0 8 12 10-8-4 20H4L0 4l10 8 8-12z"></path>
                        </svg>
                        Generate
                      </button>`;
    }
}



// document.getElementById('openPopup').addEventListener('click', () => {
//             document.getElementById('popup').classList.remove('hidden');
//         });

        // document.getElementById('closePopup').addEventListener('click', () => {
        //     document.getElementById('popup').classList.add('hidden');
        // });

        // document.getElementById('profileTab').addEventListener('click', () => {
        //     showContent('profileContent');
        // });

        // document.getElementById('workspacesTab').addEventListener('click', () => {
        //     showContent('workspacesContent');
        // });

        // document.getElementById('sessionsTab').addEventListener('click', () => {
        //     showContent('sessionsContent');
        // });

        // function showContent(contentId) {
        //     const contents = document.querySelectorAll('.content');
        //     contents.forEach(content => {
        //         content.classList.remove('active');
        //     });
        //     document.getElementById(contentId).classList.add('active');

        //     const tabs = document.querySelectorAll('.sidebar-item');
        //     tabs.forEach(tab => {
        //         tab.classList.remove('active');
        //     });
        //     document.querySelector(`#${contentId}Tab`).classList.add('active');
        // }



// CSV LOGIC



// email and website regex
// not unsub emails


// function ShowCsv(){
//     const csvBTN = document.getElementById('csvBTN');
//     const input = document.getElementById('csvFile');

//     csvBTN.style.display = 'none';
//     input.style.display = 'block';
//     console.log("switched")
// }


// function detectColumnType(sample) {
//     const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
//     const namePattern = /^[A-Za-z ,.'-]+$/;
//     const websitePattern = /^(https?:\/\/)?([\w-]+)\.([a-z]{2,6})(\.[a-z]{2,6})?(\/[\w\-.]*)*\/?$/;

//     if (emailPattern.test(sample)) return 'email';
//     if (namePattern.test(sample)) return 'name';
//     if (websitePattern.test(sample)) return 'website';

//     return null;
// }

//         function handleFileSelect(input) {
//             let center = document.getElementById('center');
//             center.style.display = 'none'
//             const file = input.files[0];
//             processCSV(file);
//         }

//         function processCSV(file, hasHeaders) {
//     if (!file) {
//         alert('Please upload a CSV file.');
//         return;
//     }

//     Papa.parse(file, {
//         header: hasHeaders,
//         dynamicTyping: true,
//         complete: function(results) {
//             const data = results.data;
//             if (data.length === 0) {
//                 console.log('Empty CSV file.');
//                 return;
//             }

//             let columns;
//             if (hasHeaders) {
//                 columns = Object.keys(data[0]);
//             } else {
//                 // Generate default column names
//                 columns = data[0].map((_, index) => `Column${index + 1}`);
//                 data.forEach((row, rowIndex) => {
//                     data[rowIndex] = row.reduce((acc, value, index) => {
//                         acc[columns[index]] = value;
//                         return acc;
//                     }, {});
//                 });
//             }

//             let emailCol, nameCol, websiteCol;

//             for (let col of columns) {
//                 const sampleValue = data[0][col];
//                 const colType = detectColumnType(sampleValue);

//                 if (colType === 'email') emailCol = col;
//                 if (colType === 'name') nameCol = col;
//                 if (colType === 'website') websiteCol = col;
//             }

//             if (!emailCol || !nameCol || !websiteCol) {
//                 console.log('Could not detect all necessary columns.');
//                 return;
//             }

//             data.forEach(row => {

//     // // Prepend "https://" if not included
//     if (!/^https:\/\//i.test(row[websiteCol])) {
//     if (/^http:\/\//i.test(row[websiteCol])) {
//         // Replace http:// with https://
//         row[websiteCol] = row[websiteCol].replace(/^http:\/\//i, 'https://');
//     } else {
//         // Prepend https:// if no protocol exists
//         row[websiteCol] = 'https://' + row[websiteCol];
//     }
// }


// //                 if (/^http:\/\//i.test(row[websiteCol])) {
// //     website = row[websiteCol].replace(/^http:\/\//i, 'https://');
// // } else {
// //     website = row[websiteCol];
// // }
//                 const formData = {
//                     email: row[emailCol],
//                     website: row[websiteCol],
//                     name: row[nameCol]
//                 };
//                 submittedData.push(formData);
//                 updateTable();
//             });

//             console.log(JSON.stringify(submittedData, null, 2));
//         }
//     });
// }


// Advanced Lead Sheet Importer

// Global variables from previous implementation
// let submittedData = []; // Keep existing global variable
const UNSUBSCRIBED_EMAILS = []; // Placeholder for unsubscribed emails list

// Advanced Column Detection Utility
const ColumnDetector = {
    // Comprehensive pattern matching for various column names
    emailPatterns: [
        /^email$/i, 
        /contact.*email/i, 
        /^e-?mail$/i, 
        /primary.*email/i,
        /work.*email/i,
        /personal.*email/i
    ],
    namePatterns: [
        /^name$/i, 
        /full.*name/i, 
        /contact.*name/i,
        /^nom$/i, // French
        /^nombre$/i, // Spanish
        /first.*name/i,
        /last.*name/i,
        /full\s*name/i,
        /display.*name/i
    ],
    websitePatterns: [
        /^website$/i, 
        /company.*website/i, 
        /^domain$/i,
        /^url$/i,
        /corporate.*site/i,
        /^web$/i
    ],

    // Advanced regex for email validation
    // emailRegex: /^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9-]+(?:\.[a-zA-Z0-9-]+)*$/,
    emailRegex: /^[^\s@]+@[^\s@]+\.[^\s@]+$/, // Less strict email regex

    // Website validation (improved to exclude social media)
    // websiteRegex: /^(https?:\/\/)?([\da-z\.-]+)\.([a-z\.]{2,6})([\/\w \.-]*)*\/?$/,
    websiteRegex: /^(https?:\/\/)?([\w-]+\.)+[\w]{2,}/, // More permissive domain check

    // Social media domain exclusions
    socialMediaDomains: [
        'facebook.com', 'twitter.com', 'linkedin.com', 'instagram.com', 
        'pinterest.com', 'tiktok.com', 'youtube.com'
    ],

    detectColumn(headers, patterns) {
        // Prioritize exact matches, then partial matches
        for (let pattern of patterns) {
            // First, try exact match
            const exactMatch = headers.find(header => 
                pattern.test(String(header).trim()) && 
                String(header).trim().match(pattern)[0] === String(header).trim()
            );
            if (exactMatch) return exactMatch;
        }

        // Then try partial matches
        for (let pattern of patterns) {
            const partialMatch = headers.find(header => 
                pattern.test(String(header).trim())
            );
            if (partialMatch) return partialMatch;
        }

        return null;
    },

    validateEmail(email) {
        // Comprehensive email validation
        return this.emailRegex.test(email) && 
               !UNSUBSCRIBED_EMAILS.includes(email.toLowerCase());
    },

    validateWebsite(website) {
        // Comprehensive website validation
        if (!this.websiteRegex.test(website)) return false;
        
        // Extract domain and check against social media domains
        const domain = website.replace(/^https?:\/\//, '').split('/')[0];
        return !this.socialMediaDomains.some(socialDomain => 
            domain.includes(socialDomain)
        );
    },

    // Enhanced website normalization
    normalizeWebsite(website) {
        // Remove any leading/trailing whitespace
        website = website.trim();
        
        // Replace http with https
        if (website.startsWith('http://')) {
            website = 'https://' + website.slice(7);
        } else if (!website.startsWith('https://')) {
            website = 'https://' + website;
        }

        // Remove trailing slashes
        website = website.replace(/\/+$/, '');

        return website;
    }
};

// File Processing Utility with Batch Processing
const LeadImporter = {
    MAX_BATCH_SIZE: 400, // Optimal batch size for processing
    processingQueue: [],
    
    async processFile(file) {
        try {
            const fileType = this.detectFileType(file);
            let data = await this.parseFile(file, fileType);
            
            // Batch processing with progress tracking
            this.processingQueue = this.splitIntoBatches(data);
            
            // Start processing batches
            return this.processBatches();
        } catch (error) {
            this.showErrorModal(error);
        }
    },

    detectFileType(file) {
        const extension = file.name.split('.').pop().toLowerCase();
        const supportedTypes = {
            'csv': 'csv',
            'xlsx': 'xlsx',
            'xls': 'xlsx',
            'ods': 'ods',
            'xlsm': 'xlsx',
            'xlsb': 'xlsx',
            'numbers': 'numbers',
            'txt': 'csv'
        };
        return supportedTypes[extension] || null;
    },

    async parseFile(file, fileType) {
        switch(fileType) {
            case 'csv':
                return this.parseCSV(file);
            case 'xlsx':
                return this.parseExcel(file);
            case 'ods':
                return this.parseODS(file);
            default:
                throw new Error('Unsupported file type');
        }
    },

    async parseCSV(file) {
        return new Promise((resolve, reject) => {
            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: (results) => {
                    if (results.errors.length) {
                        reject(new Error('CSV parsing error'));
                    }
                    resolve(results.data);
                },
                error: (error) => reject(error)
            });
        });
    },

    async parseExcel(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const workbook = XLSX.read(e.target.result, {type: 'binary'});
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                    
                    // Convert to object with detected headers
                    const headers = jsonData[0];
                    const data = jsonData.slice(1).map(row => 
                        row.reduce((obj, cell, index) => {
                            obj[headers[index]] = cell;
                            return obj;
                        }, {})
                    );

                    resolve(data);
                } catch (error) {
                    reject(error);
                }
            };
            reader.readAsBinaryString(file);
        });
    },

    async parseODS(file) {
        // Placeholder for ODS parsing
        // In a real-world scenario, you'd use a library like xlsx
        throw new Error('ODS parsing not implemented');
    },

    splitIntoBatches(data) {
        const batches = [];
        for (let i = 0; i < data.length; i += this.MAX_BATCH_SIZE) {
            batches.push(data.slice(i, i + this.MAX_BATCH_SIZE));
        }
        return batches;
    },

    async processBatches() {
        const validLeads = [];
        const issues = {
            missingColumns: [],
            invalidEmails: 0,
            invalidWebsites: 0
        };

        for (let batch of this.processingQueue) {
            if (batch.length === 0) continue;

            const headers = Object.keys(batch[0] || {});
            
            // Detect columns dynamically
            const emailColumn = ColumnDetector.detectColumn(headers, ColumnDetector.emailPatterns);
            const nameColumn = ColumnDetector.detectColumn(headers, ColumnDetector.namePatterns);
            const websiteColumn = ColumnDetector.detectColumn(headers, ColumnDetector.websitePatterns);

            // Track missing columns
            if (!emailColumn) issues.missingColumns.push('Email');
            if (!websiteColumn) issues.missingColumns.push('Website');

            // If critical columns are missing, skip batch
            if (!emailColumn || !websiteColumn) continue;

            const batchResults = batch.map(row => {
                const email = row[emailColumn];
                let website = row[websiteColumn];
                const name = row[nameColumn] || '';

                // Validate and normalize
                if (!ColumnDetector.validateEmail(email)) {
                    issues.invalidEmails++;
                    return null;
                }

                try {
                    // Normalize website
                    website = ColumnDetector.normalizeWebsite(website);

                    if (!ColumnDetector.validateWebsite(website)) {
                        issues.invalidWebsites++;
                        return null;
                    }

                    return {
                        email: email.toLowerCase(),
                        website: website,
                        name: name.trim()
                    };
                } catch {
                    issues.invalidWebsites++;
                    return null;
                }
            }).filter(lead => lead !== null);
console.log(batchResults)
            validLeads.push(...batchResults);
            submittedData.push(...batchResults);
        }

        // Update global submittedData
        // submittedData = validLeads;
        if (submittedData.length === 0){
            this.showErrorModal("Unable to parse document please try again");
        }
        else {
            updateTable();
        }
        // updateTable(); // Existing function from previous implementation

        // Show modal only if there are specific issues
        if (issues.missingColumns.length > 0 || 
            issues.invalidEmails > 0 || 
            issues.invalidWebsites > 0) {
            // this.showResultsModal(validLeads.length, issues);
        }

        return validLeads;
    },


    showResultsModal(validCount, issues) {
        // Create modal with Tailwind CSS for professional look
        const modal = document.createElement('div');
        modal.id = 'results-modal';
        modal.innerHTML = `
            <div class="fixed inset-0 bg-black bg-opacity-50 z-[1000] flex items-center justify-center p-4">
                <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
                    <div class="p-6">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Import Results</h2>
                        
                        <div class="space-y-4">
                            <div class="flex justify-between items-center">
                                <span class="text-green-600 font-semibold">✅ Valid Leads</span>
                                <span class="font-bold">${validCount}</span>
                            </div>
                            
                            ${issues.missingColumns.length > 0 ? `
                            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4">
                                <p class="text-yellow-700">
                                    <strong>Missing Columns:</strong> 
                                    ${issues.missingColumns.join(', ')}
                                </p>
                            </div>` : ''}
                            
                            ${issues.invalidEmails > 0 ? `
                            <div class="bg-red-50 border-l-4 border-red-400 p-4">
                                <p class="text-red-700">
                                    <strong>Invalid Emails:</strong> 
                                    ${issues.invalidEmails} row(s) skipped
                                </p>
                            </div>` : ''}
                            
                            ${issues.invalidWebsites > 0 ? `
                            <div class="bg-red-50 border-l-4 border-red-400 p-4">
                                <p class="text-red-700">
                                    <strong>Invalid Websites:</strong> 
                                    ${issues.invalidWebsites} row(s) skipped
                                </p>
                            </div>` : ''}
                        </div>
                        
                        <div class="mt-6 flex justify-end space-x-3">
                            <button id="close-modal" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);

        // Add event listener to close button
        const closeButton = modal.querySelector('#close-modal');
        closeButton.addEventListener('click', () => {
            document.body.removeChild(modal);
        });
    },

    showErrorModal(message) {
        // Similar professional Tailwind styling
        const modal = document.createElement('div');
        modal.id = 'error-modal';
        modal.innerHTML = `
            <div class="fixed inset-0 bg-black bg-opacity-50 z-[1005] flex items-center justify-center p-4" style="z-index : 1005;">
                <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
                    <div class="p-6">
                        <h2 class="text-2xl font-bold text-red-600 mb-4">Import Error</h2>
                        <p class="text-gray-700 mb-6">${message}</p>
                        <div class="flex justify-end">
                            <button id="close-error-modal" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors">
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);

        // Add event listener to close button
        const closeButton = modal.querySelector('#close-error-modal');
        closeButton.addEventListener('click', () => {
            document.body.removeChild(modal);
        });
    }
};

// Modify existing handleFile function to use new importer

// Existing handleFile function (from previous artifact)
// Modify handleFile to address the upload issues
function handleFile(event) {
    // Prevent default to stop potential file dialog re-opening
    // event.preventDefault();
    event.stopPropagation();
    event.preventDefault();
    
    const file = event.target.files[0];
    if (file) {
        // Reset the file input to allow re-selecting the same file
        event.target.value = '';

        // Check file type
        const allowedTypes = [
            'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', // .xlsx
            'text/csv', 
            'application/csv',
            'application/vnd.ms-excel'
        ];

        if (allowedTypes.includes(file.type) || 
            ['.csv', '.xlsx', '.xls'].some(ext => file.name.toLowerCase().endsWith(ext))) {
            
            // Show loading indicator
            const loadingIndicator = document.createElement('div');
            loadingIndicator.innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 z-[1000] flex items-center justify-center">
                    <div class="bg-white p-6 rounded-lg shadow-xl">
                        <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-blue-500 mx-auto"></div>
                        <p class="mt-4 text-center">Processing file... Please wait.</p>
                    </div>
                </div>
            `;
            document.body.appendChild(loadingIndicator);

            // Use setTimeout to ensure UI updates before processing
            setTimeout(() => {
                LeadImporter.processFile(file)
                    .then(() => {
                        // Remove loading indicator
                        document.body.removeChild(loadingIndicator);
                    })
                    .catch(error => {
                        // Remove loading indicator and show error
                        document.body.removeChild(loadingIndicator);
                        LeadImporter.showErrorModal(error.message);
                    });
            }, 100);
        } else {
            // Show error for unsupported file type
            LeadImporter.showErrorModal('Unsupported file type. Please upload a CSV or Excel file.');
        }
    }
}
// Ensure the file input accepts multiple file types
document.addEventListener('DOMContentLoaded', () => {
    const fileInput = document.getElementById('fileInput');
    const fileMIDDLE = document.getElementById('fileMIDDLE');
    const uploadLabel = document.getElementById('uploadLabel');

    // Single, consolidated setup to prevent multiple bindings
    function setupFileInputHandlers() {
        // Ensure file inputs have correct accept attributes
        if (fileInput) {
            fileInput.accept = '.csv, .xlsx, .xls, .ods, .numbers';
            
            // Remove any existing listeners first to prevent multiple bindings
            fileInput.removeEventListener('change', handleFile);
            fileInput.addEventListener('change', handleFile, false);
        }

        if (fileMIDDLE) {
            fileMIDDLE.accept = '.csv, .xlsx, .xls, .ods, .numbers';
            
            // Remove any existing listeners first
            fileMIDDLE.removeEventListener('change', handleFile);
            fileMIDDLE.addEventListener('change', handleFile, false);
        }

        // Setup upload label click if applicable
        // if (uploadLabel && fileInput) {
        //     // Remove any existing click listeners
        //     uploadLabel.removeEventListener('click', triggerFileInput);
        //     uploadLabel.addEventListener('click', triggerFileInput);
        // }
    }

    // Separate function for file input triggering to avoid duplication
    // function triggerFileInput() {
    //     if (fileInput) {
    //         fileInput.click();
    //     }
    // }

    // Call setup once
    setupFileInputHandlers();
});





// function handleFile(event) {
//     console.log("running file chanfge")
//     const file = event.target.files[0];
//     if (file) {
//         const fileExtension = file.name.split('.').pop().toLowerCase();
//         if (fileExtension === 'xlsx') {
//             handleExcelFile(file);
//         } else if (fileExtension === 'csv') {
//             handleCSVFile(file);
//         } else {
//             alert('Unsupported file type');
//         }
//     }
// }

// function handleExcelFile(file) {
//     const reader = new FileReader();
//     reader.onload = function(e) {
//         const data = new Uint8Array(e.target.result);
//         const workbook = XLSX.read(data, {type: 'array'});
//         const firstSheetName = workbook.SheetNames[0];
//         const worksheet = workbook.Sheets[firstSheetName];
//         const jsonData = XLSX.utils.sheet_to_json(worksheet);

//         processData(jsonData);
//     };
//     reader.readAsArrayBuffer(file);
// }

// function handleCSVFile(file) {
//     Papa.parse(file, {
//         header: true,
//         complete: function(results) {
//             processData(results.data);
//         }
//     });
// }

// function processData(data) {
//     const emailCol = 'Email';
//     const websiteCol = 'Website';
//     const nameCol = 'Name';
//                 let center = document.getElementById('center');
//             center.style.display = 'none'
//     // const submittedData = [];


    
//     data.forEach(row => {

//         if (!/^https:\/\//i.test(row[websiteCol])) {
//     if (/^http:\/\//i.test(row[websiteCol])) {
//         // Replace http:// with https://
//         row[websiteCol] = row[websiteCol].replace(/^http:\/\//i, 'https://');
//     } else {
//         // Prepend https:// if no protocol exists
//         row[websiteCol] = 'https://' + row[websiteCol];
//     }
// }

//         const formData = {
//             email: row[emailCol],
//             website: row[websiteCol],
//             name: row[nameCol]
//         };
//         submittedData.push(formData);
//         updateTable();
//     });

//     console.log(submittedData); // Display the output in the console
// }





function togglePopupManual() {
      const overlay = document.getElementById('manual-popup-overlay');
      const emailInput = document.getElementById('email');
        const websiteInput = document.getElementById('website');
        const nameInput = document.getElementById('name');



        // emailInput.value = "";
        // websiteInput.value = "https://";
        // nameInput.value = "";
      overlay.style.display = overlay.style.display === 'flex' ? 'none' : 'flex';

    }
    function togglePopupDomain() {
      const overlay = document.getElementById('manual-popup-overlay-domain');
    //   const emailInput = document.getElementById('email');
        // const websiteInput = document.getElementById('website');
        // const nameInput = document.getElementById('name');



        // emailInput.value = "";
        // websiteInput.value = "https://";
        // nameInput.value = "";
      overlay.style.display = overlay.style.display === 'flex' ? 'none' : 'flex';

    }

    function isValidURL(string) {
  try {
    new URL(string);
    return false;
  } catch (_) {
    return true;  
  }
}

async function aaddEmailToCampaign(customerEmail, campaignId, newEmailDetails) {
    try {
        const response = await fetch('https://server.voltmailer.com/api/campaigns/addEmail', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                email: customerEmail,
                campaignId: campaignId,
                newEmail: newEmailDetails
            }),
        });

        const result = await response.json();

        if (response.ok) {
            console.log("Email added successfully:", result);
            alert("Email added to campaign successfully!");
        } else {
            console.error("Failed to add email:", result.message);
            alert(`Error: ${result.message}`);
        }
    } catch (error) {
        console.error("Error adding email to campaign:", error);
        alert("An error occurred while adding the email.");
    }
}







async function Manual() {
        const emailInput = document.getElementById('emailinput');
        const websiteInput = document.getElementById('website');
        const nameInput = document.getElementById('name');
        const email_inputted = emailInput.value;
        let website = websiteInput.value;
        const name = nameInput.value;

        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        const websiteRegex = /^https:\/\/.+$/;



    await fetchUnsubscribedEmails(U_MyEmail); // Fetch all unsubscribed emails once
    const isNotUnsubscribed = isEmailNotUnsubscribed(email_inputted);

    if (isNotUnsubscribed) {
        console.log(`${email_inputted} is not unsubscribed and can be added.`);
    } else {
        console.log(`${email_inputted} is unsubscribed and cannot be added.`);
        manualError.textContent = `${email_inputted} is unsubscribed and cannot be added.`;
        return;
    }


    // // Prepend "https://" if not included
    if (!/^https:\/\//i.test(website)) {
    if (/^http:\/\//i.test(website)) {
        // Replace http:// with https://
        website = website.replace(/^http:\/\//i, 'https://');
    } else {
        // Prepend https:// if no protocol exists
        website = 'https://' + website;
    }
}

    console.log(isValidURL(website))
        if (!emailRegex.test(email_inputted)) {
            manualError.textContent = "Invalid email format.";
            return;
        } else if (!websiteRegex.test(website)) {
            manualError.textContent = "Invalid website format. Must start with https://";
            return;
        } else {
            manualError.textContent = "";
        }

        if (isValidURL(website)){
            manualError.textContent = "Invalid URL format.";
            return;
            } else {
                manualError.textContent = "";
            }

        const formData = {
            email: email_inputted,
            website: website,
            name: name
        };
        sNotification(`Added ${formData.email}`)
        submittedData.push(formData);
        console.log(updateTable());
         // Clear input fields manually
        emailInput.value = "";
        websiteInput.value = "https://";
        nameInput.value = "";
        console.log("cleared")

// Usage example:
// const campaignId = localStorage.getItem('currentCampaignId'); // Assuming this is set
// const testEmailDetails = {
//     recipientEmail: 'test@example.com',
//     subject: 'Hello World',
//     messageId: 'msg123',
//     threadId: 'thread456',
//     status: 'sent',
//     bounces: false,
//     responseCount: 0
// };

// aaaaddEmailToCampaign(campaignId, testEmailDetails);

// Example usage:
// const customerEmail = "rohanmehmi72@gmail.com";
// const newEmailDetails = {
//     recipientEmail: "recipient@example.com",
//     subject: "Your subject here",
//     messageId: "unique-message-id",
//     threadId: "unique-thread-id",
//     sentTime: new Date(),
//     status: "sent",
//     bounces: false,
//     responseCount: 0
// };

// aaddEmailToCampaign(customerEmail, campaignId, newEmailDetails);



        togglePopupManual()
}

// function updateTable() {
//       const dataTable = document.getElementById('dataTable').getElementsByTagName('tbody')[0];
//       let center = document.getElementById('center');
//       center.style.display = 'none';
//       dataTable.innerHTML = ''; // Clear the existing table rows
//       console.log("working: ", submittedData);
      
//       submittedData.forEach((data, index) => {
//         const row = dataTable.insertRow();
//         const emailCell = row.insertCell(0);
//         const websiteCell = row.insertCell(1);
//         const nameCell = row.insertCell(2);
//         const actionCell = row.insertCell(3); // Cell for delete button

//         // Create delete button
//         const deleteButton = document.createElement('button');
//         deleteButton.style.color = "#000";
//         deleteButton.textContent = 'X';

//         deleteButton.addEventListener('click', function() {
//           deleteRow(index); // Call deleteRow function with index
//         });

//         emailCell.textContent = data.email;
//         websiteCell.textContent = data.website;
//         nameCell.textContent = data.name;
//         actionCell.appendChild(deleteButton); // Append delete button to action cell
//         row.setAttribute('data-index', index);
//       });
//     }

//     function deleteRow(index) {
//       submittedData.splice(index, 1); // Remove data from array
//       updateTable(); // Update table to reflect changes
//     }

    function updateTable() {
    const dataTable = document.getElementById('dataTable').getElementsByTagName('tbody')[0];
    let center = document.getElementById('center');

                        // const theader = document.getElementById('thead').style.display = 'flex';
                        // const thbos = document.getElementById('tablerows').style.display = 'flex';
    const thead = document.getElementById('dataTable').getElementsByTagName('thead')[0];

    // document.getElementById("thead").style.display = "inline-block";
    center.style.display = 'none';
    dataTable.innerHTML = ''; // Clear the existing table rows


    if (!thead || thead.rows.length === 0) {
        if (!thead) {
            thead = table.createTHead();
        }
        const headerRow = thead.insertRow();
        const headers = ['Email', 'Website', 'Recipient Name', 'Actions'];

        headers.forEach(headerText => {
            const th = document.createElement('th');
            th.textContent = headerText;
            headerRow.appendChild(th);
        });
    }


    console.log("working: ", submittedData);

    submittedData.forEach((data, index) => {
        const row = dataTable.insertRow();
        const emailCell = row.insertCell(0);
        const websiteCell = row.insertCell(1);
        const nameCell = row.insertCell(2);
        const actionCell = row.insertCell(3); // Cell for action buttons

        // Create edit button
        const editButton = document.createElement('button');
        editButton.style.color = "#000";
        editButton.textContent = 'Edit';
        editButton.classList.add('btn-s', 'btn-secondary-s'); 

        editButton.addEventListener('click', function() {
            editButton.remove();
            editRow(index, row); // Call editRow function with index
        });

        // Create delete button
        const deleteButton = document.createElement('button');
        deleteButton.style.color = "#000";
        deleteButton.textContent = 'X';
        deleteButton.classList.add('btn-s', 'btn-secondary-s'); 

        deleteButton.addEventListener('click', function() {
            
            deleteRow(index); // Call deleteRow function with index
        });

        console.log(formatText(data.email).length, simplifyWebsite(data.website).length,formatText(data.name).legnth )
        emailCell.textContent = formatText(data.email);
websiteCell.textContent = simplifyWebsite(data.website);
nameCell.textContent = formatText(data.name);


        actionCell.appendChild(editButton); // Append edit button to action cell
        actionCell.appendChild(deleteButton); // Append delete button to action cell
        row.setAttribute('data-index', index);
    });
}

function deleteRow(index) {
    submittedData.splice(index, 1); // Remove data from array
    sNotification(`Removed`)
    updateTable(); // Update table to reflect changes
}

function formatText(text, maxLength = 10) {
    // If text is undefined, null, or an empty string, return empty string

    
    // If text is longer than max length, truncate
    if (text.length > maxLength) {
        return text.substring(0, maxLength) + '...';
    }
    
    // If text is shorter than 12 characters, pad with whitespace on the left
    if (text.length < 12) {
        return text.padStart(12);
    }
    
    // If text is between 10-12 characters, return as is
    if (!text) {
        return '            ';
    } else {
        return text;
    }

}

function simplifyWebsite(url) {
    // Remove protocol (https:// or http://)
    let cleanUrl = url.replace(/^https?:\/\//, '');
    
    // Remove everything after .com, .org, .net, etc.
    const tldMatch = cleanUrl.match(/^([^.]+\.[a-z]+)/i);
    
    return tldMatch ? tldMatch[1] : cleanUrl;
}



function editRow(index, row) {
    const data = submittedData[index];
    const emailCell = row.cells[0];
    const websiteCell = row.cells[1];
    const nameCell = row.cells[2];
    const actionCell = row.cells[3];

    // Replace text with input fields
    emailCell.innerHTML = `<input type="email" value="${data.email}" />`;
    websiteCell.innerHTML = `<input type="url" value="${data.website}" />`;
    nameCell.innerHTML = `<input type="text" value="${data.name}" />`;

    // Change the edit button to a save button
    const saveButton = document.createElement('button');
    saveButton.style.color = "#000";
    saveButton.textContent = 'Save';
    saveButton.classList.add('btn-s', 'btn-secondary-s'); 

    saveButton.addEventListener('click', function() {
        saveRow(index, row); // Call saveRow function with index and row
    });

    // Remove old edit and delete buttons

    actionCell.appendChild(saveButton);
}

function saveRow(index, row) {
    const emailCell = row.cells[0];
    const websiteCell = row.cells[1];
    const nameCell = row.cells[2];
    const actionCell = row.cells[3];

    // Get new values from input fields
    const newEmail = emailCell.firstChild.value;
    const newWebsite = websiteCell.firstChild.value;
    const newName = nameCell.firstChild.value;

    // Update the submittedData array
    submittedData[index] = { email: newEmail, website: newWebsite, name: newName };

    // Replace input fields with text
    emailCell.textContent = newEmail;
    websiteCell.textContent = newWebsite;
    nameCell.textContent = newName;

    // Restore the edit and delete buttons
    actionCell.innerHTML = '';

    // Create edit button
    const editButton = document.createElement('button');
        editButton.style.color = "#000";
        editButton.textContent = 'Edit';
        editButton.classList.add('btn-s', 'btn-secondary-s'); 

        editButton.addEventListener('click', function() {
            editButton.remove();
            editRow(index, row); // Call editRow function with index
        });

    // Create delete button
    const deleteButton = document.createElement('button');
    deleteButton.style.color = "#000";
    deleteButton.textContent = 'X';
    deleteButton.classList.add('btn-s', 'btn-secondary-s'); 
    deleteButton.addEventListener('click', function() {
        deleteRow(index); // Call deleteRow function with index
    });

    actionCell.appendChild(editButton); // Append edit button to action cell
    actionCell.appendChild(deleteButton); // Append delete button to action cell
}





    function clearTable() {
      submittedData = []; // Clear the data array
      updateTable(); // Update table to reflect changes
    }

    function reset(){
        sNotification(`Reset`)
        console.log("reset clicked")
        // formData = []
        submittedData = [];
        // if (submittedData = []){
            // return;
        // }else{
            // submittedData = [];
            
        // }
        updateTable();
        // dataTable.innerHTML = '';
// document.getElementById('tablerows').innerHTML = '';
    }

// SUBMIT THE DATA 

function checkbox() {
            const checkbox = document.getElementById('cbx-46');
            const text = document.getElementById('autosend-text');
            if (checkbox.checked) {
                text.innerHTML = 'Autosend is <b>ON</b>';
            } else {
                text.innerHTML = 'Autosend is <b>OFF</b>';
            }
        }

function IsAutoSend() {
            const checkbox = document.getElementById('cbx-46');
            return checkbox.checked;
        }

function Submitandcheckautosend(){

    
          if (submittedData.length === 0) {
              // The array is empty
              console.log('The array is empty');
              showNotification(`Please submit data`);
          } 
          else {
            // The array is not empty
            console.log('The array is not empty');
            const userPitch = document.getElementById('userPitch').value;
            const UserSubject = document.getElementById('UserSubject').value;
            const userTemplate = document.getElementById('userTemplate').value;
            console.log(U_MyEmail)

            if (U_MyEmail === 'Test@gmail.com'){
                console.log(U_MyEmail, (U_MyEmail === 'Test@gmail.com'))
                if(UserSubject.trim() === ''){
                    sNotification(`Please submit a subject`);
                }
                else {
                    if(userTemplate.trim() === ''){
                        sNotification(`Please submit a body`);
                    }   
                    else{
                        sendForIndianGuy(userTemplate, UserSubject)
                    }
                }
                


            } else {
            if (userPitch.trim() === '') {
                // The value is empty or only contains whitespace
                console.log('No value provided');
                sNotification(`Please submit a pitch`);
            } else {
                // The value is not empty
                console.log('Value provided:', userPitch);
                if (IsAutoSend()){
                  Autosend_new();
                }else{
                  manualSend();
            }
            }
          }

        }
        }


    async function sendForIndianGuy(userTemplate, UserSubject){
    const emails = await fetchActiveMailbox(U_MyEmail);
    console.log(emails, submittedData);
    let errorOccurred = false;

    for (let index = 0; index < submittedData.length; index++) {

        // const data = generatedData[index];
        const selectedEmail = emails[index % emails.length];
        let email = submittedData[index].email
        console.log(UserSubject, userTemplate, email)
        
        try {
            console.log(`Sending email #${index + 1} using ${selectedEmail}`);
            await sendEmailsmtp(index, UserSubject, userTemplate, email, selectedEmail); // Send email
        } catch (error) {
            console.error(`Failed to send email for index ${index}:`, error);
            errorOccurred = true;
        }
    }

    // Handle notifications after all emails are processed
    if (errorOccurred) {
        showNotification('Error sending one or more emails');
    } else {
        showNotification('All emails sent successfully');
    }
    NewCampaign()
    sNotification('Emails are sending in background');
    console.log('All emails processed.');
}

// SENDING THE EMAILS AUTOMATED (TAB CAN BE CLOSED)
// async function Autosend() {
//   const dataTable = document.getElementById('dataTable').getElementsByTagName('tbody')[0];
//   // get the pitch and create a thread
//   const userPitch = document.getElementById('userPitch').value; // Get user pitch from textarea
//   const button = document.getElementById('submit');
//   button.innerHTML=`<button class="btn"><div class="loader"></div> </button>`
//   const threadResponse = await fetch('/create-thread', { method: 'POST' });

//   const threadData = await threadResponse.json();
//   const threadID = threadData.thread_id;
//   console.log(threadID)
//   SENT_EMAILS = 0
//   // iterate through each item in the submitted data and send to its respective email address 
//   for (let index = 0; index < submittedData.length; index++) {
//         const data = submittedData[index];
//         console.log('starting send to ', data.email);

//         try {
//           updateRowStatus(index, 'Retrieving message');
//             // Get the website content
//             const descriptionResponse = await fetch('/get-site-description', {
//                 method: 'POST',
//                 headers: { 'Content-Type': 'application/json' },
//                 body: JSON.stringify({ url: data.website })
//             });

//             const descriptionData = await descriptionResponse.json();
//             const website_content = descriptionData.description;
//             const Uname = '{{ name }}'
//             const To = data.name
//             console.log(data.email, website_content,Uname, To );

//             updateRowStatus(index, 'Personalizing message');
//             // Add messages to the thread
//             const emailContentResponse = await fetch('/add-messages-to-thread', {
//                 method: 'POST',
//                 headers: {
//                     'Content-Type': 'application/json'
//                 },
//                 body: JSON.stringify({
//                     thread_id: threadID,
//                     website_content: website_content,
//                     user_pitch: userPitch,
//                     To: To,
//                     Me: Uname
//                 })
//             });

//             const emailContentData = await emailContentResponse.json();
//             const email_content = emailContentData.email_content;
//             const lines = email_content.split('\n');
//             const subject_line = lines[0].replace('Subject: ', '');
//             const main_message = lines.slice(1).join('\n').trim();
//             console.log(data.email, "returned email sub : ", subject_line);
//             console.log(data.email, " email content : ", main_message);

//             updateRowStatus(index, 'Sending');
//             // Send the emails
//             const result = await sendMessage('me', data.email, subject_line, main_message);
//             console.log('Message to ', data.email, ' successfully sent:', result);
//             showNotification(`Message to ${data.email} successfully sent`)
//             updateRowStatus(index, 'Sent');
//             SENT_EMAILS = SENT_EMAILS + 1;
//         } catch (error) {
//             console.error('Error processing email for', data.email, ':', error);
//             showNotification(`Error processing email for ${data.email}`)
//             updateRowStatus(index, 'Error');
//             // add to error row data, give user option to attempt to resend all error data at the end.
//             // Optionally handle resend logic here
//         }
//     }
//   console.log('all emails sent');
//   showNotification('All Emails Sent !')
//   button.innerHTML=`<button class="button" onclick="Restart()">
//                         <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 36 24">
//                           <path d="m18 0 8 12 10-8-4 20H4L0 4l10 8 8-12z"></path>
//                         </svg>
//                        Send More
//                       </button>
//                       <h3>Sent!</h3>`
//   useEmails(SENT_EMAILS);


// }


async function Autosend() {
  const button = document.getElementById('submit');
  button.innerHTML = `<button class="btn"><div class="loader"></div> </button>`;

  const userPitch = document.getElementById('userPitch').value; 
//   const submittedData = getSubmittedData(); // Replace with your method of retrieving the submitted data

  const response = await fetch('/start-email-task', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ submittedData, userPitch })
  });

  const responseData = await response.json();
  const taskId = responseData.task_id;

  checkTaskStatus(taskId);
}

function NewCampaign() {
    submittedData = [];
    generatedData = [];
                    // reset the whole thing {

                    // disable button 
                    document.getElementById('pr').style.display = `block`;
                    document.getElementById('sending').style.display = 'none';

                    document.getElementById('uploadLabel').style.display = "flex";
                    document.getElementById('DOMAIN').style.display = "flex";
    document.getElementById('man').style.display = "flex";
    document.getElementById('export').style.display = "none";
    // let center = document.getElementById('center');
    // center.style.display = 'block';
                    // disable textarea 
                    // disable buttons 
                    // const dataTable = document.getElementById('dataTable').getElementsByTagName('tbody')[0];
                    // dataTable.style.display = "none"


                    document.getElementById('currentContent').style.display = 'flex';
                    document.getElementById('newContent').style.display = 'none';
                    // document.getElementById('hidewhengenerating').style.display = 'flex';

                    formData = []
                    submittedData = []

                    document.getElementById('submit').innerHTML = `<button class="button" onclick="Submitandcheckautosend()" id="submit">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 36 24">
                          <path d="m18 0 8 12 10-8-4 20H4L0 4l10 8 8-12z"></path>
                        </svg>
                        Generate
                    </button> `
                    updateTable();
                    const csv = document.getElementById('uploadLabel');
                    const man = document.getElementById('man');
                    csv.disabled = false;
                    man.disabled = false;
                    const textarea = document.getElementById('userPitch');
                    textarea.disabled = false;
                    // document.getElementById('ca').style.display = "block"
                    // let center = document.getElementById('center');
                    // center.style.display = 'flex'
                    // const theader = document.getElementById('thead').style.display = 'none';
                    // const thbos = document.getElementById('tablerows').style.display = 'none';
}


async function Autosend_new(){

    // disable button 
    document.getElementById('submit').innerHTML = `  <section class="dots-container">
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                      </section> `;


            const userPitch = document.getElementById('userPitch').value; 
            // const token = 'YOUR_JWT_TOKEN'; // Replace with your actual JWT token
            const token = localStorage.getItem('authToken');
            const userTemplate = document.getElementById('userTemplate').value;
    const campaignName = generateUniqueCampaignName();
    const UserSubject = document.getElementById('UserSubject').value;
    // Example usage:
const campaignDetails = {
    email: U_MyEmail,
    campaignName: campaignName,
    template:userTemplate,
    pitch:userPitch
};

campaignId = await Campaign(campaignDetails);

console.log(campaignId)
localStorage.setItem('currentCampaignId', campaignId);
let requestBody = {
                submittedData: submittedData,
                userPitch: userPitch,
                Uname: U_Username,
                token: token,
                myemail: U_MyEmail,
                campaignId: campaignId,
            }
if(UserSubject) {
     requestBody = {
                submittedData: submittedData,
                userPitch: userPitch,
                Uname: U_Username,
                token: token,
                myemail: U_MyEmail,
                campaignId: campaignId,
                UserSubject: UserSubject
            }
}else {
    requestBody = {
                submittedData: submittedData,
                userPitch: userPitch,
                Uname: U_Username,
                token: token,
                myemail: U_MyEmail,
                campaignId: campaignId,
            }
}

            
            // Example usage:


            // document.getElementById('statusMessage').textContent = 'Emails are being sent. You can close the tab.';
            sNotification('Emails are being sent. You can close the tab.')
            // sNotification(`Added ${formData.email}`)
            try {
                const response = await fetch('https://server.voltmailer.com/send-emails', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(requestBody)
                });

                if (response.ok) {

                    NewCampaign()
                    sNotification('Emails are sending in background');

//                     console.log('Email sending process started.');
//                     document.getElementById('pr').style.display = `none`;
//                     document.getElementById('sending').style.display = 'block';
//                     //disable textarea 
//                     // disable buttons 

//                         // Get references to the button and textarea
//                     // document.getElementById('inputButtons').style.display = "none";
//                     const textarea = document.getElementById('userPitch');
//                     const csv = document.getElementById('uploadLabel');
//                     const man = document.getElementById('man');
//                     textarea.disabled = true;
//                     csv.disabled = true;
//                     man.disabled = true;
//                     // document.getElementById('hidewhengenerating').style.display = 'none';
//                     document.getElementById('submit').innerHTML = ` 
                    
                    
                    

//                                         <button class="button" onclick="NewCampaign()">
//                         <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 36 24">
//                           <path d="m18 0 8 12 10-8-4 20H4L0 4l10 8 8-12z"></path>
//                         </svg>
//                          New Campaign
//                       </button>
// `


                } else {
                    console.error('Error starting email sending process:', response.statusText);
                }
            } catch (error) {
                console.error('Error sending emails:', error);
                alert('Error sending emails');
            }
};




async function checkTaskStatus(taskId) {
  const response = await fetch(`/task-status/${taskId}`);
  const data = await response.json();

  if (data.state === 'PENDING' || data.state === 'PROGRESS') {
    setTimeout(() => checkTaskStatus(taskId), 1000);
  } else if (data.state === 'SUCCESS') {
    showNotification('All Emails Sent!');
    document.getElementById('submit').innerHTML = `<button class="button" onclick="Restart()">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 36 24">
                          <path d="m18 0 8 12 10-8-4 20H4L0 4l10 8 8-12z"></path>
                        </svg>
                       Send More
                      </button>
                      <h3>Sent!</h3>`;
  } else {
    showNotification(`Error: ${data.status}`);
    document.getElementById('submit').innerHTML = `<button class="button" onclick="Restart()">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 36 24">
                          <path d="m18 0 8 12 10-8-4 20H4L0 4l10 8 8-12z"></path>
                        </svg>
                       Retry
                      </button>
                      <h3>Error</h3>`;
  }
}



function updateRowStatus(index, string){
    console.log(index,string)
}
async function Restart() {
  submittedData = [];
  generatedData = [];
  document.getElementById('currentContent').style.display = 'block';
  document.getElementById('newContent').style.display = 'none';
  document.getElementById('togglewoggle').style.display = 'flex';
  document.getElementById('uploadLabel').style.display = "flex";
  document.getElementById('DOMAIN').style.display = "flex";
    document.getElementById('man').style.display = "flex";
    document.getElementById('export').style.display = "none";
  dataTable = document.getElementById('dataTable');
  dataTable.innerHTML=``;
  button.innerHTML=`<button class="button" onclick="SendEmails()">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 36 24">
                          <path d="m18 0 8 12 10-8-4 20H4L0 4l10 8 8-12z"></path>
                        </svg>
                       Generate
                      </button>`
}
// SENDING EMAILS MANUALLY



function showNewHtml() {
    document.getElementById('currentContent').style.display = 'none';
    document.getElementById('newContent').style.display = 'block';
    document.getElementById('tfoot').style.display = 'none';
    // document.getElementById('hidewhengenerating').style.display = 'none';
    populateEmailTable();
}

// function toggleDetails(index) {
//     const detailsRow = document.getElementById(`details-${index}`);
//     const arrowIcon = document.getElementById(`arrow-${index}`);
//     if (detailsRow.style.display === 'none' || detailsRow.style.display === '') {
//         detailsRow.style.display = 'table-row';
//         detailsRow.style.height = '0px';
//         arrowIcon.innerHTML = '↑';
//         setTimeout(() => {
//             detailsRow.style.transition = 'height 0.3s ease-out, opacity 0.3s ease-out';
//             detailsRow.style.height = detailsRow.scrollHeight + 'px';
//             detailsRow.style.opacity = '1';
//         }, 0);
//     } else {
//         detailsRow.style.transition = 'height 0.3s ease-out, opacity 0.3s ease-out';
//         detailsRow.style.height = '0px';
//         detailsRow.style.opacity = '0';
//         arrowIcon.innerHTML = '↓';
//         setTimeout(() => {
//             detailsRow.style.display = 'none';
//         }, 300);
//     }
// }

let unsubscribedEmailsCache = [];

// Function to fetch all unsubscribed emails
async function fetchUnsubscribedEmails(sender) {
    try {
        const response = await fetch(`https://server.voltmailer.com/get-unsubscribed-emails?sender=${encodeURIComponent(sender)}`);
        
        if (!response.ok) {
            const { message } = await response.json();
            throw new Error(message || 'Failed to fetch unsubscribed emails.');
        }

        const { unsubscribedEmails } = await response.json();
        unsubscribedEmailsCache = unsubscribedEmails; // Cache the emails
        console.log('Unsubscribed emails fetched:', unsubscribedEmailsCache);
    } catch (error) {
        console.error('Error fetching unsubscribed emails:', error);
    }
}

// Function to check if an email is unsubscribed
function isEmailNotUnsubscribed(emailToCheck) {
    return !unsubscribedEmailsCache.includes(emailToCheck);
}





function separateSubject(input) {
    // Check if the input starts with "Subject: "
    const prefix = "Subject: ";
    if (input.startsWith(prefix)) {
        // Extract the actual subject line by removing the prefix
        const actualSubject = input.substring(prefix.length);
        return {
            prefix: prefix.trim(),
            subject: actualSubject.trim()
        };
    } else {
        // If the input does not start with "Subject: ", return null or handle accordingly
        return null;
    }
}

function generateUniqueCampaignName() {
    // Create a random string using `Math.random` and convert it to a hex-like format
    return `Campaign-${Math.random().toString(36).substring(2, 10)}`;
}


async function manualSend() {
    document.getElementById('uploadLabel').style.display = "none";
    document.getElementById('DOMAIN').style.display = "none";
    document.getElementById('man').style.display = "none";
    document.getElementById('export').style.display = "flex";
    // document.getElementById('ca').style.display = "none"
    const userPitch = document.getElementById('userPitch').value; // Get user pitch from textarea
    // const userPitch = document.getElementById('userPitch').value;
            const UserSubject = document.getElementById('UserSubject').value;
            const userTemplate = document.getElementById('userTemplate').value;

    document.getElementById('customLoader').style.display = 'flex';
    const textarea = document.getElementById('userPitch');
                    const csv = document.getElementById('uploadLabel');
                    const man = document.getElementById('man');
                    textarea.disabled = true;
                    csv.disabled = true;
                    man.disabled = true;

    // document.getElementById('togglewoggle').style.display = 'none';
    const button = document.getElementById('submit');
    showNewHtml();
    button.innerHTML = `<section class="dots-container">
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                      </section> `;

    generatedData = [];

    const campaignName = generateUniqueCampaignName();
    // Example usage:
const campaignDetails = {
    email: U_MyEmail,
    campaignName: campaignName,
    template:userTemplate,
    pitch:userPitch
};

campaignId = await Campaign(campaignDetails);

console.log(campaignId)
localStorage.setItem('currentCampaignId', campaignId);


    for (let index = 0; index < submittedData.length; index++) {
        
        const data = submittedData[index];

        try {
            const sddata = submittedData[index];
            let website = sddata.website
            updateRowStatus(index, 'Personalizing message');
            if (!/^https:\/\//i.test(website)) {
    if (/^http:\/\//i.test(website)) {
        // Replace http:// with https://
        website = website.replace(/^http:\/\//i, 'https://');
    } else {
        // Prepend https:// if no protocol exists
        website = 'https://' + website;
    }
}
            const response = await fetch('https://server.voltmailer.com/generate-email-content', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        website: website, 
                        userPitch: userPitch, 
                        Uname: U_Username,
                        To: sddata.name,
                    Template : userTemplate
                })
                });

                if (!response.ok) {
                    throw new Error('Failed to generate email content');
                }

                const data_new = await response.json();
let subjectline = ""
if(UserSubject){
     subjectline = UserSubject
    console.log("if : ",subjectline)
}else{
     subjectline = separateSubject(data_new.subject_line).subject
    console.log("else : ", subjectline)
}
                // const subject_line = separateSubject(data_new.subject_line).subject
                const subject_line = subjectline
                // console.log(subject_line)
                const main_message = data_new.body_content

                console.log(main_message)


            generatedData.push({
                email: sddata.email,
                subject: subject_line,
                content: main_message
            });
          console.log( 'generated data', generatedData)
            document.getElementById('loaderText').innerText = `Generating email for ${data.email}...`;
            // await new Promise(resolve => setTimeout(resolve, 500)); // Simulate delay

            addEmailRow(generatedData.length - 1);
            // populateEmailTable();

        } catch (error) {
            console.error('Error generating email for', data.email, ':', error);
            showNotification(`Error generating email for ${data.email}`);
        }
    }
    allemailsmade = true
    console.log( 'generated data : ', generatedData)
    document.getElementById('tfoot').style.display = 'block';
    document.getElementById('customLoader').style.display = 'none';
    // <button class="button" onclick="sendAllEmails()">
    //                     <i class="fi fi-rs-paper-plane"></i>
    //                     Send All
    //                 </button>
    button.innerHTML = `


                        <button class="button" onclick="sendAllEmails()" id="multiEmailBtn">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 36 24">
                          <path d="m18 0 8 12 10-8-4 20H4L0 4l10 8 8-12z"></path>
                        </svg>
                        Send All
                      </button>

                `;
    // populateEmailTable();
}

function addEmailRow(index) {
    const data = generatedData[index];
    const tbody = document.getElementById('emailTable').getElementsByTagName('tbody')[0];

    const row = document.createElement('tr');
    console.log(data.content)
    row.innerHTML = `
        <td>${data.email}</td>
        <td class="action-buttons">
            <button onclick="sendEmailindex(${index})" class="button-icon">Send Now</button>
            <div class="tooltipcccc">
                <button onclick="toggleDetails(${index})" class="button-iconcccc" id="arrow-${index}">↓</button>
                <span class="tooltiptext"></span>
            </div>
        </td>
    `;
    tbody.appendChild(row);

    const detailsRow = document.createElement('tr');
    detailsRow.style.display = 'none';
    detailsRow.id = `details-${index}`;
    detailsRow.innerHTML = `
        <td colspan="2">
            <div class="details">
                <label>Subject:</label>
                <div class="editable-container">
                    <div class="editable text-container" id="subject-display-${index}">${data.subject}</div>
                    <span class="pencil-icon" id="subject-pencil-${index}" onclick="makeEditable('subject', ${index})">✏️</span>
                </div>
                <label>Content:</label>
                <div class="editable-container">
                    <pre class="editable text-container" id="content-display-${index}" style="white-space: pre-wrap;
    font-family: Arial, sans-serif !important;">${data.content}</pre>
                    <span class="pencil-icon" id="content-pencil-${index}" onclick="makeEditable('content', ${index})">✏️</span>
                </div>
            </div>
        </td>
    `;
    tbody.appendChild(detailsRow);
}


async function sendEmailindexwithsmtp(index,selectedMailbox) {

if (generatedData.length === 0) {

                // return;
                document.getElementById('pr').style.display = `none`;
    document.getElementById('sending').style.display = 'block';
    document.getElementById('submit').innerHTML = ` 
    

                                    <button class="button" onclick="NewCampaign()">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 36 24">
                      <path d="m18 0 8 12 10-8-4 20H4L0 4l10 8 8-12z"></path>
                    </svg>
                     New Campaign
                  </button>


                    `;
return



}
else {

try {
    // const selectedMailbox = await selectMailboxForEmail();
    // console.log(`Using mailbox: ${selectedMailbox}`);
    // Add your email sending logic here



const data = generatedData[index];
const subjectElement = document.getElementById(`subject-display-${index}`);
const contentElement = document.getElementById(`content-display-${index}`);

if (!subjectElement || !contentElement) {
    console.error(`Element(s) not found for index ${index}`);
    showNotification(`Error: Could not find elements to send email for index ${index}`);
    return;
}

// const subject = subjectElement.value;
// const content = contentElement.value;
const subject =    data.subject;
const content =     data.content;

console.log(subject, content)

// Implement send logic here
try {
    // updateRowStatus(index, 'Sending');
    const campaignId = localStorage.getItem('currentCampaignId');

    const result = await sendMessage('me', data.email, subject, content, campaignId, selectedMailbox);


    console.log('Message to ', data.email, ' successfully sent:', result);
    showNotification(`Message to ${data.email} successfully sent`);
    removeRow(index);

    if (generatedData.length === 0) {
                // return;
                document.getElementById('pr').style.display = `none`;
    document.getElementById('sending').style.display = 'block';
    document.getElementById('submit').innerHTML = ` 
    

                                    <button class="button" onclick="NewCampaign()">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 36 24">
                      <path d="m18 0 8 12 10-8-4 20H4L0 4l10 8 8-12z"></path>
                    </svg>
                     New Campaign
                  </button>


                    `;
return


                }

} catch (error) {
        removeRow(index);
//     console.error('Error sending email to', data.email, ':', error);
//     showNotification(`Error sending email to ${data.email}`);
}
} catch (error) {
    console.error('Selection process failed:', error);
}
}

}



async function sendEmailsmtp(index,subject,content, email, selectedMailbox) {

if (submittedData.length === 0) {

                // return;
                document.getElementById('pr').style.display = `none`;
    document.getElementById('sending').style.display = 'block';
    document.getElementById('submit').innerHTML = ` 
    

                                    <button class="button" onclick="NewCampaign()">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 36 24">
                      <path d="m18 0 8 12 10-8-4 20H4L0 4l10 8 8-12z"></path>
                    </svg>
                     New Campaign
                  </button>


                    `;
return



}
else {

try {


console.log(subject, content)

// Implement send logic here
try {
    // updateRowStatus(index, 'Sending');
    const campaignId = localStorage.getItem('currentCampaignId');

    const result = await sendMessage('me', email, subject, content, campaignId, selectedMailbox);


    console.log('Message to ', email, ' successfully sent:', result);
    showNotification(`Message to ${email} successfully sent`);
    removeRow(index);

    if (submittedData.length === 0) {
                // return;
                document.getElementById('pr').style.display = `none`;
    document.getElementById('sending').style.display = 'block';
    document.getElementById('submit').innerHTML = ` 
    

                                    <button class="button" onclick="NewCampaign()">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 36 24">
                      <path d="m18 0 8 12 10-8-4 20H4L0 4l10 8 8-12z"></path>
                    </svg>
                     New Campaign
                  </button>


                    `;
return


                }

} catch (error) {
        removeRow(index);
}
} catch (error) {
    console.error('Selection process failed:', error);
}
}
}







async function sendEmailindex(index) {
    console.log(generatedData)

    if (generatedData.length === 0) {
        
        // sNotification(`Sent Email`)
        NewCampaign()
                    // return;
        //             document.getElementById('pr').style.display = `none`;
        // document.getElementById('sending').style.display = 'block';
        // document.getElementById('submit').innerHTML = ` 
        

        //                                 <button class="button" onclick="NewCampaign()">
        //                 <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 36 24">
        //                   <path d="m18 0 8 12 10-8-4 20H4L0 4l10 8 8-12z"></path>
        //                 </svg>
        //                  New Campaign
        //               </button>


        //                 `;
    return
    


}

else {

    try {

        const selectedMailbox = await selectMailboxForEmail();
        console.log(`Using mailbox: ${selectedMailbox}`);
        // Add your email sending logic here


    
    const data = generatedData[index];
    const subjectElement = document.getElementById(`subject-display-${index}`);
    const contentElement = document.getElementById(`content-display-${index}`);

    if (!subjectElement || !contentElement) {
        console.error(`Element(s) not found for index ${index}`);
        showNotification(`Error: Could not find elements to send email for index ${index}`);
        return;
    }

    // const subject = subjectElement.value;
    // const content = contentElement.value;
    const subject =    data.subject;
    const content =     data.content;

    console.log(subject, content)

    // Implement send logic here
    try {
        // updateRowStatus(index, 'Sending');
        const campaignId = localStorage.getItem('currentCampaignId');

        const result = await sendMessage('me', data.email, subject, content, campaignId, selectedMailbox);


        console.log('Message to ', data.email, ' successfully sent:', result);
        showNotification(`Message to ${data.email} successfully sent`);
        removeRow(index);
        if(allemailsmade) {
        if (generatedData.length === 0) {
            sNotification(`Sent Email`)
            NewCampaign()
                    // return;
        //             document.getElementById('pr').style.display = `none`;
        // document.getElementById('sending').style.display = 'block';
        // document.getElementById('submit').innerHTML = ` 
        

        //                                 <button class="button" onclick="NewCampaign()">
        //                 <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 36 24">
        //                   <path d="m18 0 8 12 10-8-4 20H4L0 4l10 8 8-12z"></path>
        //                 </svg>
        //                  New Campaign
        //               </button>


        //                 `;
    return
    

                    }
                }

    } catch (error) {
            removeRow(index);
    //     console.error('Error sending email to', data.email, ':', error);
    //     showNotification(`Error sending email to ${data.email}`);
    }
} catch (error) {
        console.error('Selection process failed:', error);
    }
}




}

// async function addEmailToCampaign(campaignId, emailDetails) {
//     try {
//         const response = await fetch(`/api/campaigns/${campaignId}/add-email`, {
//             method: 'POST',
//             headers: {
//                 'Content-Type': 'application/json'
//             },
//             body: JSON.stringify(emailDetails)
//         });

//         const data = await response.json();
//         if (response.ok) {
//             console.log('Email added:', data.message);
//         } else {
//             console.error('Failed to add email:', data.message);
//         }
//     } catch (error) {
//         console.error('Error:', error);
//     }
// }

// // Example usage:
// const emailDetails = {
//     recipientEmail: 'test@example.com',
//     subject: 'Welcome Email',
//     messageId: '12345',
//     threadId: '67890',
//     sentTime: '2024-10-25T10:00:00Z',
//     status: 'sent'
// };

// addEmailToCampaign('campaign_id_here', emailDetails);



async function Campaign(campaignDetails) {
    try {
        const response = await fetch('https://server.voltmailer.com/api/campaigns/create', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(campaignDetails)
        });

        const data = await response.json();
        if (response.ok) {
            console.log('Campaign created successfully:', data.campaignId);
            return data.campaignId
        } else {
            console.error('Failed to create campaign:', data.message);
        }
    } catch (error) {
        console.error('Error:', error);
    }
}




// function calculateDelay(emailsPerHour) {
//     const cappedEmailsPerHour = Math.min(emailsPerHour, 90); // Cap at 90 emails/hour for delay calculation
//     const baseDelay = Math.ceil(3600 / cappedEmailsPerHour) * 1000; // Base delay in ms
//     const minVariance = -0.2 * baseDelay; // 20% faster than base delay
//     const maxVariance = 0.3 * baseDelay;  // 30% slower than base delay
//     return baseDelay + Math.random() * (maxVariance - minVariance) + minVariance;
// }

async function sendAllEmails() {
    // const cappedEmailsPerHour = Math.min(generatedData.length, 90); // Capped for safe pacing
    // const emailsPerHour = generatedData.length
    // let emailsSent = 0;
    // const startTime = Date.now();

    const emails = await fetchActiveMailbox(U_MyEmail);
    console.log(emails, generatedData);

    // const delay = 3000 // Adjust this based on emails/hour
    // console.log( "delay is :" ,delay , "gen data len :", generatedData.length )
    let errorOccurred = false;

    for (let index = 0; index < generatedData.length; index++) {

        // const delay = calculateDelay(cappedEmailsPerHour);
        // console.log(`Delaying next email by ${Math.round(delay)} ms`);

        await new Promise(resolve => setTimeout(resolve, 3000));

        const data = generatedData[index];
        const selectedEmail = emails[index % emails.length]; // Distribute emails across mailboxes
        
        try {
            console.log(`Sending email #${index + 1} using ${selectedEmail}`);
            await sendEmailindexwithsmtp(index, selectedEmail); // Send email
        } catch (error) {
            console.error(`Failed to send email for index ${index}:`, error);
            errorOccurred = true;
        }
        // Check if we're exceeding the hourly cap
        // const elapsedTime = Date.now() - startTime;
        // if (emailsSent >= cappedEmailsPerHour && elapsedTime < 3600000) {
        //     const waitTime = 3600000 - elapsedTime; // Wait until one hour has passed
        //     console.log(`Hourly limit reached. Waiting for ${Math.round(waitTime / 1000)} seconds.`);
        //     await new Promise(resolve => setTimeout(resolve, waitTime));
        //     emailsSent = 0; // Reset for the next hour
        // }
    }

    // Handle notifications after all emails are processed
    if (errorOccurred) {
        showNotification('Error sending one or more emails');
    } else {
        showNotification('All emails sent successfully');
    }

    // document.getElementById('pr').style.display = `none`;
    // document.getElementById('sending').style.display = 'block';
    // document.getElementById('submit').innerHTML = `
    //     <button class="button" onclick="NewCampaign()">
    //         <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 36 24">
    //             <path d="m18 0 8 12 10-8-4 20H4L0 4l10 8 8-12z"></path>
    //         </svg>
    //         New Campaign
    //     </button>
    // `;
    NewCampaign()
    sNotification('Emails are sending in background');
    console.log('All emails processed.');
}




// async function sendAllEmails() {
//     // total == generatedData.legnth
//     // get [(MailboxEmail, num)]
//     // modal = new MultiEmailDistributor();
//     // window.multiEmailDistributor.openModal();
//     emails = await fetchActiveMailbox(U_MyEmail)
//     console.log(emails)
//     // const promises = generatedData.map((_, index) => sendEmailindexwithsmtp(index, MailboxEmail));
// // Function to calculate delay based on desired emails per hour


// // Assuming you want to send 100 emails/hour:
//    const delay = calculateDelay(generatedData.length);
//     const promises = generatedData.map((data, index) => {
//         // await new Promise(resolve => setTimeout(resolve, delay)); // Simulate delay
//     // Determine which email to use based on index
//     const selectedEmail = emails[index % emails.length];
//     console.log(index, selectedEmail)
//     return sendEmailindexwithsmtp(index, selectedEmail);
// });

// await Promise.all(promises); // Wait for all emails to be sent

        // // First 10 emails
        // const firstBatch = generatedData.slice(0, 10); // Take the first 10
        // const firstBatchPromises = firstBatch.map((_, index) =>
        //     sendEmailindexwithsmtp(index, mailboxEmail)
        // );
        // await Promise.all(firstBatchPromises);
        // console.log("First batch of 10 emails sent!");

        // // Next 3 emails
        // const secondBatch = generatedData.slice(10, 13); // Take the next 3
        // const secondBatchPromises = secondBatch.map((_, index) =>
        //     sendEmailindexwithsmtp(index + 10, mailboxEmail) // Offset the index by 10
        // );
        // await Promise.all(secondBatchPromises);
        // console.log("Second batch of 3 emails sent!");

        // // Final 2 emails
        // const thirdBatch = generatedData.slice(13, 15); // Take the next 2
        // const thirdBatchPromises = thirdBatch.map((_, index) =>
        //     sendEmailindexwithsmtp(index + 13, mailboxEmail) // Offset the index by 13
        // );
        // await Promise.all(thirdBatchPromises);
        // console.log("Third batch of 2 emails sent!");





function populateEmailTable() {

    // if (!generatedData[0]) {

    //                 return;
    // }


    const tbody = document.getElementById('emailTable').getElementsByTagName('tbody')[0];

    tbody.innerHTML = "";
    // tbody.style.overflow = "auto";
    generatedData.forEach((data, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${data.email}</td>
            <td class="action-buttons">
                <button onclick="sendEmailindex(${index})" class="button-icon">Send Now</button>
                <div class="tooltipcc">
                    <button onclick="toggleDetails(${index})" class="button-iconccc" id="arrow-${index}">↓</button>
                    <span class="tooltiptext"></span>
                </div>
            </td>
        `;
        tbody.appendChild(row);

        const detailsRow = document.createElement('tr');
        detailsRow.style.display = 'none';
        detailsRow.id = `details-${index}`;
        detailsRow.innerHTML = `
            <td colspan="2">
                <div class="details">
                    <label>Subject:</label>
                    <div class="editable-container">
                        <div class="editable text-container" id="subject-display-${index}">${data.subject}</div>
                        <span class="pencil-icon" id="subject-pencil-${index}" onclick="makeEditable('subject', ${index})">✏️</span>
                    </div>
                    <label>Content:</label>
                    <div class="editable-container">
                        <div class="editable text-container" id="content-display-${index}">${data.content}</div>
                        <span class="pencil-icon" id="content-pencil-${index}" onclick="makeEditable('content', ${index})">✏️</span>
                    </div>
                </div>
            </td>
        `;
        tbody.appendChild(detailsRow);
    });
}
// else {
    // document.getElementById('pr').style.display = `none`;
        // document.getElementById('sending').style.display = 'block';
        // document.getElementById('submit').innerHTML = ` <button class="button-g" onclick="NewCampaign()" id="submit">
                        // New Campaign
                    // </button>`;
    // return;
// }
// }

// function makeEditable(field, index) {
//     const displayElement = document.getElementById(`${field}-display-${index}`);
//     const pencilIcon = document.getElementById(`${field}-pencil-${index}`);
//     const value = displayElement.innerText;

//     if (field === 'content') {
//         displayElement.innerHTML = `<textarea id="${field}-${index}" rows="4" class="details editable">${value}</textarea>`;
//     } else {
//         displayElement.innerHTML = `<input type="text" id="${field}-${index}" value="${value}" class="details editable">`;
//     }
//     document.getElementById(`${field}-${index}`).style.pointerEvents = 'auto';
    
//     pencilIcon.innerText = '✔️';
//     pencilIcon.onclick = function() { saveChanges(field, index); };
// }



function makeEditable(field, index) {
    const displayElement = document.getElementById(`${field}-display-${index}`);
    const pencilIcon = document.getElementById(`${field}-pencil-${index}`);
    const value = displayElement.innerText;

    displayElement.classList.add('edit-mode'); // Added line
    displayElement.setAttribute('contenteditable', 'true'); // Added line

    pencilIcon.innerText = '✔️';
    pencilIcon.onclick = function() { saveChanges(field, index); };
}


// function saveChanges(field, index) {
//     const inputElement = document.getElementById(`${field}-${index}`);
//     const displayElement = document.getElementById(`${field}-display-${index}`);
//     const pencilIcon = document.getElementById(`${field}-pencil-${index}`);
//     if (inputElement) {
//         displayElement.innerHTML = inputElement.value.replace(/\n/g, '<br>');
//         generatedData[index][field] = inputElement.value;
//     }
//     inputElement.style.pointerEvents = 'none';
//     pencilIcon.innerText = '✏️';
//     pencilIcon.onclick = function() { makeEditable(field, index); };
// }


function saveChanges(field, index) {
    const displayElement = document.getElementById(`${field}-display-${index}`);
    const pencilIcon = document.getElementById(`${field}-pencil-${index}`);

    displayElement.classList.remove('edit-mode'); // Added line
    displayElement.removeAttribute('contenteditable'); // Added line

    generatedData[index][field] = displayElement.innerText;
    
    pencilIcon.innerText = '✏️';
    pencilIcon.onclick = function() { makeEditable(field, index); };
}

document.addEventListener('DOMContentLoaded', function () {
  const burgerButton = document.getElementById('burger-button');
  const menuToggle = document.getElementById('menu-toggle');

  burgerButton.addEventListener('click', function () {
    menuToggle.checked = !menuToggle.checked;
  });
});



function toggleDetails(index) {
    const detailsRow = document.getElementById(`details-${index}`);
    const arrowIcon = document.getElementById(`arrow-${index}`);

    if (detailsRow.style.display === 'none' || detailsRow.style.display === '') {
        detailsRow.style.display = 'table-row';
        arrowIcon.innerHTML = '↑';
        setTimeout(() => {
            detailsRow.style.transition = 'height 0.3s ease-out, opacity 0.3s ease-out';
            detailsRow.style.height = detailsRow.scrollHeight + 'px';
            detailsRow.style.opacity = '1';
        }, 0);
    } else {
        detailsRow.style.transition = 'height 0.3s ease-out, opacity 0.3s ease-out';
        detailsRow.style.height = '0px';
        detailsRow.style.opacity = '0';
        arrowIcon.innerHTML = '↓';
        setTimeout(() => {
            detailsRow.style.display = 'none';
        }, 300);
    }
}

function removeRow(index) {
    const row = document.getElementById(`details-${index}`).previousElementSibling;
    row.remove();
    document.getElementById(`details-${index}`).remove();
    generatedData.splice(index, 1);
}

function regenerateAllEmails() {
    const tbody = document.getElementById('emailTable').getElementsByTagName('tbody')[0];
    tbody.innerHTML = "";
    generatedData = [];
    manualSend();
}

function exportToExcel() {
    // Create a new workbook and a worksheet
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.json_to_sheet(generatedData, {
        header: ["email", "subject", "content"]
    });

    // Append the worksheet to the workbook
    XLSX.utils.book_append_sheet(wb, ws, "Emails");

    // Generate a file and prompt the user to save it
    XLSX.writeFile(wb, "emails.xlsx");
}


async function CallThisWhenAutosend() {
    document.getElementById('sendAllBtn').innerHTML = `<div class="loader"></div>`;
    for (let index = 0; index < generatedData.length; index++) {
        const data = generatedData[index];
        try {
            updateRowStatus(index, 'Sending');
            const result = await sendMessage('me', data.email, data.subject, data.content);
            console.log('Message to ', data.email, ' successfully sent:', result);
            showNotification(`Message to ${data.email} successfully sent`);
            removeRow(index);
        } catch (error) {
            console.error('Error sending email to', data.email, ':', error);
            showNotification(`Error sending email to ${data.email}`);
        }
    }
    // document.getElementById('sendAllBtn').innerHTML = 'Send All';
}

// document.getElementById('sendAllBtn').addEventListener('click', CallThisWhenAutosend);
// document.getElementById('regenerateAllBtn').addEventListener('click', regenerateAllEmails);


/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
async function sendMessage(sender, to, subject, messageText, campaignId, selectedMailbox) {

    campaignid = localStorage.getItem('currentCampaignId', campaignId);

    // const token = localStorage.getItem('authToken');  https://server.voltmailer.com/send-bulk-manual 
    const response = await fetch('https://server.voltmailer.com/api/mailboxes/send', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        // body: JSON.stringify({ to: email, email: to, subject: subject, content: messageText, myemail: U_MyEmail, campaignId: campaignId, selectedMailbox: selectedMailbox })
        body: JSON.stringify({ email: U_MyEmail, to: to, subject: subject, text: messageText,  mailbox: selectedMailbox, campaignId: campaignid })
    });



    if (!response.ok) {
        throw new Error('Network response was not ok ' + response.statusText);
    }

    const result = await response.json();

    console.log('Message sent, ID:', result.id);
    return result;


}

      async function useEmails(numUsedUp) {
            // const email = document.getElementById('emailInput').value;
            // const emailsToUse = parseInt(document.getElementById('emailsToUseInput').value);

            const response = await fetch('/use_email', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ email: '{{email}}', emails_to_use: numUsedUp })
            });

            const result = await response.json();
            // alert(result.message);
            showNotification(`${result.message}`)
        }

      function sendEmails(SENT_EMAILS) {
        OutputsData.forEach(data => {
          const service = '{{ service }}'
          const message = create_message('me', data.email, data.subject, data.content)
          send_message(service, 'me', message)
          console.log('Email sent successfully!')
        })
        console.log('Emails sent successfully!')
        button.innerHTML=`Sent`
        useEmails(SENT_EMAILS);
      }


// //// MAIN STUFF
// function billing(){

// // mainContent.innerHTML = document.getElementById('billing').innerHTML;
// const url = 'https://billing.stripe.com/p/login/bIY15e8DBdSv8SY6oo';
//                     window.open(url, '_blank'); 
//         }

async function billing(stripeID, Email) {
    const response = await fetch('https://server.voltmailer.com/create-billing-portal-session', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ customerId: stripeID, email: Email })
    });

    if (response.ok) {
        const data = await response.json();
        // window.location.href = data.url;
        window.open(data.url, '_blank');

    } else {
        const errorData = await response.json();
        console.error('Error:', errorData.error);
        alert('Failed to create billing portal session: ' + errorData.error);
    }
}


       async function customerportal(){

            const customerId = UserStripeID; // Fetch this from your database or session

            const response = await fetch('https://server.voltmailer.com/create-billing-portal-session', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ customerId }),
            });

            const data = await response.json();
            console.log("data")

            if (data.url) {
                // window.location.href = data.url;
                window.open(data.url, '_blank');
            } else {
                console.error('Failed to create billing portal session:', data.error);
            }
        };


function initialize() {

    let button = document.getElementById('submit')
            total_emails = '{{ total_emails }}'
            plan = '{{ plan_emails}}'
            name = '{{ name }}'
            console.log(total_emails, '{{ name }}')

            if (total_emails == 0) {
                button.innerHTML=`                    <button class="button" onClick="billing()">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 36 24">
                          <path d="m18 0 8 12 10-8-4 20H4L0 4l10 8 8-12z"></path>
                        </svg>
                        Unlock Pro
                      </button>`
            }
            else {
                button.innerHTML=`<!-- <button class="btn">
                        <svg height="24" width="24" fill="#FFFFFF" viewBox="0 0 24 24" data-name="Layer 1" id="Layer_1" class="sparkle">
                            <path d="M10,21.236,6.755,14.745.264,11.5,6.755,8.255,10,1.764l3.245,6.491L19.736,11.5l-6.491,3.245ZM18,21l1.5,3L21,21l3-1.5L21,18l-1.5-3L18,18l-3,1.5ZM19.333,4.667,20.5,7l1.167-2.333L24,3.5,21.667,2.333,20.5,0,19.333,2.333,17,3.5Z"></path>
                        </svg>
                    
                        <span class="text">Generate</span>
                    </button> -->
                    
                    <button class="button" onclick="Submitandcheckautosend()">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 36 24">
                          <path d="m18 0 8 12 10-8-4 20H4L0 4l10 8 8-12z"></path>
                        </svg>
                        Generate
                      </button>`
            }
            showNotification(`Welcome, ${name}`)
        }
        // initialize();

function showNotification(message) {
            //   const name = "{{ name }}";
            //     const container = document.getElementById('notification-container-pop');
            //     const notification = document.createElement('div');
            //     notification.className = 'notification-pop';
                
            //     const closeButton = document.createElement('span');
            //     closeButton.className = 'close-button';
            //     closeButton.textContent = '×';
            //     closeButton.onclick = () => notification.remove();

            //     notification.appendChild(closeButton);
            //     notification.appendChild(document.createTextNode(message));

            //     container.appendChild(notification);

            //     setTimeout(() => {
            //         notification.style.opacity = 0;
            //         notification.style.transform = 'translateY(-20px)';
            //         notification.addEventListener('transitionend', () => notification.remove());
            //     }, 5000);
            };


            
    </script>
</head>
<body>
    <div class="top-bar"></div>
    <div id="notification-container-pop"></div>

    <!-- <button id="singleEmailBtn" class="btn btn-primary">Send Single Email</button> -->
        <!-- Single Email Modal -->
        <div id="singleEmailModal" class="modal-overlay-s">
            <div class="modal-s">
                <div class="modal-header-s">
                    <h2>Send Single Email</h2>
                </div>
                <div class="modal-body-s">
                    <div class="form-group-s">
                        <label for="singleMailbox">Select Mailbox</label>
                        <select id="singleMailbox" class="form-control-s">
                            <option value="">Choose a Mailbox</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer-s">
                    <button id="singleEmailCancel" class="btn-s btn-secondary-s">Cancel</button>
                    <button id="singleEmailSend" class="btn-s btn-primary-s" disabled>Send</button>
                </div>
            </div>
        </div>
<!-- 
        <div id="multiEmailModal" class="modal-overlay-m">
            <div class="modal-m">
                <div class="modal-header-m">
                    <h2>Email Distribution</h2>
                    <div id="totalEmailsIndicator" class="total-emails-indicator-m">0 Emails</div>
                </div>
    
                <div class="email-distribution-container-m" id="emailDistributionContainer">
                     Mailbox distribution will be dynamically added here 
                </div>
    
                <button id="addMailboxBtn" class="btn btn-add-mailbox-m">
                    ➕ Add Mailbox
                </button>
    
                <div class="modal-footer-m">
                    <button id="multiEmailCancel" class="btn-m btn-secondary-m">Cancel</button>
                    <button id="multiEmailSend" class="btn-m btn-primary-m" disabled>Send Emails</button>
                </div>
            </div>
        </div>
    
        <div id="addMailboxModal" class="modal-overlay-m">
            <div class="modal-m">
                <div class="modal-header-m">
                    <h2>Add New Mailbox</h2>
                </div>
                <div style="padding: 20px;">
                    <input type="text" id="mailboxNameInput" placeholder="Mailbox Name" class="mailbox-limit-input-m" style="margin-bottom: 10px;">
                    <input type="email" id="mailboxEmailInput" placeholder="Email Address" class="mailbox-limit-input-m" style="margin-bottom: 10px;">
                    <input type="number" id="mailboxLimitInput" placeholder="Email Sending Limit" class="mailbox-limit-input-m">
                    <div class="modal-footer-m" style="border-top: none; padding-top: 10px;">
                        <button id="cancelAddMailbox" class="btn-m btn-secondary-m">Cancel</button>
                        <button id="confirmAddMailbox" class="btn-m btn-primary-m">Add Mailbox</button>
                    </div>
                </div>
            </div>
        </div>
 -->


    <!-- <div class="manual-popup-overlay" id="manual-popup-overlay">
        <div class="container">
            <button style="top: 0px; left:10px; background: none; color: #000;" onclick="togglePopupManual()">X</button>
            <h2 style="align-self: center; margin-bottom: 10px;">Manual Lead Entry</h2>

              <div class="coolinput">
                <label for="input" class="text">Name:</label>
                <input type="text" placeholder="Joe Smith" name="input" class="input" id="name">
            </div>

            <div class="coolinput">
                <label for="input" class="text">Email:</label>
                <input type="text" placeholder="Example@email.com" name="input" class="input" id="emailinput">


            </div>              
            
            <div class="coolinput">
                <label for="input" class="text">Website:</label>
                <input type="text" placeholder="Voltmailer.com" name="input" class="input" id="website" >
            </div>



              <button onclick="Manual()">Submit
                <div class="arrow-wrapper">
                    <div class="arrow"></div>
                </div>
            </button>
              <div class="btn-container">

                <div class="acc-text">
                    <span style="color : #ff0000; cursor : pointer;"  id="manualError"></span>
                </div>
              </div>



         
          </div>
          
      </div> -->
      <div id="notification" class="notification"></div>

      <div id="manual-popup-overlay" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-30 p-4 hidden">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl border border-gray-200 transform transition-transform hover:scale-[1.02] relative">
            <div class="p-8">
                <button onclick="togglePopupManual()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>

                <h2 class="text-3xl font-bold text-center text-gray-800 mb-6 tracking-tight">
                    Capture Your Lead
                </h2>

                <div class="space-y-6">
                    <div>
                        <label for="name" class="block text-sm font-medium text-gray-700 mb-2">Full Name</label>
                        <input 
                            type="text" 
                            style="background-color: white !important; color: #333 !important;"
                            id="name" 
                            placeholder="Enter full name" 
                            class="w-full px-4 py-3 border bg-white border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all duration-300 text-gray-800"
                        >
                    </div>

                    <div>
                        <label for="emailinput" class="block text-sm font-medium text-gray-700 mb-2">Business Email</label>
                        <input 
                            type="email" 
                            style="background-color: white !important; color: #333 !important;"
                            id="emailinput" 
                            placeholder="you@company.com" 
                            class="w-full px-4 py-3 border bg-white border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all duration-300 text-gray-800"
                        >
                    </div>

                    <div>
                        <label for="website" class="block text-sm font-medium text-gray-700 mb-2">Company Website</label>
                        <input 
                            type="text" 
                            style="background-color: white !important; color: #333 !important;"
                            id="website" 
                            placeholder="www.yourcompany.com" 
                            class="w-full px-4 py-3 border bg-white border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all duration-300 text-gray-800"
                        >
                    </div>

                    <button 
                        onclick="Manual()" 
                        id="submitBtn"
                        class="w-full bg-purple-600 text-white py-3 rounded-lg hover:bg-purple-700 transition-all duration-300 flex items-center justify-center space-x-2 group"
                    >
                        <span>Submit Lead</span>
                        <svg class="w-5 h-5 transform group-hover:translate-x-1 transition-transform" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10.293 5.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L12.586 11H5a1 1 0 110-2h7.586l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    </button>

                    <div id="manualError" class="text-center text-red-500 mt-2 h-6"></div>
                </div>
            </div>
        </div>
    </div>

      <!-- <div class="manual-popup-overlay domain" id="manual-popup-overlay-domain">
        <div class="container">
            <button style="top: 0px; left:10px; background: none; color: #000;" onclick="togglePopupDomain()">X</button>
        <div class="center" >

            <h1 style="font-size: 20px; margin-bottom:20px;">Enter Domain to Search for Emails</h1>
            <form id="emailForm" style="display: flex;flex-direction: row;">
                <input type="text" id="domain" name="domain" placeholder="Enter domain" required style="height: 100%;">
                <button type="submit" style="margin-top: 0; height: 100%; width: 35%;"><i class="fi fi-rr-arrow-right" style="padding-left: 10px;     height: 14px; width: 14px;"></i></button>
            </form>
            <div id="results" style="color: red;"></div>

        </div> 
        </div>
        <div class="btn-container">

            <div class="acc-text">
                <span style="color : #ff0000; cursor : pointer;"  id="manualErrorm"></span>
            </div>
          </div>
      </div> -->

      <div id="manual-popup-overlay-domain" class="fixed inset-0 z-50 hidden items-center justify-center bg-black bg-opacity-30 p-4">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl border border-gray-200 p-8 relative transform transition-transform hover:scale-[1.02]">
            <button onclick="togglePopupDomain()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>

            <h2 class="text-3xl font-bold text-center text-gray-800 mb-6">Enter Domain</h2>

            <div class="space-y-4">
                <input 
                    type="text" 
                    style="background-color: white !important; color: #333 !important;"
                    id="domain" 
                    placeholder="example.com" 
                    class="w-full text-gray-800 bg-white px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600"
                >
                <button  type="submit"
                    onclick="submitDomain()"
                    class="w-full  bg-purple-600 text-white py-3 rounded-lg hover:bg-purple-700 transition flex items-center justify-center"
                >
                    Submit Domain
                    <svg class="w-5 h-5 ml-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10.293 5.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L12.586 11H5a1 1 0 110-2h7.586l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
                <div id="results" class="text-center text-red-500 h-6"></div>
            </div>
        </div>
    </div>

    <div class="sidebar">
        <div class="div">
        <div class="logo">
            <!-- <img src="Volt.png" alt="Logo"> -->
            <img  src='vmb.png' alt="google" style="width: 170px; height: 90px;">
            <!-- <div>Voltmailer</div> -->
        </div>
        <div class="menu" id="sidemenu">
            <!-- <div class="menu-item">Menu</div> -->
             <button onclick="createCampaign()" >+ New Campaign</button>
            <div class="menu-item active" id="1"><i class="fi fi-ts-house-chimney"></i>Home</div>
            <div class="menu-item" id="2"> <i class="fi fi-tr-rocket-lunch"></i>New Campaign</div>
            <div class="menu-item" id="5"> <i class="fi fi-tr-envelope-plus"></i>Mailboxes</div>
            <div class="menu-item" id="6"> <i class="fi fi-tr-inbox-in"></i>Sent Emails</div>
            <!-- <div class="menu-item" id="3" onclick="billing()"> <i class="fi fi-tr-credit-card-eye"></i> Billing</div> -->
            <!-- <div class="menu-item tools">Tools</div> -->
            <!-- <div class="menu-item" id="4" style="border-top: 1px solid #0000003a;"><i class="fi fi-tr-user-pen"></i>Account</div> -->
            <!-- <div class="menu-item end" id="5"><i class="fi fi-rr-customer-service"></i>Help</div> -->
        </div>
    </div>
        <!-- upsell ?? -->
        <!-- <div class="upsell">
            <div class="upsell-content">
                <span>Upgrade</span>
                <div class="upsell-close">
                    <span>&times;</span>
                </div>
            </div>
        </div> -->
        <!-- <div class="bottom3"> -->

            <!-- #help -->
            <!-- #setting -->
            <!-- #signout -->
        <!-- </div> -->
        <div class="menu-item logout" id="5" onclick="logout()" style=" padding-left: 0; margin-left: 0; "><i class="fi fi-tr-arrow-square-right"></i>Logout</div>
    </div>


    <div class="dashboard">


        <div class="navtop" id="mobile-nav">
            <img src="vmb.png" alt="Logo">
            
        <div class="burger">
            <!-- <img src="google.png" alt="google"> -->
<label class="popup-1">
  <input type="checkbox">
  <div class="burger" tabindex="0">
    <span></span>
    <span></span>
    <span></span>
  </div>
  <nav class="popup-window">
    <legend>Menu</legend>
    <ul>
      <li>
        <button onclick="GoHome()">
          <!-- <svg stroke-linejoin="round" stroke-linecap="round" stroke-width="2" stroke="currentColor" fill="none" viewBox="0 0 24 24" height="14" width="14" xmlns="http://www.w3.org/2000/svg">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
            <circle r="4" cy="7" cx="9"></circle>
            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
          </svg> -->
          <i class="fi fi-ts-house-chimney"></i>
          <p>Home</p>
        </button>
      </li>
      <li>
        <button onclick="createCampaign()">
          <!-- <svg stroke-linejoin="round" stroke-linecap="round" stroke-width="2" stroke="currentColor" fill="none" viewBox="0 0 24 24" height="14" width="14" xmlns="http://www.w3.org/2000/svg">
            <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
            <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
          </svg> -->
          <i class="fi fi-tr-rocket-lunch"></i>
          <p>New Campaign</p>
        </button>
      </li>
      <hr>
      <li>
        <button onclick="billing()">
          <!-- <svg stroke-linejoin="round" stroke-linecap="round" stroke-width="2" stroke="currentColor" fill="none" viewBox="0 0 24 24" height="14" width="14" xmlns="http://www.w3.org/2000/svg">
            <rect ry="2" rx="2" height="13" width="13" y="9" x="9"></rect>
            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
          </svg> -->
          <i class="fi fi-tr-credit-card-eye"></i>
          <p>Billing</p>
        </button>
      </li>
      <li>
        <button onclick="OpenAccount()">
          <!-- <svg stroke-linejoin="round" stroke-linecap="round" stroke-width="2" stroke="currentColor" fill="none" viewBox="0 0 24 24" height="14" width="14" xmlns="http://www.w3.org/2000/svg">
            <polygon points="16 3 21 8 8 21 3 21 3 16 16 3"></polygon>
          </svg> -->
          <i class="fi fi-tr-user-pen"></i>
          <p>Account</p>
        </button>

      </li>
      <hr>
      <li>
        <button id="burger-button">
          <svg stroke-linejoin="round" stroke-linecap="round" stroke-width="2" stroke="currentColor" fill="none" viewBox="0 0 24 24" height="14" width="14" xmlns="http://www.w3.org/2000/svg">
            <line y2="18" x2="6" y1="6" x1="18"></line>
            <line y2="18" x2="18" y1="6" x1="6"></line>
          </svg>
          <p>Close Menu</p>
        </button>
      </li>
    </ul>
  </nav>
</label>
        </div>
            
        </div>

        <div class="top" id="maintop">
           
            <div class="google" id="googleauthid">
                <div onclick="ConnectGoogle()" style="cursor: pointer; text-decoration: underline;"> Please connect your gmail Account</div>

                <!-- <button class="button" onclick="ConnectGoogle()">
                    <img  src='google.png' alt="google" style="height= 30px; width: 30px;">
                    Connect Google
                </button> -->

                <!-- <img  src='../static/google.png' alt="google"> -->
                <!-- {{ email }} -->
            </div>
            <!-- <div class="plan">New Campaign</div> -->
        </div>

        <div class="contentf" id="myUsage-content" style="display: none;">
            <!-- <div class="welcome-content-row">
            <div class="welcome">
            <p>Welcome </p>
            <h2 id="h2name"> </h2> 
            </div>
            <div class="buttons" id="inputButtons">

                <button class="button-man" onclick="togglePopupManual()" id="man">+ New lead</button>

                <label for="fileInput" id="uploadLabel"  > + Import leads</label>
                <input type="file" id="fileInput" accept=".xlsx,.csv" style="display: none;">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
                
            </div>
            </div> -->
            <div class="pitch-row" >
                
                <div class="content-row" >
                <span id="sending" style="display: none;">Emails are sending, you can close this tab.</span>
                    <div id="pr" >
                    
                    <!-- <div id="newContent" >
                        <h1>Your Emails</h1>
                        <table id="emailTable">
                            <thead >
                                <tr>
                                    <th>Recipient Email</th>
                                </tr>
                            </thead>
                            <tbody>
                           
                            </tbody>
                        </table>
                        <button id="regenerateAllBtn" onclick='regenerateAllEmails()'>Regenerate All Emails</button>
                        <button onclick="Restart()" >Reset</button>
                        <div class="custom-loader" id="customLoader" style="display: none;">
                            <div class="load-inner load-one"></div>
                            <div class="load-inner load-two"></div>
                            <div class="load-inner load-three"></div>
                            <span class="text" id="loaderText"></span>
                        </div>
                    </div> -->

                    <div id="newContent" style="display: none;">
                        <h1>Your Emails</h1>
                        <table id="emailTable">
                            <thead>
                                <tr>
                                    <th>Recipient Email</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Rows will be populated here -->
                            </tbody>
                            <tfoot id="tfoot">
                                <tr>
                                    <td colspan="2">
                                        <button id="regenerateAllBtn" onclick='regenerateAllEmails()'>Regenerate All Emails</button>
                                        <button onclick="NewCampaign()">Reset</button>
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                        <div class="custom-loader" id="customLoader" style="display: none;">
                            <div class="load-inner load-one"></div>
                            <div class="load-inner load-two"></div>
                            <div class="load-inner load-three"></div>
                            <span class="text" id="loaderText"></span>
                        </div>
                    </div>


                    <div id="currentContent">
                        <table id="dataTable" >
                        <div class="center" id="center">

                            <!-- <h1>Enter Domain to Search for Emails</h1>
                            <form id="emailForm">
                                <input type="text" id="domain" name="domain" placeholder="Enter domain" required>
                                <button type="submit">Get Emails</button>
                            </form>
                            <div id="results"></div> -->

                            
                         <label class="custum-file-upload" for="fileMIDDLE">
                            <div class="icon">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="" viewBox="0 0 24 24"><g stroke-width="0" id="SVGRepo_bgCarrier"></g><g stroke-linejoin="round" stroke-linecap="round" id="SVGRepo_tracerCarrier"></g><g id="SVGRepo_iconCarrier"> <path fill="" d="M10 1C9.73478 1 9.48043 1.10536 9.29289 1.29289L3.29289 7.29289C3.10536 7.48043 3 7.73478 3 8V20C3 21.6569 4.34315 23 6 23H7C7.55228 23 8 22.5523 8 22C8 21.4477 7.55228 21 7 21H6C5.44772 21 5 20.5523 5 20V9H10C10.5523 9 11 8.55228 11 8V3H18C18.5523 3 19 3.44772 19 4V9C19 9.55228 19.4477 10 20 10C20.5523 10 21 9.55228 21 9V4C21 2.34315 19.6569 1 18 1H10ZM9 7H6.41421L9 4.41421V7ZM14 15.5C14 14.1193 15.1193 13 16.5 13C17.8807 13 19 14.1193 19 15.5V16V17H20C21.1046 17 22 17.8954 22 19C22 20.1046 21.1046 21 20 21H13C11.8954 21 11 20.1046 11 19C11 17.8954 11.8954 17 13 17H14V16V15.5ZM16.5 11C14.142 11 12.2076 12.8136 12.0156 15.122C10.2825 15.5606 9 17.1305 9 19C9 21.2091 10.7909 23 13 23H20C22.2091 23 24 21.2091 24 19C24 17.1305 22.7175 15.5606 20.9844 15.122C20.7924 12.8136 18.858 11 16.5 11Z" clip-rule="evenodd" fill-rule="evenodd"></path> </g></svg>
                            </div>
                            <div class="text">
                               <span>Click to upload Csv</span>
                               </div>
                               <input type="file" id="fileMIDDLE"  accept=".csv, .xlsx, .xls, .ods, .numbers"
                               >
                            </label> 

                        </div>  
                        
                        <thead id="thead" >
                        </thead>  
                        <tbody id="tablerows">
                          
                        </tbody>
                    </table>
                </div>

                </div>
            </div>


                <div class="pitch">  
                    <div class="buttons" id="inputButtons">

                        <button class="button-man" onclick="togglePopupManual()" id="man"><div class="lead"> + New lead</div></button>
        
                        <label for="fileInput" id="uploadLabel" class="uploadLabel" ><div class="lead"> + Import leads</div></label>
                        <input type="file" id="fileInput" accept=".csv, .xlsx, .xls, .ods, .numbers"  style="display: none;">

                        <button class="uploadLabel"  onclick="exportToExcel()" id="export" style="display: none; width: 100%;"><div class="lead"> Export Generated Data  </div></button>


            <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js"></script>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
                        
                    </div>
                    <!-- <span>Or</span> -->
                    <div class="buttons" id="inputButtons">

                        <button class="button-man" onclick="togglePopupDomain()" id="DOMAIN" style="width: 100%;"><div class="lead"> + Add from Domain</div></button>      
                    </div>
                    <!-- <div class=""></div> -->
                    
                    <textarea id="userPitch" class="pitch-text" name="user_pitch"           placeholder="Enter Your Pitch Here
    Recommended:
    - Include desired outcome from Email, ect : 
        I want to get my clients on a 5 min call
    - What you do
    - Any guarntees you have"  required></textarea>
<h5>Optional</h5>
<textarea id="UserSubject" class="pitch-text" name="user_pitch" placeholder="Enter a preferred subject line..." required></textarea>
<textarea id="userTemplate" class="pitch-text" name="user_pitch" placeholder="Add an Email Template..." required></textarea>

                    <!-- <span style="text-align: left; padding-left: 10px; color: #000;"> For best results provide: </span>
                    <span style="text-align: left; padding-left: 20px;"> - Clear offer to prospect or pain-point that you are solving for them. </span>
                    <span style="text-align: left; padding-left: 20px;"> - Clear call to action the prospect should take.</span> -->
                    <div id="submit">
                        
                        <button class="button" onclick="logout()" id="submit" style="font-size: 18px; text-align: center;">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 36 24">
                              <path d="m18 0 8 12 10-8-4 20H4L0 4l10 8 8-12z"></path>
                            </svg>
                            Your Session has expired <br>Please log in again
                        </button>
                    </div>
                    <!-- <button class="button" onclick="Submitandcheckautosend()" id="submit">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 36 24">
                          <path d="m18 0 8 12 10-8-4 20H4L0 4l10 8 8-12z"></path>
                        </svg>
                        Generate
                    </button> -->


                      
                    <div class="nobg-submit" id="hidewhengenerating">
                        <div class="checkbox-wrapper-46">
                          <input type="checkbox" id="cbx-46" class="inp-cbx" onchange="checkbox()" />
                          <label for="cbx-46" class="cbx"
                            ><span>
                              <svg viewBox="0 0 12 10" height="10px" width="12px">
                                <polyline points="1.5 6 4.5 9 10.5 1"></polyline></svg></span
                            ><span> <div id="autosend-text">Autosend is <b>OFF</b></div> </span>
                          </label>
                        </div>
                        <!-- <div id="ca" onclick="reset()" class="Clear-all">Clear all</div> -->
                    </div>
                   
                </div>
            </div>
        </div>


        <div  class="contentf" id="main"   >
            <div class="pitch-row" >
                
                <div class="content-row" style="border: none; box-shadow: none; "> 

                    <div >
                        <h1 style="color: black; font-size: 40px; margin-bottom: 10px;">Home</h1>
                        <!-- <div class="title-container">
                            <h1 id="titleDisplay" class="title-display">Home</h1>
                            <input type="text" id="titleInput" class="title-input" placeholder="Edit title" />
                            
                            <span id="TeditIcon" class="icon">
                                <i class="fas fa-pencil-alt"></i>
                                <span class="tooltip">Click to edit title</span>
                            </span>
                            
                            <span id="TsaveIcon" class="icon" style="display: none;">
                                <i class="fas fa-check"></i>
                            </span>
                        </div> -->
                   
                        <h3 style="margin-block: 30px;" class="">Quick Actions  ?</h3>
                        <div  style="display: flex; align-items: center; justify-content: start; flex-direction: row; width: 95%; gap: 10px;">
                            <button class="button-man " onclick="OpenAccount()" id="man" ><div class="lead"> Account Settings</div></button>
                            <button class="button-man "  id="billing-man" ><div class="lead"> Plan Details  </div></button>
                            <button class="uploadLabel " onclick="createCampaign()" id="man"><div class="lead"> + New lead</div></button>
                        </div>
                                                     <!-- <div style=" display: flex; flex-direction: row; gap: 20px;">
                                <div class="metric">

                                    <p class="metric-label"><i class="fi fi-rr-credit-card"></i>Total Emails Used</p>
                                    <h2 class="metric-value" id="metric-label-total">11 / 1000</h2>
                                </div>
                                <div class="metric">
              
                                    <p class="metric-label"><i class="fi fi-rr-credit-card"></i>Reply Rate</p>
                                    <h2 class="metric-value" id="metric-label-rr">65%</h2>
                                </div>
                                 <div class="metric">
              
                                    <p class="metric-label"><i class="fi fi-rr-credit-card"></i>Bounce Rate</p>
                                    <h2 class="metric-value" id="metric-label-br">0%</h2>
                                </div>
                            </div>  -->
                            <div  class="reports" style="display: none;">
                            <div class="small-details-card-grid">
                                <div
                                  id="w-node-_9745c905-0e47-203d-ac6e-d1bee1ec357d-e1ec357d"
                                  class="card top-details report-card"
                                >
                                  <div class="flex-horizontal justify-space-between">
                                    <div class="flex align-center gap-column-4px">
                                      <img
                                        src="https://cdn.prod.website-files.com/670a6eaff9d5ba109641ceec/670a6eaff9d5ba109641cfd0_pageviews-icon-dashdark-webflow-template.svg"
                                        loading="eager"
                                        alt="Pageviews - Dashdark X Webflow Template"
                                        class="max-h-16px"
                                      />
                                      <div class="text-100 medium mg-top-2px">Emails Delivered</div>
                                    </div>
                                    <div class="dashdark-custom-icon details-icon"></div>
                                  </div>
                                  <div class="flex align-center gap-column-6px">
                                    <div class="display-4" id="ed">50.8K</div>
                                    <div>
                                      <!-- <div class="status-badge green">
                                        <div class="flex align-center gap-column-4px">
                                          <div class="paragraph-small">28.4%</div>
                                        </div>
                                        <div class="dashdark-custom-icon icon-size-9px"></div>
                                      </div> -->
                                    </div>
                                  </div>
                                </div>
                                <!-- <div
                                  id="w-node-_9745c905-0e47-203d-ac6e-d1bee1ec357d-e1ec357d"
                                  class="card top-details"
                                >
                                  <div class="flex-horizontal justify-space-between">
                                    <div class="flex align-center gap-column-4px">
                                      <img
                                        src="https://cdn.prod.website-files.com/670a6eaff9d5ba109641ceec/670a6eaff9d5ba109641cfd3_monthly-users-icon-dashdark-webflow-template.svg"
                                        loading="eager"
                                        alt="Monthly Users - Dashdark X Webflow Template"
                                        class="max-h-16px"
                                      />
                                      <div class="text-100 medium mg-top-2px">Reply Rate</div>
                                    </div>
                                    <div class="dashdark-custom-icon details-icon"></div>
                                  </div>
                                  <div class="flex align-center gap-column-6px">
                                    <div class="display-4" id="rr">23.6K</div>
                                    <div>
                                       <div class="status-badge red">
                                        <div class="flex align-center gap-column-4px">
                                          <div class="paragraph-small">12.6%</div>
                                        </div>
                                        <div class="dashdark-custom-icon icon-size-9px"></div>
                                      </div> 
                                    </div>
                                  </div>
                                </div> -->
                                <div
                                  id="w-node-_9745c905-0e47-203d-ac6e-d1bee1ec357d-e1ec357d"
                                  class="card top-details"
                                >
                                  <div class="flex-horizontal justify-space-between">
                                    <div class="flex align-center gap-column-4px">
                                      <img
                                        src="https://cdn.prod.website-files.com/670a6eaff9d5ba109641ceec/670a6eaff9d5ba109641cfd2_new-sign-ups-icon-dashdark-webflow-template.svg"
                                        loading="eager"
                                        alt="New Sign Ups - Dashdark X Webflow Template"
                                        class="max-h-16px"
                                      />
                                      <div class="text-100 medium mg-top-2px">Campaigns Sent</div>
                                    </div>
                                    <div class="dashdark-custom-icon details-icon"></div>
                                  </div>
                                  <div class="flex align-center gap-column-6px">
                                    <div class="display-4" id="cs">756</div>
                                    <div>
                                      <!-- <div class="status-badge green">
                                        <div class="flex align-center gap-column-4px">
                                          <div class="paragraph-small">3.1%</div>
                                        </div>
                                        <div class="dashdark-custom-icon icon-size-9px"></div>
                                      </div> -->
                                    </div>
                                  </div>
                                </div>
                                <!-- <div
                                  id="w-node-_9745c905-0e47-203d-ac6e-d1bee1ec357d-e1ec357d"
                                  class="card top-details"
                                >
                                  <div class="flex-horizontal justify-space-between">
                                    <div class="flex align-center gap-column-4px">
                                      <img
                                        src="https://cdn.prod.website-files.com/670a6eaff9d5ba109641ceec/670a6eaff9d5ba109641cfd1_subscriptions-icon-dashdark-webflow-template.svg"
                                        loading="eager"
                                        alt="Subscriptions - Dashdark X Webflow Template"
                                        class="max-h-16px"
                                      />
                                      <div class="text-100 medium mg-top-2px">Bounce Rate</div>
                                    </div>
                                    <div class="dashdark-custom-icon details-icon"></div>
                                  </div>
                                  <div class="flex align-center gap-column-6px">
                                    <div class="display-4" id="br">2.3K</div>
                                    <div>
                             
                                    </div>
                                  </div>
                                </div> -->
                              </div>
                              </div>
                        <div class="plan-usage">
                            <h2 style="margin-bottom: 5px; color: #000;">Plan: <b style="color: #5e5e5e" id="metric-label-plan">Premium</b></h2>
                            <p class="plan-usage-detail" id="plan-usage-detail">6,547 of 10,000 emails used this month</p>
                            <div class="progress-text" id="progress-text">
                              <p>Current: 6,547</p>
                              <p>Total: 1000</p>
                            </div>
                            <div class="progress-barx">
                                <div id="progressx" style="width: 57.3%;"></div>
                            </div>
                            <!-- <button class="button-man " id="subscription" >Upgrade</button> -->
                            <button  id="subscription" >Upgrade</button>
                        </div>
                        <div class="attract">
                            <div class="row-1" >
                                <h2 class="smaller-mobile" style="margin-bottom: 20px;">Attract and win customers with targeted campaigns</h2>
                                <button class="button-man" onclick="createCampaign()" id="man"><div class="lead"> + New Campaign</div></button>
                            </div>
                            <div class="mc-img">
                                <img src="mail-inbox.png" alt="" class="mailchimp">
                            </div>
                            <!-- below when we have metrics to display -->

                        </div>
                    </div>


                </div>


                <!-- <div class="pitch" style=" background: #ffffff;
                -webkit-box-shadow: 12px 12px 33px #cccccc, -12px -12px 33px #ffffff;
                box-shadow: 12px 12px 33px #cccccc, -12px -12px 33px #ffffff; display: flex; align-items: center; justify-content: start;">
                
                <h3 style="margin-top: 20px;">Your Progress</h3>
              
                <div>
                    <h2>75%</h2>
                </div>
                <div style="width: 100%; height: 1px; background-color: #5e5e5e49;"></div>

                <div style="display: flex; flex-direction: row; align-items: center; justify-content: space-between; width: 90%;">
                    <h3>Send your first Email</h3>
                    <i class="fi fi-ss-hexagon-check" id="accountTick"></i>
                </div>

                </div> -->



                <!-- <div class="pitch" style="background: #ffffff; border-radius: 16px;
                -webkit-box-shadow: 12px 12px 33px #cccccc, -12px -12px 33px #ffffff;
                box-shadow: 12px 12px 33px #cccccc, -12px -12px 33px #ffffff;
                display: flex; flex-direction: column; align-items: center; padding: 20px;">
        
                <h3 style="margin-top: 20px;">Your Progress</h3>
              
                <div id="progress-circle" style="position: relative; width: 100px; height: 100px;">
                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
                        <h2 id="progress-percentage">0%</h2>
                    </div>
                </div>
                <div style="width: 100%; height: 1px; background-color: #5e5e5e49; margin: 5px 0;"></div>
        
                <div class="task" data-task-id="1" >
                    <h3 > Send your first Email</h3>
                    <i class="fi fi-ss-hexagon" onclick="toggleDetailsx(this)" id="task-icon-1" style=" cursor: pointer; color: #5e5e5e;"></i>
                </div>
                
                <div class="task-details" data-task-id="1" style="display: none; width: 90%;">
                    <button onclick="createCampaign()">Send Email</button>
                </div>
        
                <div class="task" data-task-id="2" style="display: flex; flex-direction: row; align-items: center; justify-content: space-between; width: 90%;">
                    <h3>Create your first Campaign</h3>
                    <i class="fi fi-ss-hexagon" onclick="toggleDetailsx(this)" id="task-icon-2"></i>
                </div>
                <div class="task-details" data-task-id="2" style="display: none; width: 90%;">
                    <button onclick="createCampaign()">Create Campaign</button>
                </div>
        
                <div class="task" data-task-id="3" style="display: flex; flex-direction: row; align-items: center; justify-content: space-between; width: 90%;">
                    <h3>Edit your Username</h3>
                    <i class="fi fi-ss-hexagon" onclick="toggleDetailsx(this)" id="task-icon-3"></i>
                </div>
                <div class="task-details" data-task-id="3" style="display: none; width: 90%;">
                    <button onclick="editUsername()">Edit Username</button>
                </div>
            </div> -->
        
              
            </div>
    </div>

    <div class="contentf" id="emailTab" style="display: none;" >

        <div class="bg-gray-50 " style="height: 85vh;">
            <div class="container mx-auto py-10 px-4 max-w-20xl ">
                <!-- Header -->
                <div class="mb-8">
                    <h2 class="text-3xl font-bold">Mailbox Management</h2>
                    <p class="text-gray-600">Manage your verified mailboxes and set your active sending address</p>
                </div>
        
                <!-- Empty State -->
                <div id="emptyState" class="hidden bg-white rounded-lg shadow-sm p-8 text-center">
                    <div class="max-w-md mx-auto">
                        <svg class="w-16 h-16 mx-auto text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                        </svg>
                        <h3 class="text-lg font-semibold mb-2">No Mailboxes Added</h3>
                        <p class="text-gray-600 mb-6">Add your first mailbox to start sending emails from your verified address</p>
                        <button onclick="showAddMailboxModal()" class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 transition-colors">
                            Add Your First Mailbox
                        </button>
                    </div>
                </div>
        
                <!-- Mailbox List -->
                <div id="mailboxList" class="space-y-4">
                    <!-- Action Bar -->
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-semibold">Your Mailboxes</h3>
                        
                        <!-- <button onclick="openModalmail()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors flex items-center gap-2"> -->

                        <button onclick="showAddMailboxModal()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                            </svg>
                            Add Mailbox
                        </button>
                    </div>
        
                    <!-- Mailbox Cards -->
                    <div id="mailboxCards" class="grid gap-4 grid-cols-1 md:grid-cols-2">
                        <!-- Cards will be inserted here by JavaScript -->
                    </div>
                </div>
        
                <!-- Add Mailbox Modal -->
                <!-- <div id="addMailboxModal" class="modal">
                    <div class="bg-white rounded-lg shadow-lg p-6 max-w-md w-full mx-4">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold">Add New Mailbox</h3>
                            <button onclick="hideAddMailboxModal()" class="text-gray-400 hover:text-gray-600">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                </svg>
                            </button>
                        </div>
                        <form id="addMailboxForm" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
                                <input type="email" required class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Enter your email address">
                            </div>
                            <div class="flex justify-end gap-3">
                                <button type="button" onclick="hideAddMailboxModal()" class="px-4 py-2 border rounded-lg hover:bg-gray-50 transition-colors">
                                    Cancel
                                </button>
                                <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors">
                                    Add Mailbox
                                </button>
                            </div>
                        </form>
                    </div>
                </div> -->

                    <!-- Add Mailbox Modal -->
    <div id="addMailboxModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add New Gmail Mailbox</h2>
                <!-- <button class="close-button" onclick="initiateGoogleOAuth()"> -->
                    <button class="close-button" onclick="hideAddMailboxModal()">
                    <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
            </div>
            <form id="addMailboxForm">
                <!-- <div class="form-group">
                    <label class="form-label" for="email">Email Address</label>
                    <input type="email" id="email" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="smtpHost">SMTP Host</label>
                    <input type="text" id="smtpHost" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="smtpPort">SMTP Port</label>
                    <input type="number" id="smtpPort" class="form-input" required>
                </div> -->
                <div class="form-group">
                    <label class="form-label" for="username">Email Address</label>
                    <input type="text" id="smtpemail" class="form-input" style="background-color: white !important; color: #333 !important;" required>
                </div>
                <!-- <div class="form-group">
                    <label class="form-label" for="password">App Password</label>
                    <input type="password" id="smtppassword" class="form-input" required>
                </div> -->
                <div class="modal-footer">
                    <button type="button" class=" button-secondary" style=" padding: 10px 10px;" onclick="hideAddMailboxModal()">Cancel</button>
                    <button type="submit" class=" button-primary" style="background-color: #8320aa; padding: 10px 10px; color: white;" >Add Mailbox</button>
                </div>
            </form>
        </div>
    </div>

    <div id="mailbox-mailbox-modal" class="inset-0 z-50 flex items-center justify-center " style="display: none;">
        <div class="bg-white w-full max-w-md rounded-xl shadow-2xl p-8 relative">
            <!-- Close Button -->
            <button id="close-modal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>

            <!-- Modal Content -->
            <div class="text-center">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Connect Your Mailbox</h2>
                <p class="text-gray-600 mb-8">Choose your preferred connection method</p>

                <div class="grid grid-cols-2 gap-6">
                    <!-- Gmail Option -->
                    <button id="gmail-option" class="
                        border-2 border-transparent 
                        bg-blue-50 text-blue-600 
                        hover:border-blue-300 
                        hover:bg-blue-100 
                        rounded-lg 
                        p-6 
                        transition-all 
                        duration-300 
                        flex 
                        flex-col 
                        items-center 
                        space-y-4
                    ">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 48 48" fill="currentColor" class="text-blue-500">
                            <path fill="#4285F4" d="M45.12 24.5c0-1.56-.14-3.06-.4-4.5H24v8.51h11.84c-.51 2.75-2.06 5.08-4.42 6.64v5.52h7.16c4.18-3.85 6.54-9.53 6.54-16.17z"/>
                            <path fill="#34A853" d="M24 46c5.94 0 10.92-1.97 14.56-5.33l-7.16-5.52c-1.97 1.32-4.49 2.1-7.4 2.1-5.68 0-10.5-3.83-12.23-8.99H4.57v5.7C8.32 41.07 15.4 46 24 46z"/>
                            <path fill="#FBBC05" d="M11.77 28.26c-.48-1.45-.75-3-.75-4.6 0-1.6.27-3.15.75-4.6V13.26H4.57A21.78 21.78 0 0 0 2 24c0 3.54.85 6.89 2.37 9.86l7.4-5.6z"/>
                            <path fill="#EA4335" d="M24 9.5c3.25 0 6.18 1.12 8.47 3.3l6.36-6.36C34.91 2.91 29.93 0 24 0 15.4 0 8.32 4.93 4.57 12.14l7.2 5.6c1.73-5.16 6.55-8.74 12.23-8.74z"/>
                        </svg>
                        <span class="font-semibold">Gmail</span>
                    </button>

                    <!-- Manual Entry Option -->
                    <button id="manual-option" class="
                        border-2 border-transparent 
                        bg-gray-50 text-gray-600 
                        hover:border-gray-300 
                        hover:bg-gray-100 
                        rounded-lg 
                        p-6 
                        transition-all 
                        duration-300 
                        flex 
                        flex-col 
                        items-center 
                        space-y-4
                    ">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-500">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="3" y1="9" x2="21" y2="9"></line>
                            <line x1="9" y1="21" x2="9" y2="9"></line>
                        </svg>
                        <span class="font-semibold">Manual Entry</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
        
                <!-- Notification Toast -->
                <!-- <div id="notification" class="notification"></div> -->
            </div>
        
            
        </div>


</div>


<div class="contentf" id="mailboxTab" style="display: none;" >

    <div class="container mx-auto p-6 max-w-20xl" style="height: 85vh;">
        <!-- style="overflow-y: scroll !important;" -->


        <div class="bg-white rounded-lg " >
            <!-- Header Section -->
            <div class=" text-black p-6 flex justify-between items-center">
                <div>
                    <h1 class="text-2xl ">Sent Emails</h1>
                    <div class="flex space-x-4 mt-2" style="display: none;">
                        <div class="bg-purple-500 rounded-md p-2 text-center">
                            <span class="block text-sm font-medium">Total Emails</span>
                            <span id="totalEmailsMetric" class="text-xl font-bold">0</span>
                        </div>
                        <div class="bg-purple-500 rounded-md p-2 text-center">
                            <span class="block text-sm font-medium">Delivered</span>
                            <span id="deliveredEmailsMetric" class="text-xl font-bold">0</span>
                        </div>
                        <div class="bg-purple-500 rounded-md p-2 text-center">
                            <span class="block text-sm font-medium">Opened</span>
                            <span id="openedEmailsMetric" class="text-xl font-bold">0</span>
                        </div>
                        <div class="bg-purple-500 rounded-md p-2 text-center">
                            <span class="block text-sm font-medium">Replied</span>
                            <span id="repliedEmailsMetric" class="text-xl font-bold">0</span>
                        </div>
                        <div class="bg-purple-500 rounded-md p-2 text-center">
                            <span class="block text-sm font-medium">Bounced</span>
                            <span id="bouncedEmailsMetric" class="text-xl font-bold">0</span>
                        </div>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="exportSelectedBtn" class="bg-white/20 hover:bg-white/30 transition-colors duration-300 p-2 rounded-md text-sm font-medium">
                        Export Selected
                    </button>
                    <button id="refreshEmailsBtn" class="bg-white/20 hover:bg-white/30 transition-colors duration-300 p-2 rounded-full">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Email Search and Filter -->
            <div class="p-4 bg-gray-100 flex items-center space-x-4 rounded-lg" >
                <input 
                    type="text" 
                    id="emailSearchInput" 
                    placeholder="Search emails..." 
                    style="background-color: white !important; color: #333 !important;"
                    class="flex-grow p-2 rounded-md border border-gray-300 focus:ring-2 focus:ring-purple-500 transition-all"
                />
                <select 
                    id="emailFilterSelect" 
                    style="display: none;"
                    class="p-2 rounded-md border border-gray-300 focus:ring-2 focus:ring-purple-500"
                >
                    <option value="all">All Emails</option>
                    <option value="delivered">Delivered</option>
                    <option value="opened">Opened</option>
                    <option value="replied">Replied</option>
                    <option value="bounced">Bounced</option>
                </select>

                <select 
                    id="emailSortSelect" 
                    class="p-2 rounded-md border border-gray-300 focus:ring-2 focus:ring-purple-500"
                >
                <option value="oldest">Oldest First</option>
                    <option value="newest">Newest First</option>
                    <option value="mostRecent24h">Last 24 Hours</option>
                </select>
            </div>

            <!-- Emails Container -->
            <div id="sentEmailsContainer" class="divide-y divide-gray-200"style="overflow-y: scroll !important; height: 65vh;"  >
                <!-- Emails will be dynamically inserted here  style="overflow: scroll;" -->
            </div>
        </div>

        <!-- Reply Modal -->
        <div id="replyModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800">Reply to Email</h2>
                    <button id="closeReplyModalBtn" class="text-gray-500 hover:text-gray-800">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div id="replyModalContent" class="mb-4">
                    <!-- Original email details will be populated here -->
                </div>
                <textarea 
                    id="replyTextArea" 
                    class="w-full h-40 p-2 border rounded-md focus:ring-2 focus:ring-purple-500" 
                    placeholder="Write your reply..."
                ></textarea>
                <div class="flex justify-end space-x-3 mt-4">
                    <button id="cancelReplyBtn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">
                        Cancel
                    </button>
                    <button id="sendReplyBtn" class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700">
                        Send Reply
                    </button>
                </div>
            </div>
        </div>
    </div>

</div>


    <div  class="contentf" id="main-old"  style="display: none;">

        <div class="dashboard-usage">
            <div class="welcome-content-row">
            <div class="welcome">
              <p>Welcome </p>
              <h2 id="h2name"> HARRY</h2> 
              </div>
              </div>

            <div class="metrics">
                  <div class="metric">

                      <p class="metric-label"><i class="fi fi-rr-credit-card"></i>Total Emails Used</p>
                      <!-- <h2 class="metric-value" id="metric-label-total">11 / 1000</h2> -->
                  </div>
                  <div class="metric">

                      <p class="metric-label"><i class="fi fi-rr-credit-card"></i>Plan</p>
                      <!-- <h2 class="metric-value" id="metric-label-plan">Premium</h2> -->
                  </div>
                </div>
              <!-- </div>
              <div class="half">

              </div> -->

                
                <!-- <div class="metric">

                    <p class="metric-label"><i class="fi fi-rr-credit-card"></i>Appointments</p>
                    <h2 class="metric-value">5</h2>
                </div>
                <div class="metric">
                    <p class="metric-label"><i class="fi fi-rr-credit-card"></i>Total Sales</p>
                    <h2 class="metric-value">$148.94</h2>
                </div> -->
            


            <!-- <div class="row-2"> -->
            <div class="plan-usage">
                <!-- <p class="plan-usage-detail" id="plan-usage-detail">{{ total_emails }} of {{plan_emails}} emails / mo</p> -->
                <div class="progress-text" id="progress-text">
                  <p>Current: 2</p>
                  <p>Total: 1000</p>
                </div>
                <div class="progress-bar">
                    <div id="progress" style="width: 57.3%;"></div>
                </div>
                <!-- <button class="button-man " id="subscription" >Upgrade</button> -->
                <button  id="subscription" >Upgrade</button>
            </div>
          </div>
  </div>



    <div class="contentf"  id="myAccount-content"  style="display: none;">

        <div class="bg-gray-50" style="
            width: 100%; 
    height: 85vh;
    width: 100%;


            
            " >
            <div class="container mx-auto py-10 px-4 max-w-4xl bg-gray-50">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold">Account Settings</h2>
                    <p class="text-gray-600">Manage your account settings and preferences</p>
                </div>
        
                <!-- Tabs -->
                <div class="mb-6">
                    <div class="flex space-x-4 border-b">
                        <button class="tab active px-4 py-2 rounded-t-lg" data-tab="profile">Profile</button>
                        <button class="tab px-4 py-2 rounded-t-lg" data-tab="notifications">Notifications</button>
                        <button class="tab px-4 py-2 rounded-t-lg" data-tab="billing">Billing</button>
                    </div>
                </div>
        
                <!-- Profile Tab -->
                <div id="profile" class="tab-content active space-y-6">
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-xl font-semibold mb-4">Personal Information</h3>
                        <form id="profileForm" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-1">First Name</label>
                                    <input type="text" class="w-full p-2 border rounded" name="firstName">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">Last Name</label>
                                    <input type="text" class="w-full p-2 border rounded" name="lastName">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Email</label>
                                <input type="email" class="w-full p-2 border rounded" name="email">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Sending Name</label>
                                <input type="text" class="w-full p-2 border rounded" name="sendingName">
                            </div>
                            <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">
                                Save Changes
                            </button>
                        </form>
                    </div>
        
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-xl font-semibold mb-4">Change Password</h3>
                        <form id="passwordForm" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">Current Password</label>
                                <input type="password" class="w-full p-2 border rounded" name="currentPassword">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">New Password</label>
                                <input type="password" class="w-full p-2 border rounded" name="newPassword">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Confirm Password</label>
                                <input type="password" class="w-full p-2 border rounded" name="confirmPassword">
                            </div>
                            <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">
                                Update Password
                            </button>
                        </form>
                    </div>
                </div>
        
                <!-- Notifications Tab -->
                <div id="notifications" class="tab-content bg-white p-6 rounded-lg shadow">
                    <h3 class="text-xl font-semibold mb-4">Notification Preferences</h3>
                    <div class="space-y-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <h4 class="font-medium">Email Notifications</h4>
                                <p class="text-sm text-gray-600">Receive emails about your account activity</p>
                            </div>
                            <label class="switch">
                                <input type="checkbox" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="flex items-center justify-between">
                            <div>
                                <h4 class="font-medium">Marketing Emails</h4>
                                <p class="text-sm text-gray-600">Receive emails about new features and updates</p>
                            </div>
                            <label class="switch">
                                <input type="checkbox">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <button class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700" onclick="saveNotifications()">
                            Save Preferences
                        </button>
                    </div>
                </div>
        
                <!-- Billing Tab -->
                <div id="billing" class="tab-content bg-white p-6 rounded-lg shadow">
                    <h3 class="text-xl font-semibold mb-4">Billing Information</h3>
                    <div class="space-y-6">
                        <div>
                            <h4 class="font-medium mb-2">Payment Method</h4>
                            <div class="border p-4 rounded flex items-center justify-between">
                                <div class="flex items-center space-x-4">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                                    </svg>
                                    <div>
                                        <p>•••• •••• •••• 4242</p>
                                        <p class="text-sm text-gray-600">Expires 12/24</p>
                                    </div>
                                </div>
                                <button class="border px-4 py-2 rounded hover:bg-gray-50">Update</button>
                            </div>
                        </div>
        
                        <div>
                            <h4 class="font-medium mb-2">Billing Address</h4>
                            <form id="billingForm" class="space-y-4">
                                <input type="text" class="w-full p-2 border rounded" placeholder="Street Address">
                                <div class="grid grid-cols-3 gap-4">
                                    <input type="text" class="p-2 border rounded" placeholder="City">
                                    <input type="text" class="p-2 border rounded" placeholder="State">
                                    <input type="text" class="p-2 border rounded" placeholder="ZIP">
                                </div>
                                <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">
                                    Save Billing Info
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
        
                <!-- Notification Toast -->
                <!-- <div id="notification" class="notification"></div> -->
            </div>
   

        </div>
<!-- 
        <div class="ACC_dashboard-usage" style="overflow-y: scroll;">

            <div class="welcome-content-row">
            <div class="welcome">
              
              <h1 style="color: black; font-size: 40px; margin-bottom: 10px; margin-left: 20px;">Account Settings</h1>
              
              </div>
              </div>

    <div style="" class="cool-cont ">
        <h2 style="padding-left: 20px; padding-top: 20px;">Name</h2>
        <h4 style="padding-left: 20px;">This is the name your emails are sent from.</h4>
         <div class="coolinput" style="padding-left: 20px;">
            <input type="text" placeholder="Joe Smith" name="input" class="input" id="UPDATE_name">
        </div> 
        <h5 id="errorMessagename" style="padding-left: 10px;"></h5>
        <button class="button-man" onclick="updateNameForm()" style="margin-left: 20px;">Save</button>
        <br>
    </div>

    <div class="cool-cont">

        <h2 style="padding-left: 20px; padding-top: 20px;">Email</h2>
        <h4 style="padding-left: 20px;">The email associated with your account.</h4>
        <div class="coolinput" style="padding-left: 20px;">
            <input type="text" placeholder="Name@email.com" name="input" class="input" id="emailinput">
        </div>     
        <h5 id="errorMessageemail" style="padding-left: 20px;"></h5>         
        <button class="button-man" style="padding-left: 20px;">Save</button>
        <br>
    </div>


<div class="cool-cont">

              <h2 class="password-reset" style="margin: 20px; margin-top: 30px;">Reset Password</h2>
  
              <div class="coolinput" style="margin: 20px;">
                  <input type="text" placeholder="New Password" name="input" class="input" id="newPassword" >
              </div>
  
              <div class="coolinput" style="margin: 20px;">

                  <input type="text" placeholder="Confirm Password" name="input" class="input" id="confirmPassword" >
              </div>
              <h5 id="errorMessage"></h5>
              <button class="button-man" style="margin: 20px;">Save</button>
              <br>
            </div>
        </div> -->
  </div>


    <div id="myAccount-contentx" style="display: none;" class="contentf">
        <div class="dashboard-usage">
            <h1>Your Account</h1>
            <h4>A detailed overview of your metrics, usage, plan and more</h4>
            <h2>Name</h2>
            <h4>This is the name your emails are sent from.</h4>
            <div class="coolinput">
                <!-- <label for="input" class="text">Name:</label> -->
                <input type="text" placeholder="Joe Smith" name="input" class="input" id="UPDATE_name">
            </div>
            <h5 id="errorMessagename"></h5>
            <button id="subscription" onclick="updateNameForm()">Save</button>
            
            <h2>Email</h2>
            <h4>The Email associated with your account, not necessarily the email used to send your emails.</h4>
            <div class="coolinput">
                <!-- <label for="input" class="text">Email:</label> -->
                <input type="text" placeholder="Name@email.com" name="input" class="input" id="emailinput">
                <!-- <input placeholder="Email address" class="input" name="text" type="email" placeholder="CoolGuy1@email.com"/> -->
            </div>     
            <h5 id="errorMessageemail"></h5>         
            <button id="subscription">Save</button>
            <h2 class="password-reset">Reset Password</h2>

            <div class="coolinput">
                <input type="text" placeholder="New Password" name="input" class="input" id="newPassword" >
            </div>

            <div class="coolinput">
                <!-- <label for="input" class="text">Website:</label> -->
                <input type="text" placeholder="Confirm Password" name="input" class="input" id="confirmPassword" >
            </div>
            <h5 id="errorMessage"></h5>
            <button id="subscription">Save</button>
          </div>
  </div>

    <div id="notification-container-pop"></div>
    <script>


        // document.getElementById('fileInput').addEventListener('change', handleFile, false);


        // document.getElementById('fileMIDDLE').addEventListener('change', handleFile, false);

        // document.getElementById('emailForm').addEventListener('submit', async function(event) {
        //     event.preventDefault();
        //     let domain = document.getElementById('domain').value;
        //     let newDomain = domain
        //     if (!/^https:\/\//i.test(domain)) {
        //          newDomain = 'https://' + domain;
        //     }
        //     domain = domain.replace(/^https?:\/\//, '');

        //     try {
        //         const response = await fetch(`https://server.voltmailer.com/get-emails?domain=${encodeURIComponent(domain)}`);
        //         const data = await response.json();
                
        //         if (data.data && data.data.emails) {
        //             const emails = data.data.emails;
        //             if (emails.length > 0){
        //             emails.forEach(item => {

        //                 const formData = {
        //                     email: item.value,
        //                     website: newDomain,
        //                     name: item.first_name || '' // Fallback in case first_name is not provided
        //                 };
        //                 submittedData.push(formData);
        //             });
        //             document.getElementById('manual-popup-overlay-domain').style.display = 'none';
        //             updateTable()
        //             console.log("found")
        //         }
        //         else
        //         {
        //             document.getElementById('results').textContent = 'No emails found or an error occurred.'; 
        //         }
        //         } else {
        //             document.getElementById('results').textContent = 'No emails found or an error occurred.';
        //         }
        //     } catch (error) {
        //         console.error('Error:', error);
        //         document.getElementById('results').textContent = 'An error occurred while fetching emails.';
        //     }
        // });
        class SentEmailsManager {
            constructor(containerElement, emails) {
                this.container = containerElement;
                this.emails = emails.map(email => ({
                    ...email
                }));
                this.filteredEmails = this.emails;
                this.selectedEmails = new Set();
                this.initializeEventListeners();
                this.render();
                this.updateMetrics();
            }

            // generateRandomStatus() {
            //     const statuses = ['delivered', 'opened', 'replied', 'bounced'];
            //     const randomStatus = statuses[Math.floor(Math.random() * statuses.length)];
            //     return {
            //         delivered: Math.random() > 0.1,
            //         opened: Math.random() > 0.3,
            //         replied: Math.random() > 0.5,
            //         bounced: Math.random() < 0.1,
            //         primaryStatus: randomStatus
            //     };
            // }

            initializeEventListeners() {

                // Search input listener
                const searchInput = document.getElementById('emailSearchInput');
                searchInput.addEventListener('input', () => this.filterEmails(searchInput.value));

                // Filter select listener
                const filterSelect = document.getElementById('emailFilterSelect');
                filterSelect.addEventListener('change', () => this.filterEmailsByStatus(filterSelect.value));

                // Sort select listener
                const sortSelect = document.getElementById('emailSortSelect');
                sortSelect.addEventListener('change', () => this.sortEmails(sortSelect.value));

                // Refresh button listener
                const refreshBtn = document.getElementById('refreshEmailsBtn');
                refreshBtn.addEventListener('click', () => this.refreshEmails());

                // Export selected emails listener
        const exportBtn = document.getElementById('exportSelectedBtn');
        if (exportBtn) {
            exportBtn.addEventListener('click', () => this.exportSelectedEmails());
        }

                // Reply modal listeners
                this.setupReplyModalListeners();
            }

            setupReplyModalListeners() {
                const replyModal = document.getElementById('replyModal');
                const closeModalBtn = document.getElementById('closeReplyModalBtn');
                const cancelReplyBtn = document.getElementById('cancelReplyBtn');
                const sendReplyBtn = document.getElementById('sendReplyBtn');
                const refreshBtn = document.getElementById('refreshEmailsBtn');


                refreshBtn.addEventListener('click', () => this.refreshEmails());
                closeModalBtn.addEventListener('click', () => this.toggleReplyModal());
                cancelReplyBtn.addEventListener('click', () => this.toggleReplyModal());
                sendReplyBtn.addEventListener('click', () => this.sendReply());
            }

            toggleReplyModal(email = null) {
                const replyModal = document.getElementById('replyModal');
                const modalContent = document.getElementById('replyModalContent');
                const replyTextArea = document.getElementById('replyTextArea');

                replyModal.classList.toggle('hidden');
                replyModal.classList.toggle('flex');

                if (email) {
                    modalContent.innerHTML = `
                        <div class="bg-gray-100 p-4 rounded-md mb-4">
                            <div class="font-bold text-purple-600">To: ${email.recipient}</div>
                            <div class="text-gray-700">Subject: Re: ${email.subject}</div>
                            <div class="text-gray-600 mt-2">${email.body}</div>
                        </div>
                    `;
                    replyTextArea.value = '';
                    replyTextArea.dataset.emailId = email.id;
                }
            }

            sendReply() {
                const replyTextArea = document.getElementById('replyTextArea');
                const replyText = replyTextArea.value.trim();
                const originalEmailId = replyTextArea.dataset.emailId;

                if (replyText) {
                    // In a real app, this would send the reply via backend
                    console.log('Sending reply:', {
                        originalEmailId,
                        replyText
                    });

                    // Update email status to replied
                    const emailToUpdate = this.emails.find(email => email.id === originalEmailId);
                    if (emailToUpdate) {
                        // emailToUpdate.status.replied = true;
                        emailToUpdate.status = 'replied';
                    }

                    this.toggleReplyModal();
                    this.render();
                    this.updateMetrics();
                }
            }

            render() {
                this.container.innerHTML = '';
                this.filteredEmails.forEach(email => {
                    const emailRow = this.createEmailRow(email);
                    this.container.insertAdjacentHTML('beforeend', emailRow);
                });
            }

            filterEmails(searchTerm) {
                this.filteredEmails = this.emails.filter(email => 
                    email.recipient.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    email.subject.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    email.body.toLowerCase().includes(searchTerm.toLowerCase())
                );
                this.render();
            }

            filterEmailsByStatus(status) {
                if (status === 'all') {
                    this.filteredEmails = this.emails;
                } else {
                    this.filteredEmails = this.emails.filter(email => 
                        email.status[status]
                    );
                }
                this.render();
            }

            sortEmails(sortType) {
    switch(sortType) {
        case 'newest':
            this.filteredEmails.sort((a, b) => new Date(b.date) - new Date(a.date));
            break;
        case 'oldest':
            this.filteredEmails.sort((a, b) => new Date(a.date) - new Date(b.date));
            break;
        case 'mostRecent24h':
            const twentyFourHoursAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);
            this.filteredEmails = this.emails.filter(email => {
                const emailDate = new Date(email.date);
                return emailDate >= twentyFourHoursAgo;
            }).sort((a, b) => new Date(b.date) - new Date(a.date));
            break;
        default:
            // Keep original order or handle unexpected sort type
            this.filteredEmails = [...this.emails];
    }
    this.render();
}

            updateMetrics() {
                const totalEmails = this.emails.length;
                const deliveredEmails = this.emails.filter(email => email.status.delivered).length;
                const openedEmails = this.emails.filter(email => email.status.opened).length;
                const repliedEmails = this.emails.filter(email => email.status.replied).length;
                const bouncedEmails = this.emails.filter(email => email.status.bounced).length;

                document.getElementById('totalEmailsMetric').textContent = totalEmails;
                document.getElementById('deliveredEmailsMetric').textContent = deliveredEmails;
                document.getElementById('openedEmailsMetric').textContent = openedEmails;
                document.getElementById('repliedEmailsMetric').textContent = repliedEmails;
                document.getElementById('bouncedEmailsMetric').textContent = bouncedEmails;
            }

            createEmailRow(email) {
                // Status color mapping
                const statusColors = {
                    delivered: 'text-green-600',
                    opened: 'text-blue-600',
                    replied: 'text-purple-600',
                    bounced: 'text-red-600'
                };

                return `
                    <div class="email-row hover:bg-purple-50 transition-colors duration-200 flex items-center" data-email-id="${email.id}">
                        <div class="p-2">
                            <input 
                                type="checkbox" 
                                class="email-checkbox form-checkbox h-5 w-5 text-purple-600 rounded"
                                onclick="sentEmailsManager.toggleEmailSelection('${email.id}')"
                            >
                        </div>
                        <div class="flex-grow cursor-pointer" onclick="toggleEmailDetails('${email.id}')">
                            <div class="flex items-center justify-between p-4">
                                <div class="flex-grow">
                                    <div class="flex items-center space-x-3">
                                        <span class="font-medium text-gray-800 truncate max-w-md">
                                            <span class="text-purple-600">${email.recipient}</span> 
                                            - ${email.subject}
                                        </span>
                                        <span class="text-sm ${statusColors[email.status]} font-medium">
                                            ${email.status}
                                        </span>
                                        <span class="text-sm text-gray-500">${email.date}</span>
                                        <span class="ml-2 text-gray-500 text-sm">(click to expand)</span>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <button 
                                        onclick="sentEmailsManager.openReplyModal('${email.id}')" 
                                        class="text-purple-600 hover:text-purple-800 focus:outline-none"
                                    >
                                        <svg xmlns="http://www.w3.org/22000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                    </svg>
                                </div>
                            </div>
                            <div id="email-details-${email.id}" class="hidden p-4 bg-gray-50 text-sm text-gray-700">
                                ${email.body}
                            </div>
                        </div>
                    </div>
                `;
            }

            openReplyModal(emailId) {
                const email = this.emails.find(e => e.id === emailId);
                if (email) {
                    this.toggleReplyModal(email);
                }
            }

            toggleEmailDetails(emailId) {
                const detailsElement = document.getElementById(`email-details-${emailId}`);
                detailsElement.classList.toggle('hidden');
            }

            toggleEmailSelection(emailId) {
                const checkbox = document.querySelector(`[data-email-id="${emailId}"] .email-checkbox`);
                if (checkbox.checked) {
                    this.selectedEmails.add(emailId);
                } else {
                    this.selectedEmails.delete(emailId);
                }
            }

exportSelectedEmails() {
        const selectedEmailsData = this.emails.filter(email => 
            this.selectedEmails.has(email.id)
        );

        if (selectedEmailsData.length === 0) {
            if (typeof sNotification === 'function') {
                sNotification('No emails selected to export', 'warning');
            }
            return;
        }

        this.createExportModal(selectedEmailsData);
    }

    createExportModal(selectedEmailsData) {
        // Create modal HTML
        const modal = document.createElement('div');
        modal.innerHTML = `
            <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                <div class="bg-white rounded-lg p-6 max-w-md w-full">
                    <h2 class="text-xl font-bold mb-4">Export Selected Emails</h2>
                    <p class="mb-4">Selected ${selectedEmailsData.length} email(s). Choose export format:</p>
                    <div class="space-y-2">
                        <button id="exportCSVBtn" class="w-full bg-purple-600 text-white py-2 rounded hover:bg-purple-700">
                            Export as CSV
                        </button>
                        <button id="exportJSONBtn" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700">
                            Export as JSON
                        </button>
                        <button id="exportTextBtn" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700">
                            Export as Plain Text
                        </button>
                        <button id="cancelExportBtn" class="w-full bg-gray-200 text-gray-800 py-2 rounded hover:bg-gray-300">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>
        `;

        // Add to body
        document.body.appendChild(modal);
                // Bind event listeners with context
                const exportCSVBtn = document.getElementById('exportCSVBtn');
        const exportJSONBtn = document.getElementById('exportJSONBtn');
        const exportTextBtn = document.getElementById('exportTextBtn');
        const cancelExportBtn = document.getElementById('cancelExportBtn');

        const handleCSVExport = () => {
            this.exportToCSV(selectedEmailsData);
            document.body.removeChild(modal);
        };

        const handleJSONExport = () => {
            this.exportToJSON(selectedEmailsData);
            document.body.removeChild(modal);
        };

        const handleTextExport = () => {
            this.exportToPlainText(selectedEmailsData);
            document.body.removeChild(modal);
        };

        exportCSVBtn.addEventListener('click', handleCSVExport);
        exportJSONBtn.addEventListener('click', handleJSONExport);
        exportTextBtn.addEventListener('click', handleTextExport);
        cancelExportBtn.addEventListener('click', () => {
            document.body.removeChild(modal);
        });
    }

    exportToCSV(selectedEmailsData) {
        // Define headers
        const headers = ['ID', 'Recipient', 'Subject', 'Date', 'Status', 'Body'];
        
        // Convert emails to CSV rows
        const csvRows = selectedEmailsData.map(email => [
            `"${email.id}"`,
            `"${email.recipient}"`,
            `"${email.subject.replace(/"/g, '""')}"`,
            `"${email.date}"`,
            `"${email.status}"`,
            `"${email.body.replace(/"/g, '""')}"`,
        ]);

        // Combine headers and rows
        const csvContent = [
            headers.join(','),
            ...csvRows.map(row => row.join(','))
        ].join('\n');

        // Create and trigger download
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        this.downloadBlob(blob, `exported_emails_${new Date().toISOString().split('T')[0]}.csv`);
    }

    exportToJSON(selectedEmailsData) {
        const jsonContent = JSON.stringify(selectedEmailsData, null, 2);
        const blob = new Blob([jsonContent], { type: 'application/json;charset=utf-8;' });
        this.downloadBlob(blob, `exported_emails_${new Date().toISOString().split('T')[0]}.json`);
    }

    exportToPlainText(selectedEmailsData) {
        const textContent = selectedEmailsData.map(email => 
            `ID: ${email.id}
Recipient: ${email.recipient}
Subject: ${email.subject}
Date: ${email.date}
Status: ${email.status}

Body:
${email.body}
---
`).join('\n');

        const blob = new Blob([textContent], { type: 'text/plain;charset=utf-8;' });
        this.downloadBlob(blob, `exported_emails_${new Date().toISOString().split('T')[0]}.txt`);
    }

    downloadBlob(blob, filename) {
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        
        link.setAttribute('href', url);
        link.setAttribute('download', filename);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        // Clean up the URL object
        URL.revokeObjectURL(url);
    }


            async refreshEmails() {
        try {
            console.log("Refreshing mailboxes");
            const response = await fetch(`https://server.voltmailer.com/api/emails?email=${U_MyEmail}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                }
            });

            const emailsfound = await response.json();
            
            if (response.ok) {
                console.log("Found new emails", emailsfound);
                
                // Update emails
                this.emails = emailsfound;
                this.filteredEmails = emailsfound;
                
                // Re-render and update metrics
                this.render();
                this.updateMetrics();
                
                // Optional: Show a success notification if sNotification is available
                if (typeof sNotification === 'function') {
                    sNotification('Emails refreshed successfully', 'success');
                }
            } else {
                throw new Error(emailsfound.message || 'Failed to refresh mailboxes');
            }
        } catch (error) {
            console.error('Error refreshing mailboxes:', error);
            
            // Optional: Show an error notification if sNotification is available
            if (typeof sNotification === 'function') {
                sNotification('Error refreshing mailboxes: ' + error.message, 'error');
            }
        }
    }

            render() {
                this.container.innerHTML = this.filteredEmails
                    .map(email => this.createEmailRow(email))
                    .join('');
            }
        }


        async function submitDomain(){
            let domain = document.getElementById('domain').value;
            let newDomain = domain
            if (!/^https:\/\//i.test(domain)) {
                 newDomain = 'https://' + domain;
            }
            domain = domain.replace(/^https?:\/\//, '');

            try {
                const response = await fetch(`https://server.voltmailer.com/get-emails?domain=${encodeURIComponent(domain)}`);
                const data = await response.json();
                
                if (data.data && data.data.emails) {
                    const emails = data.data.emails;
                    if (emails.length > 0){
                    emails.forEach(item => {

                        const formData = {
                            email: item.value,
                            website: newDomain,
                            name: item.first_name || '' // Fallback in case first_name is not provided
                        };
                        submittedData.push(formData);
                    });
                    document.getElementById('manual-popup-overlay-domain').style.display = 'none';
                    updateTable()
                    console.log("found")
                }
                else
                {
                    document.getElementById('results').textContent = 'No emails found or an error occurred.'; 
                }
                } else {
                    document.getElementById('results').textContent = 'No emails found or an error occurred.';
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('results').textContent = 'An error occurred while fetching emails.';
            }
        };
        // Function to handle tab switching

        function OpenAccount() {
            // Example logic for createCampaign
            console.log('Creating campaign...');
            // Simulate a click on the 'Usage' tab (id 2)
            const usageTab = document.getElementById('4');
            usageTab.click();
        }
        function createCampaign() {
            // Example logic for createCampaign
            console.log('Creating campaign...');
            // Simulate a click on the 'Usage' tab (id 2)
            const usageTab = document.getElementById('2');
            usageTab.click();
        }
        function GoHome() {
            // Example logic for createCampaign
            // console.log('Creating campaign...');
            // Simulate a click on the 'Usage' tab (id 2)
            const usageTab = document.getElementById('1');
            usageTab.click();
        }
        
        function OpenMailboxes(){
            const usageTab = document.getElementById('5');
            usageTab.click();
        }


        function switchTab(event) {
            // Remove active class from all menu items
            const menuItems = document.querySelectorAll('.menu-item');
            menuItems.forEach(item => item.classList.remove('active'));

            // Add active class to the clicked menu item
            event.currentTarget.classList.add('active');

            // Get the content div
            // const contentDiv = document.querySelector('.content');


            // Clear current content
            // contentDiv.innerHTML = '';

            // Get the id of the clicked menu item
            const id = event.currentTarget.id;
            console.log(id)

            // Switch content based on the clicked menu item
            switch (id) {
                case '1':
                    console.log('1')
                    document.getElementById('myAccount-content').style.display = 'none';
                    document.getElementById('myUsage-content').style.display = 'none';
                    document.getElementById('main').style.display = 'block';
                    // document.getElementById('maintop').style.display = 'flex';
                    // contentDiv.innerHTML = '<h2>Home Content</h2><p>This is the home page content.</p>';
                    document.getElementById('emailTab').style.display = 'none'; 
                    document.getElementById('mailboxTab').style.display = 'none'; 

                    break;
                case '2':
                console.log('2')  
                    document.getElementById('myUsage-content').style.display = 'flex';
                    document.getElementById('myAccount-content').style.display = 'none';
                    document.getElementById('main').style.display = 'none';
                    // document.getElementById('maintop').style.display = 'none';
                    // contentDiv.innerHTML = '<h2>Usage Content</h2><p>This is the usage page content.</p>';
                    document.getElementById('emailTab').style.display = 'none'; 
                    document.getElementById('mailboxTab').style.display = 'none'; 

                    break;
                case '3':
                    // contentDiv.innerHTML = '<h2>Billing Content</h2><p>This is the billing page content.</p>';
                    // document.getElementById('emailTab').style.display = 'none'; 
                    break;
                case '4':
                    document.getElementById('myAccount-content').style.display = 'flex'; 
                    document.getElementById('myUsage-content').style.display = 'none';
                    document.getElementById('main').style.display = 'none';
                    document.getElementById('emailTab').style.display = 'none'; 
                    document.getElementById('mailboxTab').style.display = 'none'; 

                    // document.getElementById('maintop').style.display = 'none';
                    // contentDiv.innerHTML = '<h2>Account Content</h2><p>This is the account page content.</p>';
                    break;
                case '5':
                    // contentDiv.innerHTML = '<h2>Help Content</h2><p>This is the help page content.</p>';
                    document.getElementById('emailTab').style.display = 'block'; 
                    document.getElementById('myAccount-content').style.display = 'none'; 
                    document.getElementById('myUsage-content').style.display = 'none';
                    document.getElementById('main').style.display = 'none';
                    document.getElementById('mailboxTab').style.display = 'none'; 
                    updateUI();
                    break;
                case '6':
                document.getElementById('emailTab').style.display = 'none'; 
                    document.getElementById('myAccount-content').style.display = 'none'; 
                    document.getElementById('myUsage-content').style.display = 'none';
                    document.getElementById('main').style.display = 'none';
                    document.getElementById('mailboxTab').style.display = 'block'; 
                    // const sentEmailsContainer = document.getElementById('sentEmailsContainer');
                    // const sentEmailsManager = new SentEmailsManager(sentEmailsContainer, sampleEmails);
                    sentEmailsManager.refreshEmails();
                default:
                    // contentDiv.innerHTML = '<h2>Home Content</h2><p>This is the default home page content.</p>';
            }
        }

        // Attach event listeners to menu items
        const menuItems = document.querySelectorAll('.menu-item');
        menuItems.forEach(item => {
            item.addEventListener('click', switchTab);
        });

        // const menuToggle = document.getElementById('mobile-menu');
        // const navLinks = document.querySelector('.nav-links');

        // menuToggle.addEventListener('click', () => {
        //     menuToggle.classList.toggle('active');
        //     navLinks.classList.toggle('active');
        // });




    async function updateNameForm(){

        console.log("name", U_MyEmail)
    const name = document.getElementById('UPDATE_name').value;
    console.log(name, U_MyEmail)
    // const email = prompt('Please enter your email to update your name:');
    const errorMessages = document.getElementById('errorMessagename');

    errorMessages.innerHTML = '';

    try {
        const response = await fetch('https://server.voltmailer.com/update-customer-by-email', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                email: U_MyEmail,
                updateField: 'name',
                newData: name
            }),
        });

        const data = await response.json();
        
        if (response.ok) {
            errorMessages.innerHTML = `<p>${data.message}</p>`;
            init()
        } else {
            errorMessages.innerHTML = `<p>Error: ${data.message}</p>`;
        }
    } catch (error) {
        console.error('Error:', error);
        errorMessages.innerHTML = '<p>An error occurred while updating the name.</p>';
    }
};

async function updateEmailForm(){
    console.log("email")
    const name = document.getElementById('emailinput').value;
    // const email = prompt('Please enter your email to update your name:');
    const errorMessages = document.getElementById('errorMessageemail');

    errorMessages.innerHTML = '';

    try {
        const response = await fetch('https://server.voltmailer.com/update-customer-by-email', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                email: U_MyEmail,
                updateField: 'email',
                newData: name
            }),
        });

        const data = await response.json();
        
        if (response.ok) {
            errorMessages.innerHTML = `<p>${data.message}</p>`;
            init()
        } else {
            errorMessages.innerHTML = `<p>Error: ${data.message}</p>`;
        }
    } catch (error) {
        console.error('Error:', error);
        errorMessages.innerHTML = '<p>An error occurred while updating the name.</p>';
    }
};
    async function updatePasswordForm() {
        console.log("password")
    const password = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    // const email = prompt('Please enter your email to update your password:');
    const errorMessages = document.getElementById('errorMessages');

    errorMessages.innerHTML = '';

    if (password !== confirmPassword) {
        errorMessages.innerHTML += '<p>Passwords do not match.</p>';
        return;
    }

    if (password.length <= 5) {
        errorMessages.innerHTML += '<p>Password must be longer than 5 characters.</p>';
        return;
    }

    if (!/[A-Z]/.test(password)) {
        errorMessages.innerHTML += '<p>Password must contain at least one uppercase letter.</p>';
        return;
    }

    if (!/\d/.test(password)) {
        errorMessages.innerHTML += '<p>Password must contain at least one number.</p>';
        return;
    }

    try {
        const response = await fetch('https://server.voltmailer.com/update-customer-by-email', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                email: U_MyEmail,
                updateField: 'password',
                newData: password
            }),
        });

        const data = await response.json();
        
        if (response.ok) {
            errorMessages.innerHTML = `<p>${data.message}</p>`;
            init()
        } else {
            errorMessages.innerHTML = `<p>Error: ${data.message}</p>`;
        }
    } catch (error) {
        console.error('Error:', error);
        errorMessages.innerHTML = '<p>An error occurred while updating the password.</p>';
    }
};


async function initiateGoogleOAuth() {
    const urlParams = new URLSearchParams(window.location.search);
    var token  = urlParams.get('token');        
    if (token){
        localStorage.setItem('token', token);
    }

        const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?` +
          `client_id=${GOOGLE_OAUTH_CONFIG.clientId}` +
          `&redirect_uri=${encodeURIComponent(GOOGLE_OAUTH_CONFIG.redirectUri)}` +
          `&response_type=code` +
          `&access_type=offline` + // Important for getting refresh token
          `&prompt=consent` + // Force consent screen to get refresh token
          `&scope=${encodeURIComponent(GOOGLE_OAUTH_CONFIG.scopes.join(' '))}`;

        window.location.href = authUrl;
      }
    
      window.onload = function () {
      // Check for OAuth callback
      const urlParams = new URLSearchParams(window.location.search);
      const authCode = urlParams.get('code');
      var token = urlParams.get('token');
      if(!authCode){
      if(!token){
            token = localStorage.getItem('token', token);
      window.location.href = `https://www.voltmailer.com/Dashboard?token=${token}&code=${authCode}`;
      }
      }

      if (authCode) {
      if (!token) {

      token = localStorage.getItem('token', token);
      window.location.href = `https://www.voltmailer.com/Dashboard?token=${token}&code=${authCode}`;
} else{


        // Handle OAuth callback
        addGoogleAccount(authCode)
          .then(() => {
            // Clear URL parameters to prevent re-processing
            window.history.replaceState({}, document.title, window.location.pathname);
            
          })
          .catch(error => {
            alert('Failed to add account: ' + error.message);
          });

}

      }
    };

    async function addGoogleAccount(code) {
        try {
          // Exchange authorization code for tokens
          const tokenResponse = await axios.post('https://oauth2.googleapis.com/token', {
            client_id: GOOGLE_OAUTH_CONFIG.clientId,
            client_secret: GOOGLE_OAUTH_CONFIG.clientSecret,
            code: code,
            grant_type: 'authorization_code',
            redirect_uri: GOOGLE_OAUTH_CONFIG.redirectUri
          });

          // Fetch user info
          const userInfoResponse = await axios.get(
            `https://www.googleapis.com/oauth2/v1/userinfo?alt=json&access_token=${tokenResponse.data.access_token}`
          );

          // Create account object
          const newAccount = {
            id: `gmail_${userInfoResponse.data.email}_${Date.now()}`,
            provider: 'gmail',
            email: userInfoResponse.data.email,
            accessToken: tokenResponse.data.access_token,
            refreshToken: tokenResponse.data.refresh_token,
            expiresAt: Date.now() + (tokenResponse.data.expires_in * 1000)
          };

          const formData = {
                email: "exe@gmail.com",
                smtpHost: "gmail",
                smtpPort: "586",
                username: userInfoResponse.data.email,
                password: 'null',
                gmail: newAccount
            };
                    addMailbox(formData);
          // Add to accounts and save
        //   this.accounts.push(newAccount);
        //   this.saveAccounts();

          // Select the newly added account
        //   this.selectedAccount = newAccount;

          return newAccount;
        } catch (error) {
          console.error('Failed to add Google account:', error);
          throw error;
        }
      }

document.getElementById('addMailboxForm').addEventListener('submit', async (e) => {
    e.preventDefault();
        // const formData = {
        //         email: document.getElementById('email').value,
        //         smtpHost: document.getElementById('smtpHost').value,
        //         smtpPort: document.getElementById('smtpPort').value,
        //         username: document.getElementById('username').value,
        //         password: document.getElementById('password').value,
        //     };
        const newAccount = {
            id: 'ghdfgd',
            provider: 'dffgdfgc',
            email: 'fgdfg',
            accessToken: 'xvcvcx',
            refreshToken: 'crtefgfdrtfdx',
            expiresAt: 1
          };

          const formData = {
                email: "exe@gmail.com",
                smtpHost: "gmail",
                smtpPort: "mailjet",
                username: document.getElementById('smtpemail').value,
                password: 'null',
                gmail: newAccount
            };

            // Show loading state
            const submitButton = event.target.querySelector('button[type="submit"]');
            const originalText = submitButton.innerHTML;
            submitButton.innerHTML = 'Verifying...';
            submitButton.disabled = true;

            try {
                // const result = await verifySmtpDetails(formData);
                
                // if (result.success) {
                    submitButton.innerHTML = 'Verified';
                    addMailbox(formData);
                    hideAddMailboxModal();

                    // const newMailbox = {
                    //     id: Date.now().toString(),
                    //     ...formData,
                    //     verified: false
                    // };

                    // mailboxes.push(newMailbox);
                    
                    // // If this is the first mailbox, make it active once verified
                    // if (mailboxes.length === 1) {
                    //     activeMailboxId = newMailbox.id;
                    // }

                    // closeModal();
                    // renderMailboxes();

                    // // Simulate verification after 3 seconds
                    // setTimeout(() => {
                    //     const mailbox = mailboxes.find(m => m.id === newMailbox.id);
                    //     if (mailbox) {
                    //         mailbox.verified = true;
                    //         renderMailboxes();
                    //     }
                    // }, 3000);
                // }
            } catch (error) {
                alert('Failed to verify SMTP details. Please check your inputs and try again.');
            } finally {
                submitButton.innerHTML = originalText;
                submitButton.disabled = false;
            }

        // addMailbox(email);
        // hideAddMailboxModal();

    });




const formatMailboxData = (formData) => {
    return {
        smtp: {
            host: formData.smtpHost,  // The SMTP server host (e.g., smtp.example.com)
            port: parseInt(formData.smtpPort),  // The SMTP server port (e.g., 465)
            secure: formData.smtpPort === '465', // Assuming secure for 465, else false (can be adjusted)
            user: formData.username,  // The SMTP username (e.g., email@example.com)
            pass: formData.password   // The SMTP password
        },
        // isActive can be omitted here, as it's set on the server side
    };
};



        async function verifySmtpDetails(details) {
            try {
                const smtpDetails = formatMailboxData(details)

                console.log(smtpDetails)

                emails = await fetchActiveMailbox(U_MyEmail)
                console.log(emails)
                let unique = true
                emails.forEach(email => {
                    if (email = details.username){
                        sNotification('Failed to add mailbox : Account already exists');
                        unique = false
                        return;
                    }

                })

                if (unique) {

                    const response = await fetch('https://server.voltmailer.com/verify-smtp', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(smtpDetails),
        });

        const result = await response.json();

        if (!response.ok) {
            sNotification('Failed to add mailbox');
            throw new Error(result.message || 'Failed to verify SMTP details');
        }

        return { success: true, message: 'SMTP details verified successfully' };
                } else {
                    return { success: false, message: 'Account already exists' };
                }


    } catch (error) {
        sNotification('Failed to add mailbox');
        console.error('Error verifying SMTP details:', error);
        return { 
            success: false, 
            message: error.message || 'Error verifying SMTP details',
            details: error.response || null // Add more context if available
        };
    }
};

// Tab Switching
                    const tabs = document.querySelectorAll('.tab');
                const tabContents = document.querySelectorAll('.tab-content');
        
                tabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        const tabId = tab.dataset.tab;
                        
                        // Update active tab
                        tabs.forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        
                        // Show active content
                        tabContents.forEach(content => {
                            content.classList.remove('active');
                            if (content.id === tabId) {
                                content.classList.add('active');
                            }
                        });
                    });
                });
        

        
                document.getElementById('profileForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    // Add your API call here
                    sNotification('Profile updated successfully');
                });
        
                document.getElementById('passwordForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const newPassword = e.target.newPassword.value;
                    const confirmPassword = e.target.confirmPassword.value;
        
                    if (newPassword !== confirmPassword) {
                        sNotification('Passwords do not match');
                        return;
                    }
                    // Add your API call here
                    sNotification('Password updated successfully');
                });
        
                document.getElementById('billingForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    // Add your API call here
                    sNotification('Billing information updated successfully');
                });
        
                const saveNotifications = () => {
                    // Add your API call here
                    sNotification('Notification preferences saved');
                };
        
                // Initial form population (simulate fetching user data)
                const populateUserData = () => {
                    // Simulate API call to get user data
                    const userData = {
                        firstName: 'John',
                        lastName: 'Doe',
                        email: 'john@example.com',
                        sendingName: 'John Doe (Company)'
                    };
        
                    const profileForm = document.getElementById('profileForm');
                    Object.keys(userData).forEach(key => {
                        const input = profileForm.querySelector(`[name="${key}"]`);
                        if (input) input.value = userData[key];
                    });
                };
        
                // Call on page load
                populateUserData();

        //         const MAILBOXES = [
        //     { id: 'work', name: 'Work Email', email: 'john.doe@company.com' },
        //     { id: 'personal', name: 'Personal Email', email: 'john.doe@gmail.com' },
        //     { id: 'project', name: 'Project Email', email: 'john.projectmanager@company.com' }
        // ];

        // Modal Management Utility
        class ModalManager {
            static openModal(modalId) {
                document.getElementById(modalId).style.display = 'flex';
            }

            static closeModal(modalId) {
                document.getElementById(modalId).style.display = 'none';
            }
        }

        // // Single Email Modal Logic
        // function initSingleEmailModal() {
        //     const singleMailboxSelect = document.getElementById('singleMailbox');
        //     const singleEmailSendBtn = document.getElementById('singleEmailSend');
        //     const singleEmailCancelBtn = document.getElementById('singleEmailCancel');

        //     // Populate mailbox options
        //     MAILBOXES.forEach(mailbox => {
        //         const option = document.createElement('option');
        //         option.value = mailbox.id;
        //         option.textContent = `${mailbox.name} (${mailbox.email})`;
        //         singleMailboxSelect.appendChild(option);
        //     });

        //     // Enable/Disable send button based on selection
        //     singleMailboxSelect.addEventListener('change', (e) => {
        //         singleEmailSendBtn.disabled = !e.target.value;
        //     });

        //     // Open modal
        //     function singleEmailModal(){
        //         ModalManager.openModal('singleEmailModal');
        //     };

        //     // Close modal
        //     singleEmailCancelBtn.addEventListener('click', () => {
        //         ModalManager.closeModal('singleEmailModal');
        //     });

        //     // Send email
        //     singleEmailSendBtn.addEventListener('click', () => {
        //         const selectedMailbox = singleMailboxSelect.value;
        //         console.log(`Sending email from: ${selectedMailbox}`);
        //         // Add your email sending logic here
        //         ModalManager.closeModal('singleEmailModal');
        //     });
        // }

        // Function to open the modal and get the selected mailbox
async function selectMailboxForEmail() {
    emails = await fetchActiveMailbox(U_MyEmail)
    console.log(emails)

    if (emails.length === 1) {
        console.log(`Automatically selected single mailbox: ${emails[0]}`);
        return emails[0]; // Return the only mailbox
    }


    return new Promise((resolve, reject) => {
        const singleMailboxSelect = document.getElementById('singleMailbox');
        const singleEmailSendBtn = document.getElementById('singleEmailSend');
        const singleEmailCancelBtn = document.getElementById('singleEmailCancel');

        // Clear previous options
        singleMailboxSelect.innerHTML = '';

        // Populate mailbox options dynamically
        emails.forEach(mailbox => {
            const option = document.createElement('option');
            option.value = mailbox;
            option.textContent = `${mailbox}`;
            singleMailboxSelect.appendChild(option);
        });

        // Enable/Disable send button based on selection
        singleMailboxSelect.addEventListener('change', (e) => {
            singleEmailSendBtn.disabled = !e.target.value;
        });

        // Handle "Send Email" button click
        singleEmailSendBtn.addEventListener('click', () => {
            const selectedMailbox = singleMailboxSelect.value;

            if (selectedMailbox) {
                console.log(`Selected Mailbox: ${selectedMailbox}`);
                ModalManager.closeModal('singleEmailModal');
                resolve(selectedMailbox); // Resolve the selected mailbox
            } else {
                reject('No mailbox selected.');
            }
        });

        // Handle "Cancel" button click
        singleEmailCancelBtn.addEventListener('click', () => {
            ModalManager.closeModal('singleEmailModal');
            reject('User cancelled selection.');
        });

        // Open the modal
        ModalManager.openModal('singleEmailModal');
    });
}



      
                // Initialize the emails dashboard
                const fetchuserEmails = async () => {
    try {
        console.log("fetching meailboxes")
        const response = await fetch(`https://server.voltmailer.com/api/emails?email=${U_MyEmail}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            }
        });

        const emailsfound = await response.json();
        if (response.ok) {
            console.log("found them", emailsfound)
            sampleEmails = emailsfound
            console.log(sampleEmails)
            const sentEmailsContainer = document.getElementById('sentEmailsContainer');
            const sentEmailsManager = new SentEmailsManager(sentEmailsContainer, sampleEmails);
            window.sentEmailsManager = sentEmailsManager;
            window.toggleEmailDetails = (emailId) => sentEmailsManager.toggleEmailDetails(emailId);

        } else {
            throw new Error(mailboxesFromBackend.message || 'Failed to fetch mailboxes');
        }
    } catch (error) {
        console.error('Error fetching mailboxes:', error);
        sNotification('Error fetching mailboxes: ' + error.message, 'error');
    }
};


const modalmail = document.getElementById('mailbox-mailbox-modal');
        const closeBtnmail = document.getElementById('close-modal');
        const gmailOption = document.getElementById('gmail-option');
        const manualOption = document.getElementById('manual-option');

        // Close modal functionality
        closeBtnmail.addEventListener('click', () => {
           closemailmod()
        });

        function openModalmail(){
            modalmail.style.display = 'block';
        }

        // Placeholder click handlers (to be replaced with your specific logic)
        gmailOption.addEventListener('click', () => {
            // Your Gmail connection logic here
            initiateGoogleOAuth()
            console.log('Gmail option clicked');
        });

        function closemailmod(){
modalmail.style.display = 'none';
        
        }

        manualOption.addEventListener('click', () => {
            // Your manual entry logic here
            closemailmod()
            showAddMailboxModal()
            console.log('Manual entry option clicked');
        });


        // Global functions to interface with the class methods
        // const sentEmailsContainer = document.getElementById('sentEmailsContainer');
        

// class MultiEmailDistributor {
//             constructor() {
//                 // Use an array to store mailboxes instead of localStorage
//                 this.mailboxes = [
//                     { name: 'Default Work', email: 'work@example.com', limit: 100 },
//                     { name: 'Personal Email', email: 'personal@example.com', limit: 50 }
//                 ];
//                 this.initializeDOM();
//                 this.bindEvents();
//                 this.renderMailboxes();
//             }

//             initializeDOM() {
//                 this.modal = document.getElementById('multiEmailModal');
//                 this.addMailboxModal = document.getElementById('addMailboxModal');
//                 this.distributionContainer = document.getElementById('emailDistributionContainer');
//                 this.totalEmailsIndicator = document.getElementById('totalEmailsIndicator');
//                 this.sendButton = document.getElementById('multiEmailSend');
//                 this.cancelButton = document.getElementById('multiEmailCancel');
//                 this.addMailboxButton = document.getElementById('addMailboxBtn');

//                 // Add Mailbox Modal Elements
//                 this.mailboxNameInput = document.getElementById('mailboxNameInput');
//                 this.mailboxEmailInput = document.getElementById('mailboxEmailInput');
//                 this.mailboxLimitInput = document.getElementById('mailboxLimitInput');
//                 this.cancelAddMailboxButton = document.getElementById('cancelAddMailbox');
//                 this.confirmAddMailboxButton = document.getElementById('confirmAddMailbox');
//             }

//             openModal() {
//         this.modal.classList.add('show');
//     }

//     closeModal() {
//         this.modal.classList.remove('show');
//     }

//             renderMailboxes() {
//                 this.distributionContainer.innerHTML = '';

//                 this.mailboxes.forEach((mailbox, index) => {
//                     const distributionEl = document.createElement('div');
//                     distributionEl.classList.add('mailbox-distribution');

//                     distributionEl.innerHTML = `
//                         <div class="mailbox-header">
//                             <div class="name">${mailbox.name}</div>
//                             <div class="mailbox-remove" data-index="${index}">✖</div>
//                         </div>
//                         <div class="mailbox-info">
//                             <div class="email">${mailbox.email}</div>
//                             <div class="limit">Sending Limit: ${mailbox.limit} emails</div>
//                         </div>
//                         <input 
//                             type="number" 
//                             min="0" 
//                             max="${mailbox.limit}" 
//                             data-mailbox-index="${index}" 
//                             class="email-input" 
//                             placeholder="# of Emails"
//                         >
//                     `;

//                     const input = distributionEl.querySelector('.email-input');
//                     input.addEventListener('input', () => this.updateTotalEmails());

//                     const removeButton = distributionEl.querySelector('.mailbox-remove');
//                     removeButton.addEventListener('click', () => this.removeMailbox(index));

//                     this.distributionContainer.appendChild(distributionEl);
//                 });

//                 this.updateTotalEmails();
//             }

//             updateTotalEmails() {
//                 const inputs = this.distributionContainer.querySelectorAll('.email-input');
//                 const total = Array.from(inputs).reduce((sum, input) => 
//                     sum + (parseInt(input.value) || 0), 0
//                 );

//                 this.totalEmailsIndicator.textContent = `${total} Emails`;
//                 this.sendButton.disabled = total === 0;

//                 // Validate individual mailbox limits
//                 inputs.forEach(input => {
//                     const index = input.dataset.mailboxIndex;
//                     const mailbox = this.mailboxes[index];
//                     const value = parseInt(input.value) || 0;

//                     if (value > mailbox.limit) {
//                         input.value = mailbox.limit;
//                         this.updateTotalEmails();
//                     }
//                 });
//             }

//             removeMailbox(index) {
//                 // Prevent removing the last mailbox
//                 if (this.mailboxes.length > 1) {
//                     this.mailboxes.splice(index, 1);
//                     this.renderMailboxes();
//                 } else {
//                     alert('You must have at least one mailbox');
//                 }
//             }

//             bindEvents() {
//                 document.getElementById('multiEmailBtn').addEventListener('click', () => {
//                     this.modal.classList.add('show');
//                 });

//                 this.cancelButton.addEventListener('click', () => {
//                     this.modal.classList.remove('show');
//                 });

//                 this.sendButton.addEventListener('click', () => {
//                     const distribution = Array.from(
//                         this.distributionContainer.querySelectorAll('.email-input')
//                     ).map((input, index) => ({
//                         mailboxId: this.mailboxes[index].email,
//                         emails: parseInt(input.value) || 0
//                     }));

//                     console.log('Email Distribution:', distribution);
//                     this.modal.classList.remove('show');
//                 });

//                 // Add Mailbox Modal Events
//                 this.addMailboxButton.addEventListener('click', () => {
//                     this.addMailboxModal.classList.add('show');
//                 });

//                 this.cancelAddMailboxButton.addEventListener('click', () => {
//                     this.addMailboxModal.classList.remove('show');
//                 });

//                 this.confirmAddMailboxButton.addEventListener('click', () => {
//                     const name = this.mailboxNameInput.value.trim();
//                     const email = this.mailboxEmailInput.value.trim();
//                     const limit = parseInt(this.mailboxLimitInput.value);

//                     // Basic email validation
//                     const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
//                     if (name && email && emailRegex.test(email) && limit > 0) {
//                         this.mailboxes.push({ name, email, limit });
//                         this.renderMailboxes();
//                         this.addMailboxModal.classList.remove('show');

//                         // Reset inputs
//                         this.mailboxNameInput.value = '';
//                         this.mailboxEmailInput.value = '';
//                         this.mailboxLimitInput.value = '';
//                     } else {
//                         alert('Please fill in all fields correctly. Ensure a valid email and positive limit.');
//                     }
//                 });
//             }
//             getEmailDistribution() {
//         return Array.from(this.distributionContainer.querySelectorAll('.email-input')).map((input, index) => ({
//             email: this.mailboxes[index].email,
//             numEmails: parseInt(input.value) || 0
//         }));
//     }
//         }

        // Initialize on page load
        // document.addEventListener('DOMContentLoaded', () => {
        //     new MultiEmailDistributor();
        // });

    //     document.addEventListener('DOMContentLoaded', setupFileInputs);

    //     document.addEventListener('DOMContentLoaded', () => {
    //         // initSingleEmailModal();
    //         // initMultipleEmailModal();
    //         const fileInput = document.getElementById('fileInput');
    // if (fileInput) {
    //     fileInput.addEventListener('change', handleFile, false);
    // }

    // // Setup for middle file input
    // const fileMIDDLE = document.getElementById('fileMIDDLE');
    // if (fileMIDDLE) {
    //     fileMIDDLE.addEventListener('change', handleFile, false);
    // }

    // // Optional: Setup for upload label click (if needed)
    // const uploadLabel = document.getElementById('uploadLabel');

    // if (uploadLabel) {
    //     uploadLabel.addEventListener('click', function() {
    //         // Trigger click on hidden file input
    //         fileInput.click();
    //     });
    // }
    //     });

            </script>


</body>
</html>
